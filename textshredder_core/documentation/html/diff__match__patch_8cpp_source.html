<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Textshredder core: libraries/diff_match_patch/diff_match_patch.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Textshredder core&#160;<span id="projectnumber">1.0</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">libraries/diff_match_patch/diff_match_patch.cpp</div>  </div>
</div>
<div class="contents">
<a href="diff__match__patch_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright 2008 Google Inc. All Rights Reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> * Author: fraser@google.com (Neil Fraser)</span>
<a name="l00004"></a>00004 <span class="comment"> * Author: mikeslemmer@gmail.com (Mike Slemmer)</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00007"></a>00007 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l00008"></a>00008 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00013"></a>00013 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00014"></a>00014 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00015"></a>00015 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l00016"></a>00016 <span class="comment"> * limitations under the License.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * Diff Match and Patch</span>
<a name="l00019"></a>00019 <span class="comment"> * http://code.google.com/p/google-diff-match-patch/</span>
<a name="l00020"></a>00020 <span class="comment"> */</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="comment">// Code known to compile and run with Qt 4.3 through Qt 4.7.</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;QtCore&gt;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="diff__match__patch_8h.html">diff_match_patch.h</a>&quot;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 
<a name="l00031"></a>00031 <span class="comment">//</span>
<a name="l00032"></a>00032 <span class="comment">// Diff Class</span>
<a name="l00033"></a>00033 <span class="comment">//</span>
<a name="l00035"></a>00035 <span class="comment"></span>
<a name="l00036"></a>00036 
<a name="l00042"></a><a class="code" href="class_diff.html#a8fafc882c451d2b3768b0637aa0fe6b6">00042</a> <a class="code" href="class_diff.html#a6c572ea9bb134f23a593f56e0c92bae8">Diff::Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bb">Operation</a> _operation, <span class="keyword">const</span> QString &amp;_text) :
<a name="l00043"></a>00043   operation(_operation), text(_text) {
<a name="l00044"></a>00044   <span class="comment">// Construct a diff with the specified operation and text.</span>
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="class_diff.html#a6c572ea9bb134f23a593f56e0c92bae8">00047</a> <a class="code" href="class_diff.html#a6c572ea9bb134f23a593f56e0c92bae8">Diff::Diff</a>() {
<a name="l00048"></a>00048 }
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="class_diff.html#a922600ec44c726ba32675b33e0c52ac6">00051</a> QString <a class="code" href="class_diff.html#a922600ec44c726ba32675b33e0c52ac6">Diff::strOperation</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bb">Operation</a> op) {
<a name="l00052"></a>00052   <span class="keywordflow">switch</span> (op) {
<a name="l00053"></a>00053     <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>:
<a name="l00054"></a>00054       <span class="keywordflow">return</span> <span class="stringliteral">&quot;INSERT&quot;</span>;
<a name="l00055"></a>00055     <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>:
<a name="l00056"></a>00056       <span class="keywordflow">return</span> <span class="stringliteral">&quot;DELETE&quot;</span>;
<a name="l00057"></a>00057     <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>:
<a name="l00058"></a>00058       <span class="keywordflow">return</span> <span class="stringliteral">&quot;EQUAL&quot;</span>;
<a name="l00059"></a>00059   }
<a name="l00060"></a>00060   <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Invalid operation.&quot;</span>;
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 
<a name="l00067"></a><a class="code" href="class_diff.html#ad2d625057737fb1304a7811d6184ef8b">00067</a> QString <a class="code" href="class_diff.html#ad2d625057737fb1304a7811d6184ef8b">Diff::toString</a>()<span class="keyword"> const </span>{
<a name="l00068"></a>00068   QString prettyText = <a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l00069"></a>00069   <span class="comment">// Replace linebreaks with Pilcrow signs.</span>
<a name="l00070"></a>00070   prettyText.replace(<span class="charliteral">&#39;\n&#39;</span>, L<span class="stringliteral">&#39;\u00b6&#39;</span>);
<a name="l00071"></a>00071   <span class="keywordflow">return</span> QString(<span class="stringliteral">&quot;Diff(&quot;</span>) + <a class="code" href="class_diff.html#a922600ec44c726ba32675b33e0c52ac6">strOperation</a>(<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a>) + QString(<span class="stringliteral">&quot;,\&quot;&quot;</span>)
<a name="l00072"></a>00072       + prettyText + QString(<span class="stringliteral">&quot;\&quot;)&quot;</span>);
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00080"></a><a class="code" href="class_diff.html#ae3bb825450a577a92813370db37aa973">00080</a> <span class="keywordtype">bool</span> <a class="code" href="class_diff.html#ae3bb825450a577a92813370db37aa973">Diff::operator==</a>(<span class="keyword">const</span> <a class="code" href="class_diff.html">Diff</a> &amp;d)<span class="keyword"> const </span>{
<a name="l00081"></a>00081   <span class="keywordflow">return</span> (d.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == this-&gt;operation) &amp;&amp; (d.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> == this-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>);
<a name="l00082"></a>00082 }
<a name="l00083"></a>00083 
<a name="l00084"></a><a class="code" href="class_diff.html#ae527433d87f2a87c63ab2fec50a00a8e">00084</a> <span class="keywordtype">bool</span> <a class="code" href="class_diff.html#ae527433d87f2a87c63ab2fec50a00a8e">Diff::operator!=</a>(<span class="keyword">const</span> <a class="code" href="class_diff.html">Diff</a> &amp;d)<span class="keyword"> const </span>{
<a name="l00085"></a>00085   <span class="keywordflow">return</span> !(<a class="code" href="class_diff.html#ae3bb825450a577a92813370db37aa973">operator == </a>(d));
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 
<a name="l00090"></a>00090 <span class="comment">//</span>
<a name="l00091"></a>00091 <span class="comment">// Patch Class</span>
<a name="l00092"></a>00092 <span class="comment">//</span>
<a name="l00094"></a>00094 <span class="comment"></span>
<a name="l00095"></a>00095 
<a name="l00099"></a><a class="code" href="class_patch.html#a65fdd4bb128b8f50c1b9dcc008f20360">00099</a> <a class="code" href="class_patch.html#a65fdd4bb128b8f50c1b9dcc008f20360">Patch::Patch</a>() :
<a name="l00100"></a>00100   start1(0), start2(0),
<a name="l00101"></a>00101   length1(0), length2(0) {
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="class_patch.html#afdc9aba846465494845201a26d0fc20f">00104</a> <span class="keywordtype">bool</span> <a class="code" href="class_patch.html#afdc9aba846465494845201a26d0fc20f">Patch::isNull</a>()<span class="keyword"> const </span>{
<a name="l00105"></a>00105   <span class="keywordflow">if</span> (<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> == 0 &amp;&amp; <a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> == 0 &amp;&amp; <a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> == 0 &amp;&amp; <a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> == 0
<a name="l00106"></a>00106       &amp;&amp; <a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.size() == 0) {
<a name="l00107"></a>00107     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00108"></a>00108   }
<a name="l00109"></a>00109   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00110"></a>00110 }
<a name="l00111"></a>00111 
<a name="l00112"></a><a class="code" href="class_patch.html#a2159b94942e91391e8d4e29d06735286">00112</a> <span class="keywordtype">bool</span> <a class="code" href="class_patch.html#a2159b94942e91391e8d4e29d06735286">Patch::operator == </a>(<span class="keyword">const</span> <a class="code" href="class_patch.html">Patch</a> &amp;otherPatch) {
<a name="l00113"></a>00113         QString thisStringRepresentation = this-&gt;<a class="code" href="class_patch.html#a53799d5296a89879d88f76c8f10602e7">toString</a>();
<a name="l00114"></a>00114         QString otherStringRepresentation = ((<a class="code" href="class_patch.html">Patch</a> &amp;)otherPatch).toString();
<a name="l00115"></a>00115         <span class="keywordflow">return</span> (otherStringRepresentation == thisStringRepresentation);
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 
<a name="l00124"></a><a class="code" href="class_patch.html#a53799d5296a89879d88f76c8f10602e7">00124</a> QString <a class="code" href="class_patch.html#a53799d5296a89879d88f76c8f10602e7">Patch::toString</a>() {
<a name="l00125"></a>00125   QString coords1, coords2;
<a name="l00126"></a>00126   <span class="keywordflow">if</span> (<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> == 0) {
<a name="l00127"></a>00127     coords1 = QString::number(<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a>) + QString(<span class="stringliteral">&quot;,0&quot;</span>);
<a name="l00128"></a>00128   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> == 1) {
<a name="l00129"></a>00129     coords1 = QString::number(<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> + 1);
<a name="l00130"></a>00130   } <span class="keywordflow">else</span> {
<a name="l00131"></a>00131     coords1 = QString::number(<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> + 1) + QString(<span class="stringliteral">&quot;,&quot;</span>)
<a name="l00132"></a>00132         + QString::number(<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a>);
<a name="l00133"></a>00133   }
<a name="l00134"></a>00134   <span class="keywordflow">if</span> (<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> == 0) {
<a name="l00135"></a>00135     coords2 = QString::number(<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a>) + QString(<span class="stringliteral">&quot;,0&quot;</span>);
<a name="l00136"></a>00136   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> == 1) {
<a name="l00137"></a>00137     coords2 = QString::number(<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> + 1);
<a name="l00138"></a>00138   } <span class="keywordflow">else</span> {
<a name="l00139"></a>00139     coords2 = QString::number(<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> + 1) + QString(<span class="stringliteral">&quot;,&quot;</span>)
<a name="l00140"></a>00140         + QString::number(<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a>);
<a name="l00141"></a>00141   }
<a name="l00142"></a>00142   QString text;
<a name="l00143"></a>00143   text = QString(<span class="stringliteral">&quot;@@ -&quot;</span>) + coords1 + QString(<span class="stringliteral">&quot; +&quot;</span>) + coords2
<a name="l00144"></a>00144       + QString(<span class="stringliteral">&quot; @@\n&quot;</span>);
<a name="l00145"></a>00145   <span class="comment">// Escape the body of the patch with %xx notation.</span>
<a name="l00146"></a>00146   <span class="keywordflow">foreach</span> (<a class="code" href="class_diff.html">Diff</a> aDiff, <a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>) {
<a name="l00147"></a>00147     <span class="keywordflow">switch</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a>) {
<a name="l00148"></a>00148       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>:
<a name="l00149"></a>00149         text += QString(<span class="charliteral">&#39;+&#39;</span>);
<a name="l00150"></a>00150         <span class="keywordflow">break</span>;
<a name="l00151"></a>00151       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>:
<a name="l00152"></a>00152         text += QString(<span class="charliteral">&#39;-&#39;</span>);
<a name="l00153"></a>00153         <span class="keywordflow">break</span>;
<a name="l00154"></a>00154       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>:
<a name="l00155"></a>00155         text += QString(<span class="charliteral">&#39; &#39;</span>);
<a name="l00156"></a>00156         <span class="keywordflow">break</span>;
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158     text += QString(QUrl::toPercentEncoding(aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>, <span class="stringliteral">&quot; !~*&#39;();/?:@&amp;=+$,#&quot;</span>))
<a name="l00159"></a>00159         + QString(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00160"></a>00160   }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162   <span class="keywordflow">return</span> text;
<a name="l00163"></a>00163 }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 
<a name="l00167"></a>00167 <span class="comment">//</span>
<a name="l00168"></a>00168 <span class="comment">// diff_match_patch Class</span>
<a name="l00169"></a>00169 <span class="comment">//</span>
<a name="l00171"></a>00171 <span class="comment"></span>
<a name="l00172"></a><a class="code" href="classdiff__match__patch.html#a0c839cb3f22ff25e4d89f09554a2dd2c">00172</a> <a class="code" href="classdiff__match__patch.html#a0c839cb3f22ff25e4d89f09554a2dd2c">diff_match_patch::diff_match_patch</a>() :
<a name="l00173"></a>00173   Diff_Timeout(1.0f),
<a name="l00174"></a>00174   Diff_EditCost(4),
<a name="l00175"></a>00175   Match_Threshold(0.5f),
<a name="l00176"></a>00176   Match_Distance(1000),
<a name="l00177"></a>00177   Patch_DeleteThreshold(0.5f),
<a name="l00178"></a>00178   Patch_Margin(4),
<a name="l00179"></a>00179   Match_MaxBits(32) {
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">00183</a> QList&lt;Diff&gt; <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_match_patch::diff_main</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l00184"></a>00184                                         <span class="keyword">const</span> QString &amp;text2) {
<a name="l00185"></a>00185   <span class="keywordflow">return</span> <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_main</a>(text1, text2, <span class="keyword">true</span>);
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a><a class="code" href="classdiff__match__patch.html#a106a1cb355978e1d2c60fb6487667fe3">00188</a> QList&lt;Diff&gt; <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_match_patch::diff_main</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l00189"></a>00189     <span class="keyword">const</span> QString &amp;text2, <span class="keywordtype">bool</span> checklines) {
<a name="l00190"></a>00190   <span class="comment">// Set a deadline by which time the diff must be complete.</span>
<a name="l00191"></a>00191   clock_t deadline;
<a name="l00192"></a>00192   <span class="keywordflow">if</span> (<a class="code" href="classdiff__match__patch.html#aaa544a91d8555a780ab261fc1c15b3f9">Diff_Timeout</a> &lt;= 0) {
<a name="l00193"></a>00193     deadline = std::numeric_limits&lt;clock_t&gt;::max();
<a name="l00194"></a>00194   } <span class="keywordflow">else</span> {
<a name="l00195"></a>00195     deadline = clock() + (clock_t)(<a class="code" href="classdiff__match__patch.html#aaa544a91d8555a780ab261fc1c15b3f9">Diff_Timeout</a> * CLOCKS_PER_SEC);
<a name="l00196"></a>00196   }
<a name="l00197"></a>00197   <span class="keywordflow">return</span> <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_main</a>(text1, text2, checklines, deadline);
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 QList&lt;Diff&gt; <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_match_patch::diff_main</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l00201"></a>00201     <span class="keyword">const</span> QString &amp;text2, <span class="keywordtype">bool</span> checklines, clock_t deadline) {
<a name="l00202"></a>00202   <span class="comment">// Check for null inputs.</span>
<a name="l00203"></a>00203   <span class="keywordflow">if</span> (text1.isNull() || text2.isNull()) {
<a name="l00204"></a>00204     <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Null inputs. (diff_main)&quot;</span>;
<a name="l00205"></a>00205   }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="comment">// Check for equality (speedup).</span>
<a name="l00208"></a>00208   QList&lt;Diff&gt; diffs;
<a name="l00209"></a>00209   <span class="keywordflow">if</span> (text1 == text2) {
<a name="l00210"></a>00210     <span class="keywordflow">if</span> (!text1.isEmpty()) {
<a name="l00211"></a>00211       diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, text1));
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213     <span class="keywordflow">return</span> diffs;
<a name="l00214"></a>00214   }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216   <span class="comment">// Trim off common prefix (speedup).</span>
<a name="l00217"></a>00217   <span class="keywordtype">int</span> commonlength = <a class="code" href="classdiff__match__patch.html#a6139ad292f602b8b9295fe0c48709e31">diff_commonPrefix</a>(text1, text2);
<a name="l00218"></a>00218   <span class="keyword">const</span> QString &amp;commonprefix = text1.left(commonlength);
<a name="l00219"></a>00219   QString textChopped1 = text1.mid(commonlength);
<a name="l00220"></a>00220   QString textChopped2 = text2.mid(commonlength);
<a name="l00221"></a>00221 
<a name="l00222"></a>00222   <span class="comment">// Trim off common suffix (speedup).</span>
<a name="l00223"></a>00223   commonlength = <a class="code" href="classdiff__match__patch.html#aed765d65d9e6fb78de3725416a262586">diff_commonSuffix</a>(textChopped1, textChopped2);
<a name="l00224"></a>00224   <span class="keyword">const</span> QString &amp;commonsuffix = textChopped1.right(commonlength);
<a name="l00225"></a>00225   textChopped1 = textChopped1.left(textChopped1.length() - commonlength);
<a name="l00226"></a>00226   textChopped2 = textChopped2.left(textChopped2.length() - commonlength);
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <span class="comment">// Compute the diff on the middle block.</span>
<a name="l00229"></a>00229   diffs = diff_compute(textChopped1, textChopped2, checklines, deadline);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231   <span class="comment">// Restore the prefix and suffix.</span>
<a name="l00232"></a>00232   <span class="keywordflow">if</span> (!commonprefix.isEmpty()) {
<a name="l00233"></a>00233     diffs.prepend(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, commonprefix));
<a name="l00234"></a>00234   }
<a name="l00235"></a>00235   <span class="keywordflow">if</span> (!commonsuffix.isEmpty()) {
<a name="l00236"></a>00236     diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, commonsuffix));
<a name="l00237"></a>00237   }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239   <a class="code" href="classdiff__match__patch.html#ad64d391bc3f34cad326f869eedb748f9">diff_cleanupMerge</a>(diffs);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241   <span class="keywordflow">return</span> diffs;
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 QList&lt;Diff&gt; diff_match_patch::diff_compute(QString text1, QString text2,
<a name="l00246"></a>00246     <span class="keywordtype">bool</span> checklines, clock_t deadline) {
<a name="l00247"></a>00247   QList&lt;Diff&gt; diffs;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   <span class="keywordflow">if</span> (text1.isEmpty()) {
<a name="l00250"></a>00250     <span class="comment">// Just add some text (speedup).</span>
<a name="l00251"></a>00251     diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>, text2));
<a name="l00252"></a>00252     <span class="keywordflow">return</span> diffs;
<a name="l00253"></a>00253   }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   <span class="keywordflow">if</span> (text2.isEmpty()) {
<a name="l00256"></a>00256     <span class="comment">// Just delete some text (speedup).</span>
<a name="l00257"></a>00257     diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>, text1));
<a name="l00258"></a>00258     <span class="keywordflow">return</span> diffs;
<a name="l00259"></a>00259   }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261   {
<a name="l00262"></a>00262     <span class="keyword">const</span> QString longtext = text1.length() &gt; text2.length() ? text1 : text2;
<a name="l00263"></a>00263     <span class="keyword">const</span> QString shorttext = text1.length() &gt; text2.length() ? text2 : text1;
<a name="l00264"></a>00264     <span class="keyword">const</span> <span class="keywordtype">int</span> i = longtext.indexOf(shorttext);
<a name="l00265"></a>00265     <span class="keywordflow">if</span> (i != -1) {
<a name="l00266"></a>00266       <span class="comment">// Shorter text is inside the longer text (speedup).</span>
<a name="l00267"></a>00267       <span class="keyword">const</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bb">Operation</a> op = (text1.length() &gt; text2.length()) ? <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a> : <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>;
<a name="l00268"></a>00268       diffs.append(<a class="code" href="class_diff.html">Diff</a>(op, longtext.left(i)));
<a name="l00269"></a>00269       diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, shorttext));
<a name="l00270"></a>00270       diffs.append(<a class="code" href="class_diff.html">Diff</a>(op, safeMid(longtext, i + shorttext.length())));
<a name="l00271"></a>00271       <span class="keywordflow">return</span> diffs;
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keywordflow">if</span> (shorttext.length() == 1) {
<a name="l00275"></a>00275       <span class="comment">// Single character string.</span>
<a name="l00276"></a>00276       <span class="comment">// After the previous speedup, the character can&#39;t be an equality.</span>
<a name="l00277"></a>00277       diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>, text1));
<a name="l00278"></a>00278       diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>, text2));
<a name="l00279"></a>00279       <span class="keywordflow">return</span> diffs;
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281     <span class="comment">// Garbage collect longtext and shorttext by scoping out.</span>
<a name="l00282"></a>00282   }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   <span class="comment">// Check to see if the problem can be split in two.</span>
<a name="l00285"></a>00285   <span class="keyword">const</span> QStringList hm = <a class="code" href="classdiff__match__patch.html#a34e2eabd2503e28eebe97a05dc3783dc">diff_halfMatch</a>(text1, text2);
<a name="l00286"></a>00286   <span class="keywordflow">if</span> (hm.count() &gt; 0) {
<a name="l00287"></a>00287     <span class="comment">// A half-match was found, sort out the return data.</span>
<a name="l00288"></a>00288     <span class="keyword">const</span> QString text1_a = hm[0];
<a name="l00289"></a>00289     <span class="keyword">const</span> QString text1_b = hm[1];
<a name="l00290"></a>00290     <span class="keyword">const</span> QString text2_a = hm[2];
<a name="l00291"></a>00291     <span class="keyword">const</span> QString text2_b = hm[3];
<a name="l00292"></a>00292     <span class="keyword">const</span> QString mid_common = hm[4];
<a name="l00293"></a>00293     <span class="comment">// Send both pairs off for separate processing.</span>
<a name="l00294"></a>00294     <span class="keyword">const</span> QList&lt;Diff&gt; diffs_a = <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_main</a>(text1_a, text2_a,
<a name="l00295"></a>00295                                           checklines, deadline);
<a name="l00296"></a>00296     <span class="keyword">const</span> QList&lt;Diff&gt; diffs_b = <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_main</a>(text1_b, text2_b,
<a name="l00297"></a>00297                                           checklines, deadline);
<a name="l00298"></a>00298     <span class="comment">// Merge the results.</span>
<a name="l00299"></a>00299     diffs = diffs_a;
<a name="l00300"></a>00300     diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, mid_common));
<a name="l00301"></a>00301     diffs += diffs_b;
<a name="l00302"></a>00302     <span class="keywordflow">return</span> diffs;
<a name="l00303"></a>00303   }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="comment">// Perform a real diff.</span>
<a name="l00306"></a>00306   <span class="keywordflow">if</span> (checklines &amp;&amp; text1.length() &gt; 100 &amp;&amp; text2.length() &gt; 100) {
<a name="l00307"></a>00307     <span class="keywordflow">return</span> diff_lineMode(text1, text2, deadline);
<a name="l00308"></a>00308   }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   <span class="keywordflow">return</span> <a class="code" href="classdiff__match__patch.html#a10f6b81afc589a091a74d00d58ec1a5a">diff_bisect</a>(text1, text2, deadline);
<a name="l00311"></a>00311 }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 QList&lt;Diff&gt; diff_match_patch::diff_lineMode(QString text1, QString text2,
<a name="l00315"></a>00315     clock_t deadline) {
<a name="l00316"></a>00316   <span class="comment">// Scan the text on a line-by-line basis first.</span>
<a name="l00317"></a>00317   <span class="keyword">const</span> QList&lt;QVariant&gt; b = <a class="code" href="classdiff__match__patch.html#ab1f120b83d49948767de531ab2a4e15a">diff_linesToChars</a>(text1, text2);
<a name="l00318"></a>00318   text1 = b[0].toString();
<a name="l00319"></a>00319   text2 = b[1].toString();
<a name="l00320"></a>00320   QStringList linearray = b[2].toStringList();
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   QList&lt;Diff&gt; diffs = <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_main</a>(text1, text2, <span class="keyword">false</span>, deadline);
<a name="l00323"></a>00323 
<a name="l00324"></a>00324   <span class="comment">// Convert the diff back to original text.</span>
<a name="l00325"></a>00325   diff_charsToLines(diffs, linearray);
<a name="l00326"></a>00326   <span class="comment">// Eliminate freak matches (e.g. blank lines)</span>
<a name="l00327"></a>00327   <a class="code" href="classdiff__match__patch.html#a1150e91652b023e8893555f737ac9894">diff_cleanupSemantic</a>(diffs);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329   <span class="comment">// Rediff any replacement blocks, this time character-by-character.</span>
<a name="l00330"></a>00330   <span class="comment">// Add a dummy entry at the end.</span>
<a name="l00331"></a>00331   diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l00332"></a>00332   <span class="keywordtype">int</span> count_delete = 0;
<a name="l00333"></a>00333   <span class="keywordtype">int</span> count_insert = 0;
<a name="l00334"></a>00334   QString text_delete = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00335"></a>00335   QString text_insert = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337   QMutableListIterator&lt;Diff&gt; pointer(diffs);
<a name="l00338"></a>00338   <a class="code" href="class_diff.html">Diff</a> *thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00339"></a>00339   <span class="keywordflow">while</span> (thisDiff != NULL) {
<a name="l00340"></a>00340     <span class="keywordflow">switch</span> (thisDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a>) {
<a name="l00341"></a>00341       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>:
<a name="l00342"></a>00342         count_insert++;
<a name="l00343"></a>00343         text_insert += thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l00344"></a>00344         <span class="keywordflow">break</span>;
<a name="l00345"></a>00345       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>:
<a name="l00346"></a>00346         count_delete++;
<a name="l00347"></a>00347         text_delete += thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l00348"></a>00348         <span class="keywordflow">break</span>;
<a name="l00349"></a>00349       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>:
<a name="l00350"></a>00350         <span class="comment">// Upon reaching an equality, check for prior redundancies.</span>
<a name="l00351"></a>00351         <span class="keywordflow">if</span> (count_delete &gt;= 1 &amp;&amp; count_insert &gt;= 1) {
<a name="l00352"></a>00352           <span class="comment">// Delete the offending records and add the merged ones.</span>
<a name="l00353"></a>00353           pointer.previous();
<a name="l00354"></a>00354           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; count_delete + count_insert; j++) {
<a name="l00355"></a>00355             pointer.previous();
<a name="l00356"></a>00356             pointer.remove();
<a name="l00357"></a>00357           }
<a name="l00358"></a>00358           <span class="keywordflow">foreach</span>(<a class="code" href="class_diff.html">Diff</a> newDiff,
<a name="l00359"></a>00359               <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_main</a>(text_delete, text_insert, <span class="keyword">false</span>, deadline)) {
<a name="l00360"></a>00360             pointer.insert(newDiff);
<a name="l00361"></a>00361           }
<a name="l00362"></a>00362         }
<a name="l00363"></a>00363         count_insert = 0;
<a name="l00364"></a>00364         count_delete = 0;
<a name="l00365"></a>00365         text_delete = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00366"></a>00366         text_insert = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00367"></a>00367         <span class="keywordflow">break</span>;
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369     thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00370"></a>00370   }
<a name="l00371"></a>00371   diffs.removeLast();  <span class="comment">// Remove the dummy entry at the end.</span>
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <span class="keywordflow">return</span> diffs;
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 
<a name="l00377"></a><a class="code" href="classdiff__match__patch.html#a10f6b81afc589a091a74d00d58ec1a5a">00377</a> QList&lt;Diff&gt; <a class="code" href="classdiff__match__patch.html#a10f6b81afc589a091a74d00d58ec1a5a">diff_match_patch::diff_bisect</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l00378"></a>00378     <span class="keyword">const</span> QString &amp;text2, clock_t deadline) {
<a name="l00379"></a>00379   <span class="comment">// Cache the text lengths to prevent multiple calls.</span>
<a name="l00380"></a>00380   <span class="keyword">const</span> <span class="keywordtype">int</span> text1_length = text1.length();
<a name="l00381"></a>00381   <span class="keyword">const</span> <span class="keywordtype">int</span> text2_length = text2.length();
<a name="l00382"></a>00382   <span class="keyword">const</span> <span class="keywordtype">int</span> max_d = (text1_length + text2_length + 1) / 2;
<a name="l00383"></a>00383   <span class="keyword">const</span> <span class="keywordtype">int</span> v_offset = max_d;
<a name="l00384"></a>00384   <span class="keyword">const</span> <span class="keywordtype">int</span> v_length = 2 * max_d;
<a name="l00385"></a>00385   <span class="keywordtype">int</span> *v1 = <span class="keyword">new</span> <span class="keywordtype">int</span>[v_length];
<a name="l00386"></a>00386   <span class="keywordtype">int</span> *v2 = <span class="keyword">new</span> <span class="keywordtype">int</span>[v_length];
<a name="l00387"></a>00387   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; v_length; x++) {
<a name="l00388"></a>00388     v1[x] = -1;
<a name="l00389"></a>00389     v2[x] = -1;
<a name="l00390"></a>00390   }
<a name="l00391"></a>00391   v1[v_offset + 1] = 0;
<a name="l00392"></a>00392   v2[v_offset + 1] = 0;
<a name="l00393"></a>00393   <span class="keyword">const</span> <span class="keywordtype">int</span> delta = text1_length - text2_length;
<a name="l00394"></a>00394   <span class="comment">// If the total number of characters is odd, then the front path will</span>
<a name="l00395"></a>00395   <span class="comment">// collide with the reverse path.</span>
<a name="l00396"></a>00396   <span class="keyword">const</span> <span class="keywordtype">bool</span> front = (delta % 2 != 0);
<a name="l00397"></a>00397   <span class="comment">// Offsets for start and end of k loop.</span>
<a name="l00398"></a>00398   <span class="comment">// Prevents mapping of space beyond the grid.</span>
<a name="l00399"></a>00399   <span class="keywordtype">int</span> k1start = 0;
<a name="l00400"></a>00400   <span class="keywordtype">int</span> k1end = 0;
<a name="l00401"></a>00401   <span class="keywordtype">int</span> k2start = 0;
<a name="l00402"></a>00402   <span class="keywordtype">int</span> k2end = 0;
<a name="l00403"></a>00403   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = 0; d &lt; max_d; d++) {
<a name="l00404"></a>00404     <span class="comment">// Bail out if deadline is reached.</span>
<a name="l00405"></a>00405     <span class="keywordflow">if</span> (clock() &gt; deadline) {
<a name="l00406"></a>00406       <span class="keywordflow">break</span>;
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     <span class="comment">// Walk the front path one step.</span>
<a name="l00410"></a>00410     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k1 = -d + k1start; k1 &lt;= d - k1end; k1 += 2) {
<a name="l00411"></a>00411       <span class="keyword">const</span> <span class="keywordtype">int</span> k1_offset = v_offset + k1;
<a name="l00412"></a>00412       <span class="keywordtype">int</span> x1;
<a name="l00413"></a>00413       <span class="keywordflow">if</span> (k1 == -d || (k1 != d &amp;&amp; v1[k1_offset - 1] &lt; v1[k1_offset + 1])) {
<a name="l00414"></a>00414         x1 = v1[k1_offset + 1];
<a name="l00415"></a>00415       } <span class="keywordflow">else</span> {
<a name="l00416"></a>00416         x1 = v1[k1_offset - 1] + 1;
<a name="l00417"></a>00417       }
<a name="l00418"></a>00418       <span class="keywordtype">int</span> y1 = x1 - k1;
<a name="l00419"></a>00419       <span class="keywordflow">while</span> (x1 &lt; text1_length &amp;&amp; y1 &lt; text2_length
<a name="l00420"></a>00420           &amp;&amp; text1[x1] == text2[y1]) {
<a name="l00421"></a>00421         x1++;
<a name="l00422"></a>00422         y1++;
<a name="l00423"></a>00423       }
<a name="l00424"></a>00424       v1[k1_offset] = x1;
<a name="l00425"></a>00425       <span class="keywordflow">if</span> (x1 &gt; text1_length) {
<a name="l00426"></a>00426         <span class="comment">// Ran off the right of the graph.</span>
<a name="l00427"></a>00427         k1end += 2;
<a name="l00428"></a>00428       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y1 &gt; text2_length) {
<a name="l00429"></a>00429         <span class="comment">// Ran off the bottom of the graph.</span>
<a name="l00430"></a>00430         k1start += 2;
<a name="l00431"></a>00431       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (front) {
<a name="l00432"></a>00432         <span class="keywordtype">int</span> k2_offset = v_offset + delta - k1;
<a name="l00433"></a>00433         <span class="keywordflow">if</span> (k2_offset &gt;= 0 &amp;&amp; k2_offset &lt; v_length &amp;&amp; v2[k2_offset] != -1) {
<a name="l00434"></a>00434           <span class="comment">// Mirror x2 onto top-left coordinate system.</span>
<a name="l00435"></a>00435           <span class="keywordtype">int</span> x2 = text1_length - v2[k2_offset];
<a name="l00436"></a>00436           <span class="keywordflow">if</span> (x1 &gt;= x2) {
<a name="l00437"></a>00437             <span class="comment">// Overlap detected.</span>
<a name="l00438"></a>00438             <span class="keyword">delete</span> [] v1;
<a name="l00439"></a>00439             <span class="keyword">delete</span> [] v2;
<a name="l00440"></a>00440             <span class="keywordflow">return</span> diff_bisectSplit(text1, text2, x1, y1, deadline);
<a name="l00441"></a>00441           }
<a name="l00442"></a>00442         }
<a name="l00443"></a>00443       }
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="comment">// Walk the reverse path one step.</span>
<a name="l00447"></a>00447     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k2 = -d + k2start; k2 &lt;= d - k2end; k2 += 2) {
<a name="l00448"></a>00448       <span class="keyword">const</span> <span class="keywordtype">int</span> k2_offset = v_offset + k2;
<a name="l00449"></a>00449       <span class="keywordtype">int</span> x2;
<a name="l00450"></a>00450       <span class="keywordflow">if</span> (k2 == -d || (k2 != d &amp;&amp; v2[k2_offset - 1] &lt; v2[k2_offset + 1])) {
<a name="l00451"></a>00451         x2 = v2[k2_offset + 1];
<a name="l00452"></a>00452       } <span class="keywordflow">else</span> {
<a name="l00453"></a>00453         x2 = v2[k2_offset - 1] + 1;
<a name="l00454"></a>00454       }
<a name="l00455"></a>00455       <span class="keywordtype">int</span> y2 = x2 - k2;
<a name="l00456"></a>00456       <span class="keywordflow">while</span> (x2 &lt; text1_length &amp;&amp; y2 &lt; text2_length
<a name="l00457"></a>00457           &amp;&amp; text1[text1_length - x2 - 1] == text2[text2_length - y2 - 1]) {
<a name="l00458"></a>00458         x2++;
<a name="l00459"></a>00459         y2++;
<a name="l00460"></a>00460       }
<a name="l00461"></a>00461       v2[k2_offset] = x2;
<a name="l00462"></a>00462       <span class="keywordflow">if</span> (x2 &gt; text1_length) {
<a name="l00463"></a>00463         <span class="comment">// Ran off the left of the graph.</span>
<a name="l00464"></a>00464         k2end += 2;
<a name="l00465"></a>00465       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y2 &gt; text2_length) {
<a name="l00466"></a>00466         <span class="comment">// Ran off the top of the graph.</span>
<a name="l00467"></a>00467         k2start += 2;
<a name="l00468"></a>00468       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!front) {
<a name="l00469"></a>00469         <span class="keywordtype">int</span> k1_offset = v_offset + delta - k2;
<a name="l00470"></a>00470         <span class="keywordflow">if</span> (k1_offset &gt;= 0 &amp;&amp; k1_offset &lt; v_length &amp;&amp; v1[k1_offset] != -1) {
<a name="l00471"></a>00471           <span class="keywordtype">int</span> x1 = v1[k1_offset];
<a name="l00472"></a>00472           <span class="keywordtype">int</span> y1 = v_offset + x1 - k1_offset;
<a name="l00473"></a>00473           <span class="comment">// Mirror x2 onto top-left coordinate system.</span>
<a name="l00474"></a>00474           x2 = text1_length - x2;
<a name="l00475"></a>00475           <span class="keywordflow">if</span> (x1 &gt;= x2) {
<a name="l00476"></a>00476             <span class="comment">// Overlap detected.</span>
<a name="l00477"></a>00477             <span class="keyword">delete</span> [] v1;
<a name="l00478"></a>00478             <span class="keyword">delete</span> [] v2;
<a name="l00479"></a>00479             <span class="keywordflow">return</span> diff_bisectSplit(text1, text2, x1, y1, deadline);
<a name="l00480"></a>00480           }
<a name="l00481"></a>00481         }
<a name="l00482"></a>00482       }
<a name="l00483"></a>00483     }
<a name="l00484"></a>00484   }
<a name="l00485"></a>00485   <span class="keyword">delete</span> [] v1;
<a name="l00486"></a>00486   <span class="keyword">delete</span> [] v2;
<a name="l00487"></a>00487   <span class="comment">// Diff took too long and hit the deadline or</span>
<a name="l00488"></a>00488   <span class="comment">// number of diffs equals number of characters, no commonality at all.</span>
<a name="l00489"></a>00489   QList&lt;Diff&gt; diffs;
<a name="l00490"></a>00490   diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>, text1));
<a name="l00491"></a>00491   diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>, text2));
<a name="l00492"></a>00492   <span class="keywordflow">return</span> diffs;
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 QList&lt;Diff&gt; diff_match_patch::diff_bisectSplit(<span class="keyword">const</span> QString &amp;text1,
<a name="l00496"></a>00496     <span class="keyword">const</span> QString &amp;text2, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, clock_t deadline) {
<a name="l00497"></a>00497   QString text1a = text1.left(x);
<a name="l00498"></a>00498   QString text2a = text2.left(y);
<a name="l00499"></a>00499   QString text1b = safeMid(text1, x);
<a name="l00500"></a>00500   QString text2b = safeMid(text2, y);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502   <span class="comment">// Compute both diffs serially.</span>
<a name="l00503"></a>00503   QList&lt;Diff&gt; diffs = <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_main</a>(text1a, text2a, <span class="keyword">false</span>, deadline);
<a name="l00504"></a>00504   QList&lt;Diff&gt; diffsb = <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_main</a>(text1b, text2b, <span class="keyword">false</span>, deadline);
<a name="l00505"></a>00505 
<a name="l00506"></a>00506   <span class="keywordflow">return</span> diffs + diffsb;
<a name="l00507"></a>00507 }
<a name="l00508"></a>00508 
<a name="l00509"></a><a class="code" href="classdiff__match__patch.html#ab1f120b83d49948767de531ab2a4e15a">00509</a> QList&lt;QVariant&gt; <a class="code" href="classdiff__match__patch.html#ab1f120b83d49948767de531ab2a4e15a">diff_match_patch::diff_linesToChars</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l00510"></a>00510                                                     <span class="keyword">const</span> QString &amp;text2) {
<a name="l00511"></a>00511   QStringList lineArray;
<a name="l00512"></a>00512   QMap&lt;QString, int&gt; lineHash;
<a name="l00513"></a>00513   <span class="comment">// e.g. linearray[4] == &quot;Hello\n&quot;</span>
<a name="l00514"></a>00514   <span class="comment">// e.g. linehash.get(&quot;Hello\n&quot;) == 4</span>
<a name="l00515"></a>00515 
<a name="l00516"></a>00516   <span class="comment">// &quot;\x00&quot; is a valid character, but various debuggers don&#39;t like it.</span>
<a name="l00517"></a>00517   <span class="comment">// So we&#39;ll insert a junk entry to avoid generating a null character.</span>
<a name="l00518"></a>00518   lineArray.append(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520   <span class="keyword">const</span> QString chars1 = diff_linesToCharsMunge(text1, lineArray, lineHash);
<a name="l00521"></a>00521   <span class="keyword">const</span> QString chars2 = diff_linesToCharsMunge(text2, lineArray, lineHash);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523   QList&lt;QVariant&gt; listRet;
<a name="l00524"></a>00524   listRet.append(QVariant::fromValue(chars1));
<a name="l00525"></a>00525   listRet.append(QVariant::fromValue(chars2));
<a name="l00526"></a>00526   listRet.append(QVariant::fromValue(lineArray));
<a name="l00527"></a>00527   <span class="keywordflow">return</span> listRet;
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 
<a name="l00531"></a>00531 QString diff_match_patch::diff_linesToCharsMunge(<span class="keyword">const</span> QString &amp;text,
<a name="l00532"></a>00532                                                  QStringList &amp;lineArray,
<a name="l00533"></a>00533                                                  QMap&lt;QString, int&gt; &amp;lineHash) {
<a name="l00534"></a>00534   <span class="keywordtype">int</span> lineStart = 0;
<a name="l00535"></a>00535   <span class="keywordtype">int</span> lineEnd = -1;
<a name="l00536"></a>00536   QString line;
<a name="l00537"></a>00537   QString chars;
<a name="l00538"></a>00538   <span class="comment">// Walk the text, pulling out a substring for each line.</span>
<a name="l00539"></a>00539   <span class="comment">// text.split(&#39;\n&#39;) would would temporarily double our memory footprint.</span>
<a name="l00540"></a>00540   <span class="comment">// Modifying text would create many large strings to garbage collect.</span>
<a name="l00541"></a>00541   <span class="keywordflow">while</span> (lineEnd &lt; text.length() - 1) {
<a name="l00542"></a>00542     lineEnd = text.indexOf(<span class="charliteral">&#39;\n&#39;</span>, lineStart);
<a name="l00543"></a>00543     <span class="keywordflow">if</span> (lineEnd == -1) {
<a name="l00544"></a>00544       lineEnd = text.length() - 1;
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546     line = safeMid(text, lineStart, lineEnd + 1 - lineStart);
<a name="l00547"></a>00547     lineStart = lineEnd + 1;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     <span class="keywordflow">if</span> (lineHash.contains(line)) {
<a name="l00550"></a>00550       chars += QChar(static_cast&lt;ushort&gt;(lineHash.value(line)));
<a name="l00551"></a>00551     } <span class="keywordflow">else</span> {
<a name="l00552"></a>00552       lineArray.append(line);
<a name="l00553"></a>00553       lineHash.insert(line, lineArray.size() - 1);
<a name="l00554"></a>00554       chars += QChar(static_cast&lt;ushort&gt;(lineArray.size() - 1));
<a name="l00555"></a>00555     }
<a name="l00556"></a>00556   }
<a name="l00557"></a>00557   <span class="keywordflow">return</span> chars;
<a name="l00558"></a>00558 }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 <span class="keywordtype">void</span> diff_match_patch::diff_charsToLines(QList&lt;Diff&gt; &amp;diffs,
<a name="l00563"></a>00563                                          <span class="keyword">const</span> QStringList &amp;lineArray) {
<a name="l00564"></a>00564   <span class="comment">// Qt has no mutable foreach construct.</span>
<a name="l00565"></a>00565   QMutableListIterator&lt;Diff&gt; i(diffs);
<a name="l00566"></a>00566   <span class="keywordflow">while</span> (i.hasNext()) {
<a name="l00567"></a>00567     <a class="code" href="class_diff.html">Diff</a> &amp;diff = i.next();
<a name="l00568"></a>00568     QString text;
<a name="l00569"></a>00569     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; diff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length(); y++) {
<a name="l00570"></a>00570       text += lineArray.value(static_cast&lt;ushort&gt;(diff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>[y].unicode()));
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572     diff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> = text;
<a name="l00573"></a>00573   }
<a name="l00574"></a>00574 }
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 
<a name="l00577"></a><a class="code" href="classdiff__match__patch.html#a6139ad292f602b8b9295fe0c48709e31">00577</a> <span class="keywordtype">int</span> <a class="code" href="classdiff__match__patch.html#a6139ad292f602b8b9295fe0c48709e31">diff_match_patch::diff_commonPrefix</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l00578"></a>00578                                         <span class="keyword">const</span> QString &amp;text2) {
<a name="l00579"></a>00579   <span class="comment">// Performance analysis: http://neil.fraser.name/news/2007/10/09/</span>
<a name="l00580"></a>00580   <span class="keyword">const</span> <span class="keywordtype">int</span> n = std::min(text1.length(), text2.length());
<a name="l00581"></a>00581   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n; i++) {
<a name="l00582"></a>00582     <span class="keywordflow">if</span> (text1[i] != text2[i]) {
<a name="l00583"></a>00583       <span class="keywordflow">return</span> i;
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585   }
<a name="l00586"></a>00586   <span class="keywordflow">return</span> n;
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 
<a name="l00590"></a><a class="code" href="classdiff__match__patch.html#aed765d65d9e6fb78de3725416a262586">00590</a> <span class="keywordtype">int</span> <a class="code" href="classdiff__match__patch.html#aed765d65d9e6fb78de3725416a262586">diff_match_patch::diff_commonSuffix</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l00591"></a>00591                                         <span class="keyword">const</span> QString &amp;text2) {
<a name="l00592"></a>00592   <span class="comment">// Performance analysis: http://neil.fraser.name/news/2007/10/09/</span>
<a name="l00593"></a>00593   <span class="keyword">const</span> <span class="keywordtype">int</span> text1_length = text1.length();
<a name="l00594"></a>00594   <span class="keyword">const</span> <span class="keywordtype">int</span> text2_length = text2.length();
<a name="l00595"></a>00595   <span class="keyword">const</span> <span class="keywordtype">int</span> n = std::min(text1_length, text2_length);
<a name="l00596"></a>00596   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt;= n; i++) {
<a name="l00597"></a>00597     <span class="keywordflow">if</span> (text1[text1_length - i] != text2[text2_length - i]) {
<a name="l00598"></a>00598       <span class="keywordflow">return</span> i - 1;
<a name="l00599"></a>00599     }
<a name="l00600"></a>00600   }
<a name="l00601"></a>00601   <span class="keywordflow">return</span> n;
<a name="l00602"></a>00602 }
<a name="l00603"></a>00603 
<a name="l00604"></a><a class="code" href="classdiff__match__patch.html#aa47c81e235ed1609fb915f03316d21dc">00604</a> <span class="keywordtype">int</span> <a class="code" href="classdiff__match__patch.html#aa47c81e235ed1609fb915f03316d21dc">diff_match_patch::diff_commonOverlap</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l00605"></a>00605                                          <span class="keyword">const</span> QString &amp;text2) {
<a name="l00606"></a>00606   <span class="comment">// Cache the text lengths to prevent multiple calls.</span>
<a name="l00607"></a>00607   <span class="keyword">const</span> <span class="keywordtype">int</span> text1_length = text1.length();
<a name="l00608"></a>00608   <span class="keyword">const</span> <span class="keywordtype">int</span> text2_length = text2.length();
<a name="l00609"></a>00609   <span class="comment">// Eliminate the null case.</span>
<a name="l00610"></a>00610   <span class="keywordflow">if</span> (text1_length == 0 || text2_length == 0) {
<a name="l00611"></a>00611     <span class="keywordflow">return</span> 0;
<a name="l00612"></a>00612   }
<a name="l00613"></a>00613   <span class="comment">// Truncate the longer string.</span>
<a name="l00614"></a>00614   QString text1_trunc = text1;
<a name="l00615"></a>00615   QString text2_trunc = text2;
<a name="l00616"></a>00616   <span class="keywordflow">if</span> (text1_length &gt; text2_length) {
<a name="l00617"></a>00617     text1_trunc = text1.right(text2_length);
<a name="l00618"></a>00618   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text1_length &lt; text2_length) {
<a name="l00619"></a>00619     text2_trunc = text2.left(text1_length);
<a name="l00620"></a>00620   }
<a name="l00621"></a>00621   <span class="keyword">const</span> <span class="keywordtype">int</span> text_length = std::min(text1_length, text2_length);
<a name="l00622"></a>00622   <span class="comment">// Quick check for the worst case.</span>
<a name="l00623"></a>00623   <span class="keywordflow">if</span> (text1_trunc == text2_trunc) {
<a name="l00624"></a>00624     <span class="keywordflow">return</span> text_length;
<a name="l00625"></a>00625   }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627   <span class="comment">// Start by looking for a single character match</span>
<a name="l00628"></a>00628   <span class="comment">// and increase length until no match is found.</span>
<a name="l00629"></a>00629   <span class="comment">// Performance analysis: http://neil.fraser.name/news/2010/11/04/</span>
<a name="l00630"></a>00630   <span class="keywordtype">int</span> best = 0;
<a name="l00631"></a>00631   <span class="keywordtype">int</span> length = 1;
<a name="l00632"></a>00632   <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l00633"></a>00633     QString pattern = text1_trunc.right(length);
<a name="l00634"></a>00634     <span class="keywordtype">int</span> found = text2_trunc.indexOf(pattern);
<a name="l00635"></a>00635     <span class="keywordflow">if</span> (found == -1) {
<a name="l00636"></a>00636       <span class="keywordflow">return</span> best;
<a name="l00637"></a>00637     }
<a name="l00638"></a>00638     length += found;
<a name="l00639"></a>00639     <span class="keywordflow">if</span> (found == 0 || text1_trunc.right(length) == text2_trunc.left(length)) {
<a name="l00640"></a>00640       best = length;
<a name="l00641"></a>00641       length++;
<a name="l00642"></a>00642     }
<a name="l00643"></a>00643   }
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00646"></a><a class="code" href="classdiff__match__patch.html#a34e2eabd2503e28eebe97a05dc3783dc">00646</a> QStringList <a class="code" href="classdiff__match__patch.html#a34e2eabd2503e28eebe97a05dc3783dc">diff_match_patch::diff_halfMatch</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l00647"></a>00647                                              <span class="keyword">const</span> QString &amp;text2) {
<a name="l00648"></a>00648   <span class="keywordflow">if</span> (<a class="code" href="classdiff__match__patch.html#aaa544a91d8555a780ab261fc1c15b3f9">Diff_Timeout</a> &lt;= 0) {
<a name="l00649"></a>00649     <span class="comment">// Don&#39;t risk returning a non-optimal diff if we have unlimited time.</span>
<a name="l00650"></a>00650     <span class="keywordflow">return</span> QStringList();
<a name="l00651"></a>00651   }
<a name="l00652"></a>00652   <span class="keyword">const</span> QString longtext = text1.length() &gt; text2.length() ? text1 : text2;
<a name="l00653"></a>00653   <span class="keyword">const</span> QString shorttext = text1.length() &gt; text2.length() ? text2 : text1;
<a name="l00654"></a>00654   <span class="keywordflow">if</span> (longtext.length() &lt; 4 || shorttext.length() * 2 &lt; longtext.length()) {
<a name="l00655"></a>00655     <span class="keywordflow">return</span> QStringList();  <span class="comment">// Pointless.</span>
<a name="l00656"></a>00656   }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658   <span class="comment">// First check if the second quarter is the seed for a half-match.</span>
<a name="l00659"></a>00659   <span class="keyword">const</span> QStringList hm1 = diff_halfMatchI(longtext, shorttext,
<a name="l00660"></a>00660       (longtext.length() + 3) / 4);
<a name="l00661"></a>00661   <span class="comment">// Check again based on the third quarter.</span>
<a name="l00662"></a>00662   <span class="keyword">const</span> QStringList hm2 = diff_halfMatchI(longtext, shorttext,
<a name="l00663"></a>00663       (longtext.length() + 1) / 2);
<a name="l00664"></a>00664   QStringList hm;
<a name="l00665"></a>00665   <span class="keywordflow">if</span> (hm1.isEmpty() &amp;&amp; hm2.isEmpty()) {
<a name="l00666"></a>00666     <span class="keywordflow">return</span> QStringList();
<a name="l00667"></a>00667   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hm2.isEmpty()) {
<a name="l00668"></a>00668     hm = hm1;
<a name="l00669"></a>00669   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hm1.isEmpty()) {
<a name="l00670"></a>00670     hm = hm2;
<a name="l00671"></a>00671   } <span class="keywordflow">else</span> {
<a name="l00672"></a>00672     <span class="comment">// Both matched.  Select the longest.</span>
<a name="l00673"></a>00673     hm = hm1[4].length() &gt; hm2[4].length() ? hm1 : hm2;
<a name="l00674"></a>00674   }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676   <span class="comment">// A half-match was found, sort out the return data.</span>
<a name="l00677"></a>00677   <span class="keywordflow">if</span> (text1.length() &gt; text2.length()) {
<a name="l00678"></a>00678     <span class="keywordflow">return</span> hm;
<a name="l00679"></a>00679   } <span class="keywordflow">else</span> {
<a name="l00680"></a>00680     QStringList listRet;
<a name="l00681"></a>00681     listRet &lt;&lt; hm[2] &lt;&lt; hm[3] &lt;&lt; hm[0] &lt;&lt; hm[1] &lt;&lt; hm[4];
<a name="l00682"></a>00682     <span class="keywordflow">return</span> listRet;
<a name="l00683"></a>00683   }
<a name="l00684"></a>00684 }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 QStringList diff_match_patch::diff_halfMatchI(<span class="keyword">const</span> QString &amp;longtext,
<a name="l00688"></a>00688                                               <span class="keyword">const</span> QString &amp;shorttext,
<a name="l00689"></a>00689                                               <span class="keywordtype">int</span> i) {
<a name="l00690"></a>00690   <span class="comment">// Start with a 1/4 length substring at position i as a seed.</span>
<a name="l00691"></a>00691   <span class="keyword">const</span> QString seed = safeMid(longtext, i, longtext.length() / 4);
<a name="l00692"></a>00692   <span class="keywordtype">int</span> j = -1;
<a name="l00693"></a>00693   QString best_common;
<a name="l00694"></a>00694   QString best_longtext_a, best_longtext_b;
<a name="l00695"></a>00695   QString best_shorttext_a, best_shorttext_b;
<a name="l00696"></a>00696   <span class="keywordflow">while</span> ((j = shorttext.indexOf(seed, j + 1)) != -1) {
<a name="l00697"></a>00697     <span class="keyword">const</span> <span class="keywordtype">int</span> prefixLength = <a class="code" href="classdiff__match__patch.html#a6139ad292f602b8b9295fe0c48709e31">diff_commonPrefix</a>(safeMid(longtext, i),
<a name="l00698"></a>00698         safeMid(shorttext, j));
<a name="l00699"></a>00699     <span class="keyword">const</span> <span class="keywordtype">int</span> suffixLength = <a class="code" href="classdiff__match__patch.html#aed765d65d9e6fb78de3725416a262586">diff_commonSuffix</a>(longtext.left(i),
<a name="l00700"></a>00700         shorttext.left(j));
<a name="l00701"></a>00701     <span class="keywordflow">if</span> (best_common.length() &lt; suffixLength + prefixLength) {
<a name="l00702"></a>00702       best_common = safeMid(shorttext, j - suffixLength, suffixLength)
<a name="l00703"></a>00703           + safeMid(shorttext, j, prefixLength);
<a name="l00704"></a>00704       best_longtext_a = longtext.left(i - suffixLength);
<a name="l00705"></a>00705       best_longtext_b = safeMid(longtext, i + prefixLength);
<a name="l00706"></a>00706       best_shorttext_a = shorttext.left(j - suffixLength);
<a name="l00707"></a>00707       best_shorttext_b = safeMid(shorttext, j + prefixLength);
<a name="l00708"></a>00708     }
<a name="l00709"></a>00709   }
<a name="l00710"></a>00710   <span class="keywordflow">if</span> (best_common.length() * 2 &gt;= longtext.length()) {
<a name="l00711"></a>00711     QStringList listRet;
<a name="l00712"></a>00712     listRet &lt;&lt; best_longtext_a &lt;&lt; best_longtext_b &lt;&lt; best_shorttext_a
<a name="l00713"></a>00713         &lt;&lt; best_shorttext_b &lt;&lt; best_common;
<a name="l00714"></a>00714     <span class="keywordflow">return</span> listRet;
<a name="l00715"></a>00715   } <span class="keywordflow">else</span> {
<a name="l00716"></a>00716     <span class="keywordflow">return</span> QStringList();
<a name="l00717"></a>00717   }
<a name="l00718"></a>00718 }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720 
<a name="l00721"></a><a class="code" href="classdiff__match__patch.html#a1150e91652b023e8893555f737ac9894">00721</a> <span class="keywordtype">void</span> <a class="code" href="classdiff__match__patch.html#a1150e91652b023e8893555f737ac9894">diff_match_patch::diff_cleanupSemantic</a>(QList&lt;Diff&gt; &amp;diffs) {
<a name="l00722"></a>00722   <span class="keywordflow">if</span> (diffs.isEmpty()) {
<a name="l00723"></a>00723     <span class="keywordflow">return</span>;
<a name="l00724"></a>00724   }
<a name="l00725"></a>00725   <span class="keywordtype">bool</span> changes = <span class="keyword">false</span>;
<a name="l00726"></a>00726   QStack&lt;Diff&gt; equalities;  <span class="comment">// Stack of equalities.</span>
<a name="l00727"></a>00727   QString lastequality;  <span class="comment">// Always equal to equalities.lastElement().text</span>
<a name="l00728"></a>00728   QMutableListIterator&lt;Diff&gt; pointer(diffs);
<a name="l00729"></a>00729   <span class="comment">// Number of characters that changed prior to the equality.</span>
<a name="l00730"></a>00730   <span class="keywordtype">int</span> length_insertions1 = 0;
<a name="l00731"></a>00731   <span class="keywordtype">int</span> length_deletions1 = 0;
<a name="l00732"></a>00732   <span class="comment">// Number of characters that changed after the equality.</span>
<a name="l00733"></a>00733   <span class="keywordtype">int</span> length_insertions2 = 0;
<a name="l00734"></a>00734   <span class="keywordtype">int</span> length_deletions2 = 0;
<a name="l00735"></a>00735   <a class="code" href="class_diff.html">Diff</a> *thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00736"></a>00736   <span class="keywordflow">while</span> (thisDiff != NULL) {
<a name="l00737"></a>00737     <span class="keywordflow">if</span> (thisDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l00738"></a>00738       <span class="comment">// Equality found.</span>
<a name="l00739"></a>00739       equalities.push(*thisDiff);
<a name="l00740"></a>00740       length_insertions1 = length_insertions2;
<a name="l00741"></a>00741       length_deletions1 = length_deletions2;
<a name="l00742"></a>00742       length_insertions2 = 0;
<a name="l00743"></a>00743       length_deletions2 = 0;
<a name="l00744"></a>00744       lastequality = thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l00745"></a>00745     } <span class="keywordflow">else</span> {
<a name="l00746"></a>00746       <span class="comment">// An insertion or deletion.</span>
<a name="l00747"></a>00747       <span class="keywordflow">if</span> (thisDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>) {
<a name="l00748"></a>00748         length_insertions2 += thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l00749"></a>00749       } <span class="keywordflow">else</span> {
<a name="l00750"></a>00750         length_deletions2 += thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l00751"></a>00751       }
<a name="l00752"></a>00752       <span class="keywordflow">if</span> (!lastequality.isNull()
<a name="l00753"></a>00753           &amp;&amp; (lastequality.length()
<a name="l00754"></a>00754               &lt;= std::max(length_insertions1, length_deletions1))
<a name="l00755"></a>00755           &amp;&amp; (lastequality.length()
<a name="l00756"></a>00756               &lt;= std::max(length_insertions2, length_deletions2))) {
<a name="l00757"></a>00757         <span class="comment">// printf(&quot;Splitting: &#39;%s&#39;\n&quot;, qPrintable(lastequality));</span>
<a name="l00758"></a>00758         <span class="comment">// Walk back to offending equality.</span>
<a name="l00759"></a>00759         <span class="keywordflow">while</span> (*thisDiff != equalities.top()) {
<a name="l00760"></a>00760           thisDiff = &amp;pointer.previous();
<a name="l00761"></a>00761         }
<a name="l00762"></a>00762         pointer.next();
<a name="l00763"></a>00763 
<a name="l00764"></a>00764         <span class="comment">// Replace equality with a delete.</span>
<a name="l00765"></a>00765         pointer.setValue(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>, lastequality));
<a name="l00766"></a>00766         <span class="comment">// Insert a corresponding an insert.</span>
<a name="l00767"></a>00767         pointer.insert(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>, lastequality));
<a name="l00768"></a>00768 
<a name="l00769"></a>00769         equalities.pop();  <span class="comment">// Throw away the equality we just deleted.</span>
<a name="l00770"></a>00770         <span class="keywordflow">if</span> (!equalities.isEmpty()) {
<a name="l00771"></a>00771           <span class="comment">// Throw away the previous equality (it needs to be reevaluated).</span>
<a name="l00772"></a>00772           equalities.pop();
<a name="l00773"></a>00773         }
<a name="l00774"></a>00774         <span class="keywordflow">if</span> (equalities.isEmpty()) {
<a name="l00775"></a>00775           <span class="comment">// There are no previous equalities, walk back to the start.</span>
<a name="l00776"></a>00776           <span class="keywordflow">while</span> (pointer.hasPrevious()) {
<a name="l00777"></a>00777             pointer.previous();
<a name="l00778"></a>00778           }
<a name="l00779"></a>00779         } <span class="keywordflow">else</span> {
<a name="l00780"></a>00780           <span class="comment">// There is a safe equality we can fall back to.</span>
<a name="l00781"></a>00781           thisDiff = &amp;equalities.top();
<a name="l00782"></a>00782           <span class="keywordflow">while</span> (*thisDiff != pointer.previous()) {
<a name="l00783"></a>00783             <span class="comment">// Intentionally empty loop.</span>
<a name="l00784"></a>00784           }
<a name="l00785"></a>00785         }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787         length_insertions1 = 0;  <span class="comment">// Reset the counters.</span>
<a name="l00788"></a>00788         length_deletions1 = 0;
<a name="l00789"></a>00789         length_insertions2 = 0;
<a name="l00790"></a>00790         length_deletions2 = 0;
<a name="l00791"></a>00791         lastequality = QString();
<a name="l00792"></a>00792         changes = <span class="keyword">true</span>;
<a name="l00793"></a>00793       }
<a name="l00794"></a>00794     }
<a name="l00795"></a>00795     thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00796"></a>00796   }
<a name="l00797"></a>00797 
<a name="l00798"></a>00798   <span class="comment">// Normalize the diff.</span>
<a name="l00799"></a>00799   <span class="keywordflow">if</span> (changes) {
<a name="l00800"></a>00800     <a class="code" href="classdiff__match__patch.html#ad64d391bc3f34cad326f869eedb748f9">diff_cleanupMerge</a>(diffs);
<a name="l00801"></a>00801   }
<a name="l00802"></a>00802   <a class="code" href="classdiff__match__patch.html#afd96870070c1dc460d1c261fa3f0f485">diff_cleanupSemanticLossless</a>(diffs);
<a name="l00803"></a>00803 
<a name="l00804"></a>00804   <span class="comment">// Find any overlaps between deletions and insertions.</span>
<a name="l00805"></a>00805   <span class="comment">// e.g: &lt;del&gt;abcxx&lt;/del&gt;&lt;ins&gt;xxdef&lt;/ins&gt;</span>
<a name="l00806"></a>00806   <span class="comment">//   -&gt; &lt;del&gt;abc&lt;/del&gt;xx&lt;ins&gt;def&lt;/ins&gt;</span>
<a name="l00807"></a>00807   pointer.toFront();
<a name="l00808"></a>00808   <a class="code" href="class_diff.html">Diff</a> *prevDiff = NULL;
<a name="l00809"></a>00809   thisDiff = NULL;
<a name="l00810"></a>00810   <span class="keywordflow">if</span> (pointer.hasNext()) {
<a name="l00811"></a>00811     prevDiff = &amp;pointer.next();
<a name="l00812"></a>00812     <span class="keywordflow">if</span> (pointer.hasNext()) {
<a name="l00813"></a>00813       thisDiff = &amp;pointer.next();
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815   }
<a name="l00816"></a>00816   <span class="keywordflow">while</span> (thisDiff != NULL) {
<a name="l00817"></a>00817     <span class="keywordflow">if</span> (prevDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a> &amp;&amp;
<a name="l00818"></a>00818         thisDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>) {
<a name="l00819"></a>00819       QString deletion = prevDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l00820"></a>00820       QString insertion = thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l00821"></a>00821       <span class="keywordtype">int</span> overlap_length = <a class="code" href="classdiff__match__patch.html#aa47c81e235ed1609fb915f03316d21dc">diff_commonOverlap</a>(deletion, insertion);
<a name="l00822"></a>00822       <span class="keywordflow">if</span> (overlap_length != 0) {
<a name="l00823"></a>00823         <span class="comment">// Overlap found.  Insert an equality and trim the surrounding edits.</span>
<a name="l00824"></a>00824         pointer.previous();
<a name="l00825"></a>00825         pointer.insert(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, insertion.left(overlap_length)));
<a name="l00826"></a>00826         prevDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> =
<a name="l00827"></a>00827             deletion.left(deletion.length() - overlap_length);
<a name="l00828"></a>00828         thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> = safeMid(insertion, overlap_length);
<a name="l00829"></a>00829         <span class="comment">// pointer.insert inserts the element before the cursor, so there is</span>
<a name="l00830"></a>00830         <span class="comment">// no need to step past the new element.</span>
<a name="l00831"></a>00831       }
<a name="l00832"></a>00832       thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00833"></a>00833     }
<a name="l00834"></a>00834     prevDiff = thisDiff;
<a name="l00835"></a>00835     thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00836"></a>00836   }
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839 
<a name="l00840"></a><a class="code" href="classdiff__match__patch.html#afd96870070c1dc460d1c261fa3f0f485">00840</a> <span class="keywordtype">void</span> <a class="code" href="classdiff__match__patch.html#afd96870070c1dc460d1c261fa3f0f485">diff_match_patch::diff_cleanupSemanticLossless</a>(QList&lt;Diff&gt; &amp;diffs) {
<a name="l00841"></a>00841   QString equality1, edit, equality2;
<a name="l00842"></a>00842   QString commonString;
<a name="l00843"></a>00843   <span class="keywordtype">int</span> commonOffset;
<a name="l00844"></a>00844   <span class="keywordtype">int</span> score, bestScore;
<a name="l00845"></a>00845   QString bestEquality1, bestEdit, bestEquality2;
<a name="l00846"></a>00846   <span class="comment">// Create a new iterator at the start.</span>
<a name="l00847"></a>00847   QMutableListIterator&lt;Diff&gt; pointer(diffs);
<a name="l00848"></a>00848   <a class="code" href="class_diff.html">Diff</a> *prevDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00849"></a>00849   <a class="code" href="class_diff.html">Diff</a> *thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00850"></a>00850   <a class="code" href="class_diff.html">Diff</a> *nextDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00851"></a>00851 
<a name="l00852"></a>00852   <span class="comment">// Intentionally ignore the first and last element (don&#39;t need checking).</span>
<a name="l00853"></a>00853   <span class="keywordflow">while</span> (nextDiff != NULL) {
<a name="l00854"></a>00854     <span class="keywordflow">if</span> (prevDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a> &amp;&amp;
<a name="l00855"></a>00855       nextDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l00856"></a>00856         <span class="comment">// This is a single edit surrounded by equalities.</span>
<a name="l00857"></a>00857         equality1 = prevDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l00858"></a>00858         edit = thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l00859"></a>00859         equality2 = nextDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861         <span class="comment">// First, shift the edit as far left as possible.</span>
<a name="l00862"></a>00862         commonOffset = <a class="code" href="classdiff__match__patch.html#aed765d65d9e6fb78de3725416a262586">diff_commonSuffix</a>(equality1, edit);
<a name="l00863"></a>00863         <span class="keywordflow">if</span> (commonOffset != 0) {
<a name="l00864"></a>00864           commonString = safeMid(edit, edit.length() - commonOffset);
<a name="l00865"></a>00865           equality1 = equality1.left(equality1.length() - commonOffset);
<a name="l00866"></a>00866           edit = commonString + edit.left(edit.length() - commonOffset);
<a name="l00867"></a>00867           equality2 = commonString + equality2;
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870         <span class="comment">// Second, step character by character right, looking for the best fit.</span>
<a name="l00871"></a>00871         bestEquality1 = equality1;
<a name="l00872"></a>00872         bestEdit = edit;
<a name="l00873"></a>00873         bestEquality2 = equality2;
<a name="l00874"></a>00874         bestScore = diff_cleanupSemanticScore(equality1, edit)
<a name="l00875"></a>00875             + diff_cleanupSemanticScore(edit, equality2);
<a name="l00876"></a>00876         <span class="keywordflow">while</span> (!edit.isEmpty() &amp;&amp; !equality2.isEmpty()
<a name="l00877"></a>00877             &amp;&amp; edit[0] == equality2[0]) {
<a name="l00878"></a>00878           equality1 += edit[0];
<a name="l00879"></a>00879           edit = safeMid(edit, 1) + equality2[0];
<a name="l00880"></a>00880           equality2 = safeMid(equality2, 1);
<a name="l00881"></a>00881           score = diff_cleanupSemanticScore(equality1, edit)
<a name="l00882"></a>00882               + diff_cleanupSemanticScore(edit, equality2);
<a name="l00883"></a>00883           <span class="comment">// The &gt;= encourages trailing rather than leading whitespace on edits.</span>
<a name="l00884"></a>00884           <span class="keywordflow">if</span> (score &gt;= bestScore) {
<a name="l00885"></a>00885             bestScore = score;
<a name="l00886"></a>00886             bestEquality1 = equality1;
<a name="l00887"></a>00887             bestEdit = edit;
<a name="l00888"></a>00888             bestEquality2 = equality2;
<a name="l00889"></a>00889           }
<a name="l00890"></a>00890         }
<a name="l00891"></a>00891 
<a name="l00892"></a>00892         <span class="keywordflow">if</span> (prevDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> != bestEquality1) {
<a name="l00893"></a>00893           <span class="comment">// We have an improvement, save it back to the diff.</span>
<a name="l00894"></a>00894           <span class="keywordflow">if</span> (!bestEquality1.isEmpty()) {
<a name="l00895"></a>00895             prevDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> = bestEquality1;
<a name="l00896"></a>00896           } <span class="keywordflow">else</span> {
<a name="l00897"></a>00897             pointer.previous();  <span class="comment">// Walk past nextDiff.</span>
<a name="l00898"></a>00898             pointer.previous();  <span class="comment">// Walk past thisDiff.</span>
<a name="l00899"></a>00899             pointer.previous();  <span class="comment">// Walk past prevDiff.</span>
<a name="l00900"></a>00900             pointer.remove();  <span class="comment">// Delete prevDiff.</span>
<a name="l00901"></a>00901             pointer.next();  <span class="comment">// Walk past thisDiff.</span>
<a name="l00902"></a>00902             pointer.next();  <span class="comment">// Walk past nextDiff.</span>
<a name="l00903"></a>00903           }
<a name="l00904"></a>00904           thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> = bestEdit;
<a name="l00905"></a>00905           <span class="keywordflow">if</span> (!bestEquality2.isEmpty()) {
<a name="l00906"></a>00906             nextDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> = bestEquality2;
<a name="l00907"></a>00907           } <span class="keywordflow">else</span> {
<a name="l00908"></a>00908             pointer.remove(); <span class="comment">// Delete nextDiff.</span>
<a name="l00909"></a>00909             nextDiff = thisDiff;
<a name="l00910"></a>00910             thisDiff = prevDiff;
<a name="l00911"></a>00911           }
<a name="l00912"></a>00912         }
<a name="l00913"></a>00913     }
<a name="l00914"></a>00914     prevDiff = thisDiff;
<a name="l00915"></a>00915     thisDiff = nextDiff;
<a name="l00916"></a>00916     nextDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00917"></a>00917   }
<a name="l00918"></a>00918 }
<a name="l00919"></a>00919 
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 <span class="keywordtype">int</span> diff_match_patch::diff_cleanupSemanticScore(<span class="keyword">const</span> QString &amp;one,
<a name="l00922"></a>00922                                                 <span class="keyword">const</span> QString &amp;two) {
<a name="l00923"></a>00923   <span class="keywordflow">if</span> (one.isEmpty() || two.isEmpty()) {
<a name="l00924"></a>00924     <span class="comment">// Edges are the best.</span>
<a name="l00925"></a>00925     <span class="keywordflow">return</span> 10;
<a name="l00926"></a>00926   }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928   <span class="comment">// Each port of this function behaves slightly differently due to</span>
<a name="l00929"></a>00929   <span class="comment">// subtle differences in each language&#39;s definition of things like</span>
<a name="l00930"></a>00930   <span class="comment">// &#39;whitespace&#39;.  Since this function&#39;s purpose is largely cosmetic,</span>
<a name="l00931"></a>00931   <span class="comment">// the choice has been made to use each language&#39;s native features</span>
<a name="l00932"></a>00932   <span class="comment">// rather than force total conformity.</span>
<a name="l00933"></a>00933   <span class="keywordtype">int</span> score = 0;
<a name="l00934"></a>00934   <span class="comment">// One point for non-alphanumeric.</span>
<a name="l00935"></a>00935   <span class="keywordflow">if</span> (!one[one.length() - 1].isLetterOrNumber()
<a name="l00936"></a>00936       || !two[0].isLetterOrNumber()) {
<a name="l00937"></a>00937     score++;
<a name="l00938"></a>00938     <span class="comment">// Two points for whitespace.</span>
<a name="l00939"></a>00939     <span class="keywordflow">if</span> (one[one.length() - 1].isSpace() || two[0].isSpace()) {
<a name="l00940"></a>00940       score++;
<a name="l00941"></a>00941       <span class="comment">// Three points for line breaks.</span>
<a name="l00942"></a>00942       <span class="keywordflow">if</span> (one[one.length() - 1].category() == QChar::Other_Control
<a name="l00943"></a>00943           || two[0].category() == QChar::Other_Control) {
<a name="l00944"></a>00944         score++;
<a name="l00945"></a>00945         <span class="comment">// Four points for blank lines.</span>
<a name="l00946"></a>00946         QRegExp blankLineEnd(<span class="stringliteral">&quot;\\n\\r?\\n$&quot;</span>);
<a name="l00947"></a>00947         QRegExp blankLineStart(<span class="stringliteral">&quot;^\\r?\\n\\r?\\n&quot;</span>);
<a name="l00948"></a>00948         <span class="keywordflow">if</span> (blankLineEnd.indexIn(one) != -1
<a name="l00949"></a>00949             || blankLineStart.indexIn(two) != -1) {
<a name="l00950"></a>00950           score++;
<a name="l00951"></a>00951         }
<a name="l00952"></a>00952       }
<a name="l00953"></a>00953     }
<a name="l00954"></a>00954   }
<a name="l00955"></a>00955   <span class="keywordflow">return</span> score;
<a name="l00956"></a>00956 }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958 
<a name="l00959"></a><a class="code" href="classdiff__match__patch.html#a41df9d26471d7d9f4ca085ab9f5da945">00959</a> <span class="keywordtype">void</span> <a class="code" href="classdiff__match__patch.html#a41df9d26471d7d9f4ca085ab9f5da945">diff_match_patch::diff_cleanupEfficiency</a>(QList&lt;Diff&gt; &amp;diffs) {
<a name="l00960"></a>00960   <span class="keywordflow">if</span> (diffs.isEmpty()) {
<a name="l00961"></a>00961     <span class="keywordflow">return</span>;
<a name="l00962"></a>00962   }
<a name="l00963"></a>00963   <span class="keywordtype">bool</span> changes = <span class="keyword">false</span>;
<a name="l00964"></a>00964   QStack&lt;Diff&gt; equalities;  <span class="comment">// Stack of equalities.</span>
<a name="l00965"></a>00965   QString lastequality;  <span class="comment">// Always equal to equalities.lastElement().text</span>
<a name="l00966"></a>00966   QMutableListIterator&lt;Diff&gt; pointer(diffs);
<a name="l00967"></a>00967   <span class="comment">// Is there an insertion operation before the last equality.</span>
<a name="l00968"></a>00968   <span class="keywordtype">bool</span> pre_ins = <span class="keyword">false</span>;
<a name="l00969"></a>00969   <span class="comment">// Is there a deletion operation before the last equality.</span>
<a name="l00970"></a>00970   <span class="keywordtype">bool</span> pre_del = <span class="keyword">false</span>;
<a name="l00971"></a>00971   <span class="comment">// Is there an insertion operation after the last equality.</span>
<a name="l00972"></a>00972   <span class="keywordtype">bool</span> post_ins = <span class="keyword">false</span>;
<a name="l00973"></a>00973   <span class="comment">// Is there a deletion operation after the last equality.</span>
<a name="l00974"></a>00974   <span class="keywordtype">bool</span> post_del = <span class="keyword">false</span>;
<a name="l00975"></a>00975 
<a name="l00976"></a>00976   <a class="code" href="class_diff.html">Diff</a> *thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l00977"></a>00977   <a class="code" href="class_diff.html">Diff</a> *safeDiff = thisDiff;
<a name="l00978"></a>00978 
<a name="l00979"></a>00979   <span class="keywordflow">while</span> (thisDiff != NULL) {
<a name="l00980"></a>00980     <span class="keywordflow">if</span> (thisDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l00981"></a>00981       <span class="comment">// Equality found.</span>
<a name="l00982"></a>00982       <span class="keywordflow">if</span> (thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length() &lt; <a class="code" href="classdiff__match__patch.html#a3a7134ca63b7e4cb44a2432ef4c34121">Diff_EditCost</a> &amp;&amp; (post_ins || post_del)) {
<a name="l00983"></a>00983         <span class="comment">// Candidate found.</span>
<a name="l00984"></a>00984         equalities.push(*thisDiff);
<a name="l00985"></a>00985         pre_ins = post_ins;
<a name="l00986"></a>00986         pre_del = post_del;
<a name="l00987"></a>00987         lastequality = thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l00988"></a>00988       } <span class="keywordflow">else</span> {
<a name="l00989"></a>00989         <span class="comment">// Not a candidate, and can never become one.</span>
<a name="l00990"></a>00990         equalities.clear();
<a name="l00991"></a>00991         lastequality = QString();
<a name="l00992"></a>00992         safeDiff = thisDiff;
<a name="l00993"></a>00993       }
<a name="l00994"></a>00994       post_ins = post_del = <span class="keyword">false</span>;
<a name="l00995"></a>00995     } <span class="keywordflow">else</span> {
<a name="l00996"></a>00996       <span class="comment">// An insertion or deletion.</span>
<a name="l00997"></a>00997       <span class="keywordflow">if</span> (thisDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>) {
<a name="l00998"></a>00998         post_del = <span class="keyword">true</span>;
<a name="l00999"></a>00999       } <span class="keywordflow">else</span> {
<a name="l01000"></a>01000         post_ins = <span class="keyword">true</span>;
<a name="l01001"></a>01001       }
<a name="l01002"></a>01002       <span class="comment">/*</span>
<a name="l01003"></a>01003 <span class="comment">      * Five types to be split:</span>
<a name="l01004"></a>01004 <span class="comment">      * &lt;ins&gt;A&lt;/ins&gt;&lt;del&gt;B&lt;/del&gt;XY&lt;ins&gt;C&lt;/ins&gt;&lt;del&gt;D&lt;/del&gt;</span>
<a name="l01005"></a>01005 <span class="comment">      * &lt;ins&gt;A&lt;/ins&gt;X&lt;ins&gt;C&lt;/ins&gt;&lt;del&gt;D&lt;/del&gt;</span>
<a name="l01006"></a>01006 <span class="comment">      * &lt;ins&gt;A&lt;/ins&gt;&lt;del&gt;B&lt;/del&gt;X&lt;ins&gt;C&lt;/ins&gt;</span>
<a name="l01007"></a>01007 <span class="comment">      * &lt;ins&gt;A&lt;/del&gt;X&lt;ins&gt;C&lt;/ins&gt;&lt;del&gt;D&lt;/del&gt;</span>
<a name="l01008"></a>01008 <span class="comment">      * &lt;ins&gt;A&lt;/ins&gt;&lt;del&gt;B&lt;/del&gt;X&lt;del&gt;C&lt;/del&gt;</span>
<a name="l01009"></a>01009 <span class="comment">      */</span>
<a name="l01010"></a>01010       <span class="keywordflow">if</span> (!lastequality.isNull()
<a name="l01011"></a>01011           &amp;&amp; ((pre_ins &amp;&amp; pre_del &amp;&amp; post_ins &amp;&amp; post_del)
<a name="l01012"></a>01012           || ((lastequality.length() &lt; <a class="code" href="classdiff__match__patch.html#a3a7134ca63b7e4cb44a2432ef4c34121">Diff_EditCost</a> / 2)
<a name="l01013"></a>01013           &amp;&amp; ((pre_ins ? 1 : 0) + (pre_del ? 1 : 0)
<a name="l01014"></a>01014           + (post_ins ? 1 : 0) + (post_del ? 1 : 0)) == 3))) {
<a name="l01015"></a>01015         <span class="comment">// printf(&quot;Splitting: &#39;%s&#39;\n&quot;, qPrintable(lastequality));</span>
<a name="l01016"></a>01016         <span class="comment">// Walk back to offending equality.</span>
<a name="l01017"></a>01017         <span class="keywordflow">while</span> (*thisDiff != equalities.top()) {
<a name="l01018"></a>01018           thisDiff = &amp;pointer.previous();
<a name="l01019"></a>01019         }
<a name="l01020"></a>01020         pointer.next();
<a name="l01021"></a>01021 
<a name="l01022"></a>01022         <span class="comment">// Replace equality with a delete.</span>
<a name="l01023"></a>01023         pointer.setValue(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>, lastequality));
<a name="l01024"></a>01024         <span class="comment">// Insert a corresponding an insert.</span>
<a name="l01025"></a>01025         pointer.insert(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>, lastequality));
<a name="l01026"></a>01026         thisDiff = &amp;pointer.previous();
<a name="l01027"></a>01027         pointer.next();
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         equalities.pop();  <span class="comment">// Throw away the equality we just deleted.</span>
<a name="l01030"></a>01030         lastequality = QString();
<a name="l01031"></a>01031         <span class="keywordflow">if</span> (pre_ins &amp;&amp; pre_del) {
<a name="l01032"></a>01032           <span class="comment">// No changes made which could affect previous entry, keep going.</span>
<a name="l01033"></a>01033           post_ins = post_del = <span class="keyword">true</span>;
<a name="l01034"></a>01034           equalities.clear();
<a name="l01035"></a>01035           safeDiff = thisDiff;
<a name="l01036"></a>01036         } <span class="keywordflow">else</span> {
<a name="l01037"></a>01037           <span class="keywordflow">if</span> (!equalities.isEmpty()) {
<a name="l01038"></a>01038             <span class="comment">// Throw away the previous equality (it needs to be reevaluated).</span>
<a name="l01039"></a>01039             equalities.pop();
<a name="l01040"></a>01040           }
<a name="l01041"></a>01041           <span class="keywordflow">if</span> (equalities.isEmpty()) {
<a name="l01042"></a>01042             <span class="comment">// There are no previous questionable equalities,</span>
<a name="l01043"></a>01043             <span class="comment">// walk back to the last known safe diff.</span>
<a name="l01044"></a>01044             thisDiff = safeDiff;
<a name="l01045"></a>01045           } <span class="keywordflow">else</span> {
<a name="l01046"></a>01046             <span class="comment">// There is an equality we can fall back to.</span>
<a name="l01047"></a>01047             thisDiff = &amp;equalities.top();
<a name="l01048"></a>01048           }
<a name="l01049"></a>01049           <span class="keywordflow">while</span> (*thisDiff != pointer.previous()) {
<a name="l01050"></a>01050             <span class="comment">// Intentionally empty loop.</span>
<a name="l01051"></a>01051           }
<a name="l01052"></a>01052           post_ins = post_del = <span class="keyword">false</span>;
<a name="l01053"></a>01053         }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055         changes = <span class="keyword">true</span>;
<a name="l01056"></a>01056       }
<a name="l01057"></a>01057     }
<a name="l01058"></a>01058     thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l01059"></a>01059   }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061   <span class="keywordflow">if</span> (changes) {
<a name="l01062"></a>01062     <a class="code" href="classdiff__match__patch.html#ad64d391bc3f34cad326f869eedb748f9">diff_cleanupMerge</a>(diffs);
<a name="l01063"></a>01063   }
<a name="l01064"></a>01064 }
<a name="l01065"></a>01065 
<a name="l01066"></a>01066 
<a name="l01067"></a><a class="code" href="classdiff__match__patch.html#ad64d391bc3f34cad326f869eedb748f9">01067</a> <span class="keywordtype">void</span> <a class="code" href="classdiff__match__patch.html#ad64d391bc3f34cad326f869eedb748f9">diff_match_patch::diff_cleanupMerge</a>(QList&lt;Diff&gt; &amp;diffs) {
<a name="l01068"></a>01068   diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, <span class="stringliteral">&quot;&quot;</span>));  <span class="comment">// Add a dummy entry at the end.</span>
<a name="l01069"></a>01069   QMutableListIterator&lt;Diff&gt; pointer(diffs);
<a name="l01070"></a>01070   <span class="keywordtype">int</span> count_delete = 0;
<a name="l01071"></a>01071   <span class="keywordtype">int</span> count_insert = 0;
<a name="l01072"></a>01072   QString text_delete = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01073"></a>01073   QString text_insert = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01074"></a>01074   <a class="code" href="class_diff.html">Diff</a> *thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l01075"></a>01075   <a class="code" href="class_diff.html">Diff</a> *prevEqual = NULL;
<a name="l01076"></a>01076   <span class="keywordtype">int</span> commonlength;
<a name="l01077"></a>01077   <span class="keywordflow">while</span> (thisDiff != NULL) {
<a name="l01078"></a>01078     <span class="keywordflow">switch</span> (thisDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a>) {
<a name="l01079"></a>01079       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>:
<a name="l01080"></a>01080         count_insert++;
<a name="l01081"></a>01081         text_insert += thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01082"></a>01082         prevEqual = NULL;
<a name="l01083"></a>01083         <span class="keywordflow">break</span>;
<a name="l01084"></a>01084       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>:
<a name="l01085"></a>01085         count_delete++;
<a name="l01086"></a>01086         text_delete += thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01087"></a>01087         prevEqual = NULL;
<a name="l01088"></a>01088         <span class="keywordflow">break</span>;
<a name="l01089"></a>01089       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>:
<a name="l01090"></a>01090         <span class="keywordflow">if</span> (count_delete + count_insert &gt; 1) {
<a name="l01091"></a>01091           <span class="keywordtype">bool</span> both_types = count_delete != 0 &amp;&amp; count_insert != 0;
<a name="l01092"></a>01092           <span class="comment">// Delete the offending records.</span>
<a name="l01093"></a>01093           pointer.previous();  <span class="comment">// Reverse direction.</span>
<a name="l01094"></a>01094           <span class="keywordflow">while</span> (count_delete-- &gt; 0) {
<a name="l01095"></a>01095             pointer.previous();
<a name="l01096"></a>01096             pointer.remove();
<a name="l01097"></a>01097           }
<a name="l01098"></a>01098           <span class="keywordflow">while</span> (count_insert-- &gt; 0) {
<a name="l01099"></a>01099             pointer.previous();
<a name="l01100"></a>01100             pointer.remove();
<a name="l01101"></a>01101           }
<a name="l01102"></a>01102           <span class="keywordflow">if</span> (both_types) {
<a name="l01103"></a>01103             <span class="comment">// Factor out any common prefixies.</span>
<a name="l01104"></a>01104             commonlength = <a class="code" href="classdiff__match__patch.html#a6139ad292f602b8b9295fe0c48709e31">diff_commonPrefix</a>(text_insert, text_delete);
<a name="l01105"></a>01105             <span class="keywordflow">if</span> (commonlength != 0) {
<a name="l01106"></a>01106               <span class="keywordflow">if</span> (pointer.hasPrevious()) {
<a name="l01107"></a>01107                 thisDiff = &amp;pointer.previous();
<a name="l01108"></a>01108                 <span class="keywordflow">if</span> (thisDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l01109"></a>01109                   <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Previous diff should have been an equality.&quot;</span>;
<a name="l01110"></a>01110                 }
<a name="l01111"></a>01111                 thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> += text_insert.left(commonlength);
<a name="l01112"></a>01112                 pointer.next();
<a name="l01113"></a>01113               } <span class="keywordflow">else</span> {
<a name="l01114"></a>01114                 pointer.insert(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, text_insert.left(commonlength)));
<a name="l01115"></a>01115               }
<a name="l01116"></a>01116               text_insert = safeMid(text_insert, commonlength);
<a name="l01117"></a>01117               text_delete = safeMid(text_delete, commonlength);
<a name="l01118"></a>01118             }
<a name="l01119"></a>01119             <span class="comment">// Factor out any common suffixies.</span>
<a name="l01120"></a>01120             commonlength = <a class="code" href="classdiff__match__patch.html#aed765d65d9e6fb78de3725416a262586">diff_commonSuffix</a>(text_insert, text_delete);
<a name="l01121"></a>01121             <span class="keywordflow">if</span> (commonlength != 0) {
<a name="l01122"></a>01122               thisDiff = &amp;pointer.next();
<a name="l01123"></a>01123               thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> = safeMid(text_insert, text_insert.length()
<a name="l01124"></a>01124                   - commonlength) + thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01125"></a>01125               text_insert = text_insert.left(text_insert.length()
<a name="l01126"></a>01126                   - commonlength);
<a name="l01127"></a>01127               text_delete = text_delete.left(text_delete.length()
<a name="l01128"></a>01128                   - commonlength);
<a name="l01129"></a>01129               pointer.previous();
<a name="l01130"></a>01130             }
<a name="l01131"></a>01131           }
<a name="l01132"></a>01132           <span class="comment">// Insert the merged records.</span>
<a name="l01133"></a>01133           <span class="keywordflow">if</span> (!text_delete.isEmpty()) {
<a name="l01134"></a>01134             pointer.insert(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>, text_delete));
<a name="l01135"></a>01135           }
<a name="l01136"></a>01136           <span class="keywordflow">if</span> (!text_insert.isEmpty()) {
<a name="l01137"></a>01137             pointer.insert(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>, text_insert));
<a name="l01138"></a>01138           }
<a name="l01139"></a>01139           <span class="comment">// Step forward to the equality.</span>
<a name="l01140"></a>01140           thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l01141"></a>01141 
<a name="l01142"></a>01142         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prevEqual != NULL) {
<a name="l01143"></a>01143           <span class="comment">// Merge this equality with the previous one.</span>
<a name="l01144"></a>01144           prevEqual-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> += thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01145"></a>01145           pointer.remove();
<a name="l01146"></a>01146           thisDiff = &amp;pointer.previous();
<a name="l01147"></a>01147           pointer.next();  <span class="comment">// Forward direction</span>
<a name="l01148"></a>01148         }
<a name="l01149"></a>01149         count_insert = 0;
<a name="l01150"></a>01150         count_delete = 0;
<a name="l01151"></a>01151         text_delete = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01152"></a>01152         text_insert = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01153"></a>01153         prevEqual = thisDiff;
<a name="l01154"></a>01154         <span class="keywordflow">break</span>;
<a name="l01155"></a>01155       }
<a name="l01156"></a>01156       thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l01157"></a>01157   }
<a name="l01158"></a>01158   <span class="keywordflow">if</span> (diffs.back().text.isEmpty()) {
<a name="l01159"></a>01159     diffs.removeLast();  <span class="comment">// Remove the dummy entry at the end.</span>
<a name="l01160"></a>01160   }
<a name="l01161"></a>01161 
<a name="l01162"></a>01162   <span class="comment">/*</span>
<a name="l01163"></a>01163 <span class="comment">  * Second pass: look for single edits surrounded on both sides by equalities</span>
<a name="l01164"></a>01164 <span class="comment">  * which can be shifted sideways to eliminate an equality.</span>
<a name="l01165"></a>01165 <span class="comment">  * e.g: A&lt;ins&gt;BA&lt;/ins&gt;C -&gt; &lt;ins&gt;AB&lt;/ins&gt;AC</span>
<a name="l01166"></a>01166 <span class="comment">  */</span>
<a name="l01167"></a>01167   <span class="keywordtype">bool</span> changes = <span class="keyword">false</span>;
<a name="l01168"></a>01168   <span class="comment">// Create a new iterator at the start.</span>
<a name="l01169"></a>01169   <span class="comment">// (As opposed to walking the current one back.)</span>
<a name="l01170"></a>01170   pointer.toFront();
<a name="l01171"></a>01171   <a class="code" href="class_diff.html">Diff</a> *prevDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l01172"></a>01172   thisDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l01173"></a>01173   <a class="code" href="class_diff.html">Diff</a> *nextDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l01174"></a>01174 
<a name="l01175"></a>01175   <span class="comment">// Intentionally ignore the first and last element (don&#39;t need checking).</span>
<a name="l01176"></a>01176   <span class="keywordflow">while</span> (nextDiff != NULL) {
<a name="l01177"></a>01177     <span class="keywordflow">if</span> (prevDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a> &amp;&amp;
<a name="l01178"></a>01178       nextDiff-&gt;<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l01179"></a>01179         <span class="comment">// This is a single edit surrounded by equalities.</span>
<a name="l01180"></a>01180         <span class="keywordflow">if</span> (thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.endsWith(prevDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>)) {
<a name="l01181"></a>01181           <span class="comment">// Shift the edit over the previous equality.</span>
<a name="l01182"></a>01182           thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> = prevDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>
<a name="l01183"></a>01183               + thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.left(thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length()
<a name="l01184"></a>01184               - prevDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length());
<a name="l01185"></a>01185           nextDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> = prevDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> + nextDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01186"></a>01186           pointer.previous();  <span class="comment">// Walk past nextDiff.</span>
<a name="l01187"></a>01187           pointer.previous();  <span class="comment">// Walk past thisDiff.</span>
<a name="l01188"></a>01188           pointer.previous();  <span class="comment">// Walk past prevDiff.</span>
<a name="l01189"></a>01189           pointer.remove();  <span class="comment">// Delete prevDiff.</span>
<a name="l01190"></a>01190           pointer.next();  <span class="comment">// Walk past thisDiff.</span>
<a name="l01191"></a>01191           thisDiff = &amp;pointer.next();  <span class="comment">// Walk past nextDiff.</span>
<a name="l01192"></a>01192           nextDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l01193"></a>01193           changes = <span class="keyword">true</span>;
<a name="l01194"></a>01194         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.startsWith(nextDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>)) {
<a name="l01195"></a>01195           <span class="comment">// Shift the edit over the next equality.</span>
<a name="l01196"></a>01196           prevDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> += nextDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01197"></a>01197           thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> = safeMid(thisDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>, nextDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length())
<a name="l01198"></a>01198               + nextDiff-&gt;<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01199"></a>01199           pointer.remove(); <span class="comment">// Delete nextDiff.</span>
<a name="l01200"></a>01200           nextDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l01201"></a>01201           changes = <span class="keyword">true</span>;
<a name="l01202"></a>01202         }
<a name="l01203"></a>01203     }
<a name="l01204"></a>01204     prevDiff = thisDiff;
<a name="l01205"></a>01205     thisDiff = nextDiff;
<a name="l01206"></a>01206     nextDiff = pointer.hasNext() ? &amp;pointer.next() : NULL;
<a name="l01207"></a>01207   }
<a name="l01208"></a>01208   <span class="comment">// If shifts were made, the diff needs reordering and another shift sweep.</span>
<a name="l01209"></a>01209   <span class="keywordflow">if</span> (changes) {
<a name="l01210"></a>01210     <a class="code" href="classdiff__match__patch.html#ad64d391bc3f34cad326f869eedb748f9">diff_cleanupMerge</a>(diffs);
<a name="l01211"></a>01211   }
<a name="l01212"></a>01212 }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214 
<a name="l01215"></a><a class="code" href="classdiff__match__patch.html#a91474da17c89bab2ca34efa207fe85b4">01215</a> <span class="keywordtype">int</span> <a class="code" href="classdiff__match__patch.html#a91474da17c89bab2ca34efa207fe85b4">diff_match_patch::diff_xIndex</a>(<span class="keyword">const</span> QList&lt;Diff&gt; &amp;diffs, <span class="keywordtype">int</span> loc) {
<a name="l01216"></a>01216   <span class="keywordtype">int</span> chars1 = 0;
<a name="l01217"></a>01217   <span class="keywordtype">int</span> chars2 = 0;
<a name="l01218"></a>01218   <span class="keywordtype">int</span> last_chars1 = 0;
<a name="l01219"></a>01219   <span class="keywordtype">int</span> last_chars2 = 0;
<a name="l01220"></a>01220   <a class="code" href="class_diff.html">Diff</a> lastDiff;
<a name="l01221"></a>01221   <span class="keywordflow">foreach</span>(<a class="code" href="class_diff.html">Diff</a> aDiff, diffs) {
<a name="l01222"></a>01222     <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>) {
<a name="l01223"></a>01223       <span class="comment">// Equality or deletion.</span>
<a name="l01224"></a>01224       chars1 += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01225"></a>01225     }
<a name="l01226"></a>01226     <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>) {
<a name="l01227"></a>01227       <span class="comment">// Equality or insertion.</span>
<a name="l01228"></a>01228       chars2 += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01229"></a>01229     }
<a name="l01230"></a>01230     <span class="keywordflow">if</span> (chars1 &gt; loc) {
<a name="l01231"></a>01231       <span class="comment">// Overshot the location.</span>
<a name="l01232"></a>01232       lastDiff = aDiff;
<a name="l01233"></a>01233       <span class="keywordflow">break</span>;
<a name="l01234"></a>01234     }
<a name="l01235"></a>01235     last_chars1 = chars1;
<a name="l01236"></a>01236     last_chars2 = chars2;
<a name="l01237"></a>01237   }
<a name="l01238"></a>01238   <span class="keywordflow">if</span> (lastDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>) {
<a name="l01239"></a>01239     <span class="comment">// The location was deleted.</span>
<a name="l01240"></a>01240     <span class="keywordflow">return</span> last_chars2;
<a name="l01241"></a>01241   }
<a name="l01242"></a>01242   <span class="comment">// Add the remaining character length.</span>
<a name="l01243"></a>01243   <span class="keywordflow">return</span> last_chars2 + (loc - last_chars1);
<a name="l01244"></a>01244 }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246 
<a name="l01247"></a><a class="code" href="classdiff__match__patch.html#a3eeaf8a99e5d6f53e8994128d64f57f1">01247</a> QString <a class="code" href="classdiff__match__patch.html#a3eeaf8a99e5d6f53e8994128d64f57f1">diff_match_patch::diff_prettyHtml</a>(<span class="keyword">const</span> QList&lt;Diff&gt; &amp;diffs) {
<a name="l01248"></a>01248   QString html;
<a name="l01249"></a>01249   QString text;
<a name="l01250"></a>01250   <span class="keywordtype">int</span> i = 0;
<a name="l01251"></a>01251   <span class="keywordflow">foreach</span>(<a class="code" href="class_diff.html">Diff</a> aDiff, diffs) {
<a name="l01252"></a>01252     text = aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01253"></a>01253     text.replace(<span class="stringliteral">&quot;&amp;&quot;</span>, <span class="stringliteral">&quot;&amp;amp;&quot;</span>).replace(<span class="stringliteral">&quot;&lt;&quot;</span>, <span class="stringliteral">&quot;&amp;lt;&quot;</span>)
<a name="l01254"></a>01254         .replace(<span class="stringliteral">&quot;&gt;&quot;</span>, <span class="stringliteral">&quot;&amp;gt;&quot;</span>).replace(<span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&quot;&amp;para;&lt;br&gt;&quot;</span>);
<a name="l01255"></a>01255     <span class="keywordflow">switch</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a>) {
<a name="l01256"></a>01256       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>:
<a name="l01257"></a>01257         html += QString(<span class="stringliteral">&quot;&lt;ins style=\&quot;background:#e6ffe6;\&quot;&gt;&quot;</span>) + text
<a name="l01258"></a>01258             + QString(<span class="stringliteral">&quot;&lt;/ins&gt;&quot;</span>);
<a name="l01259"></a>01259         <span class="keywordflow">break</span>;
<a name="l01260"></a>01260       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>:
<a name="l01261"></a>01261         html += QString(<span class="stringliteral">&quot;&lt;del style=\&quot;background:#ffe6e6;\&quot;&gt;&quot;</span>) + text
<a name="l01262"></a>01262             + QString(<span class="stringliteral">&quot;&lt;/del&gt;&quot;</span>);
<a name="l01263"></a>01263         <span class="keywordflow">break</span>;
<a name="l01264"></a>01264       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>:
<a name="l01265"></a>01265         html += QString(<span class="stringliteral">&quot;&lt;span&gt;&quot;</span>) + text + QString(<span class="stringliteral">&quot;&lt;/span&gt;&quot;</span>);
<a name="l01266"></a>01266         <span class="keywordflow">break</span>;
<a name="l01267"></a>01267     }
<a name="l01268"></a>01268     <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>) {
<a name="l01269"></a>01269       i += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01270"></a>01270     }
<a name="l01271"></a>01271   }
<a name="l01272"></a>01272   <span class="keywordflow">return</span> html;
<a name="l01273"></a>01273 }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275 
<a name="l01276"></a><a class="code" href="classdiff__match__patch.html#a6a1995ece702b50091f3883518864ea7">01276</a> QString <a class="code" href="classdiff__match__patch.html#a6a1995ece702b50091f3883518864ea7">diff_match_patch::diff_text1</a>(<span class="keyword">const</span> QList&lt;Diff&gt; &amp;diffs) {
<a name="l01277"></a>01277   QString text;
<a name="l01278"></a>01278   <span class="keywordflow">foreach</span>(<a class="code" href="class_diff.html">Diff</a> aDiff, diffs) {
<a name="l01279"></a>01279     <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>) {
<a name="l01280"></a>01280       text += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01281"></a>01281     }
<a name="l01282"></a>01282   }
<a name="l01283"></a>01283   <span class="keywordflow">return</span> text;
<a name="l01284"></a>01284 }
<a name="l01285"></a>01285 
<a name="l01286"></a>01286 
<a name="l01287"></a><a class="code" href="classdiff__match__patch.html#a9d3e1424496704a7e1d1f7995d465f20">01287</a> QString <a class="code" href="classdiff__match__patch.html#a9d3e1424496704a7e1d1f7995d465f20">diff_match_patch::diff_text2</a>(<span class="keyword">const</span> QList&lt;Diff&gt; &amp;diffs) {
<a name="l01288"></a>01288   QString text;
<a name="l01289"></a>01289   <span class="keywordflow">foreach</span>(<a class="code" href="class_diff.html">Diff</a> aDiff, diffs) {
<a name="l01290"></a>01290     <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>) {
<a name="l01291"></a>01291       text += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01292"></a>01292     }
<a name="l01293"></a>01293   }
<a name="l01294"></a>01294   <span class="keywordflow">return</span> text;
<a name="l01295"></a>01295 }
<a name="l01296"></a>01296 
<a name="l01297"></a>01297 
<a name="l01298"></a><a class="code" href="classdiff__match__patch.html#a5183e0300c4fbe6b993cae9844f57c11">01298</a> <span class="keywordtype">int</span> <a class="code" href="classdiff__match__patch.html#a5183e0300c4fbe6b993cae9844f57c11">diff_match_patch::diff_levenshtein</a>(<span class="keyword">const</span> QList&lt;Diff&gt; &amp;diffs) {
<a name="l01299"></a>01299   <span class="keywordtype">int</span> levenshtein = 0;
<a name="l01300"></a>01300   <span class="keywordtype">int</span> insertions = 0;
<a name="l01301"></a>01301   <span class="keywordtype">int</span> deletions = 0;
<a name="l01302"></a>01302   <span class="keywordflow">foreach</span>(<a class="code" href="class_diff.html">Diff</a> aDiff, diffs) {
<a name="l01303"></a>01303     <span class="keywordflow">switch</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a>) {
<a name="l01304"></a>01304       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>:
<a name="l01305"></a>01305         insertions += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01306"></a>01306         <span class="keywordflow">break</span>;
<a name="l01307"></a>01307       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>:
<a name="l01308"></a>01308         deletions += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01309"></a>01309         <span class="keywordflow">break</span>;
<a name="l01310"></a>01310       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>:
<a name="l01311"></a>01311         <span class="comment">// A deletion and an insertion is one substitution.</span>
<a name="l01312"></a>01312         levenshtein += std::max(insertions, deletions);
<a name="l01313"></a>01313         insertions = 0;
<a name="l01314"></a>01314         deletions = 0;
<a name="l01315"></a>01315         <span class="keywordflow">break</span>;
<a name="l01316"></a>01316     }
<a name="l01317"></a>01317   }
<a name="l01318"></a>01318   levenshtein += std::max(insertions, deletions);
<a name="l01319"></a>01319   <span class="keywordflow">return</span> levenshtein;
<a name="l01320"></a>01320 }
<a name="l01321"></a>01321 
<a name="l01322"></a>01322 
<a name="l01323"></a><a class="code" href="classdiff__match__patch.html#acc6b4e2d43c1be99c291049810bfc654">01323</a> QString <a class="code" href="classdiff__match__patch.html#acc6b4e2d43c1be99c291049810bfc654">diff_match_patch::diff_toDelta</a>(<span class="keyword">const</span> QList&lt;Diff&gt; &amp;diffs) {
<a name="l01324"></a>01324   QString text;
<a name="l01325"></a>01325   <span class="keywordflow">foreach</span>(<a class="code" href="class_diff.html">Diff</a> aDiff, diffs) {
<a name="l01326"></a>01326     <span class="keywordflow">switch</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a>) {
<a name="l01327"></a>01327       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>: {
<a name="l01328"></a>01328         QString encoded = QString(QUrl::toPercentEncoding(aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>,
<a name="l01329"></a>01329             <span class="stringliteral">&quot; !~*&#39;();/?:@&amp;=+$,#&quot;</span>));
<a name="l01330"></a>01330         text += QString(<span class="stringliteral">&quot;+&quot;</span>) + encoded + QString(<span class="stringliteral">&quot;\t&quot;</span>);
<a name="l01331"></a>01331         <span class="keywordflow">break</span>;
<a name="l01332"></a>01332       }
<a name="l01333"></a>01333       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>:
<a name="l01334"></a>01334         text += QString(<span class="stringliteral">&quot;-&quot;</span>) + QString::number(aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length())
<a name="l01335"></a>01335             + QString(<span class="stringliteral">&quot;\t&quot;</span>);
<a name="l01336"></a>01336         <span class="keywordflow">break</span>;
<a name="l01337"></a>01337       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>:
<a name="l01338"></a>01338         text += QString(<span class="stringliteral">&quot;=&quot;</span>) + QString::number(aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length())
<a name="l01339"></a>01339             + QString(<span class="stringliteral">&quot;\t&quot;</span>);
<a name="l01340"></a>01340         <span class="keywordflow">break</span>;
<a name="l01341"></a>01341     }
<a name="l01342"></a>01342   }
<a name="l01343"></a>01343   <span class="keywordflow">if</span> (!text.isEmpty()) {
<a name="l01344"></a>01344     <span class="comment">// Strip off trailing tab character.</span>
<a name="l01345"></a>01345     text = text.left(text.length() - 1);
<a name="l01346"></a>01346   }
<a name="l01347"></a>01347   <span class="keywordflow">return</span> text;
<a name="l01348"></a>01348 }
<a name="l01349"></a>01349 
<a name="l01350"></a>01350 
<a name="l01351"></a><a class="code" href="classdiff__match__patch.html#a70e244439ed3261a2a2c2ce092c45bc0">01351</a> QList&lt;Diff&gt; <a class="code" href="classdiff__match__patch.html#a70e244439ed3261a2a2c2ce092c45bc0">diff_match_patch::diff_fromDelta</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l01352"></a>01352                                              <span class="keyword">const</span> QString &amp;delta) {
<a name="l01353"></a>01353   QList&lt;Diff&gt; diffs;
<a name="l01354"></a>01354   <span class="keywordtype">int</span> pointer = 0;  <span class="comment">// Cursor in text1</span>
<a name="l01355"></a>01355   QStringList tokens = delta.split(<span class="stringliteral">&quot;\t&quot;</span>);
<a name="l01356"></a>01356   <span class="keywordflow">foreach</span>(QString token, tokens) {
<a name="l01357"></a>01357     <span class="keywordflow">if</span> (token.isEmpty()) {
<a name="l01358"></a>01358       <span class="comment">// Blank tokens are ok (from a trailing \t).</span>
<a name="l01359"></a>01359       <span class="keywordflow">continue</span>;
<a name="l01360"></a>01360     }
<a name="l01361"></a>01361     <span class="comment">// Each token begins with a one character parameter which specifies the</span>
<a name="l01362"></a>01362     <span class="comment">// operation of this token (delete, insert, equality).</span>
<a name="l01363"></a>01363     QString param = safeMid(token, 1);
<a name="l01364"></a>01364     <span class="keywordflow">switch</span> (token[0].toAscii()) {
<a name="l01365"></a>01365       <span class="keywordflow">case</span> <span class="charliteral">&#39;+&#39;</span>:
<a name="l01366"></a>01366         param = QUrl::fromPercentEncoding(qPrintable(param));
<a name="l01367"></a>01367         diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>, param));
<a name="l01368"></a>01368         <span class="keywordflow">break</span>;
<a name="l01369"></a>01369       <span class="keywordflow">case</span> <span class="charliteral">&#39;-&#39;</span>:
<a name="l01370"></a>01370         <span class="comment">// Fall through.</span>
<a name="l01371"></a>01371       <span class="keywordflow">case</span> <span class="charliteral">&#39;=&#39;</span>: {
<a name="l01372"></a>01372         <span class="keywordtype">int</span> n;
<a name="l01373"></a>01373         n = param.toInt();
<a name="l01374"></a>01374         <span class="keywordflow">if</span> (n &lt; 0) {
<a name="l01375"></a>01375           <span class="keywordflow">throw</span> QString(<span class="stringliteral">&quot;Negative number in diff_fromDelta: %1&quot;</span>).arg(param);
<a name="l01376"></a>01376         }
<a name="l01377"></a>01377         QString text;
<a name="l01378"></a>01378         text = safeMid(text1, pointer, n);
<a name="l01379"></a>01379         pointer += n;
<a name="l01380"></a>01380         <span class="keywordflow">if</span> (token[0] == QChar(<span class="charliteral">&#39;=&#39;</span>)) {
<a name="l01381"></a>01381           diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, text));
<a name="l01382"></a>01382         } <span class="keywordflow">else</span> {
<a name="l01383"></a>01383           diffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>, text));
<a name="l01384"></a>01384         }
<a name="l01385"></a>01385         <span class="keywordflow">break</span>;
<a name="l01386"></a>01386       }
<a name="l01387"></a>01387       <span class="keywordflow">default</span>:
<a name="l01388"></a>01388         <span class="keywordflow">throw</span> QString(<span class="stringliteral">&quot;Invalid diff operation in diff_fromDelta: %1&quot;</span>)
<a name="l01389"></a>01389             .arg(token[0]);
<a name="l01390"></a>01390     }
<a name="l01391"></a>01391   }
<a name="l01392"></a>01392   <span class="keywordflow">if</span> (pointer != text1.length()) {
<a name="l01393"></a>01393     <span class="keywordflow">throw</span> QString(<span class="stringliteral">&quot;Delta length (%1) smaller than source text length (%2)&quot;</span>)
<a name="l01394"></a>01394         .arg(pointer).arg(text1.length());
<a name="l01395"></a>01395   }
<a name="l01396"></a>01396   <span class="keywordflow">return</span> diffs;
<a name="l01397"></a>01397 }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399 
<a name="l01400"></a>01400   <span class="comment">//  MATCH FUNCTIONS</span>
<a name="l01401"></a>01401 
<a name="l01402"></a>01402 
<a name="l01403"></a><a class="code" href="classdiff__match__patch.html#aab1a27bfbb05e041a969617bf6594c23">01403</a> <span class="keywordtype">int</span> <a class="code" href="classdiff__match__patch.html#aab1a27bfbb05e041a969617bf6594c23">diff_match_patch::match_main</a>(<span class="keyword">const</span> QString &amp;text, <span class="keyword">const</span> QString &amp;pattern,
<a name="l01404"></a>01404                                  <span class="keywordtype">int</span> loc) {
<a name="l01405"></a>01405   <span class="comment">// Check for null inputs.</span>
<a name="l01406"></a>01406   <span class="keywordflow">if</span> (text.isNull() || pattern.isNull()) {
<a name="l01407"></a>01407     <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Null inputs. (match_main)&quot;</span>;
<a name="l01408"></a>01408   }
<a name="l01409"></a>01409 
<a name="l01410"></a>01410   loc = std::max(0, std::min(loc, text.length()));
<a name="l01411"></a>01411   <span class="keywordflow">if</span> (text == pattern) {
<a name="l01412"></a>01412     <span class="comment">// Shortcut (potentially not guaranteed by the algorithm)</span>
<a name="l01413"></a>01413     <span class="keywordflow">return</span> 0;
<a name="l01414"></a>01414   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (text.isEmpty()) {
<a name="l01415"></a>01415     <span class="comment">// Nothing to match.</span>
<a name="l01416"></a>01416     <span class="keywordflow">return</span> -1;
<a name="l01417"></a>01417   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (loc + pattern.length() &lt;= text.length()
<a name="l01418"></a>01418       &amp;&amp; safeMid(text, loc, pattern.length()) == pattern) {
<a name="l01419"></a>01419     <span class="comment">// Perfect match at the perfect spot!  (Includes case of null pattern)</span>
<a name="l01420"></a>01420     <span class="keywordflow">return</span> loc;
<a name="l01421"></a>01421   } <span class="keywordflow">else</span> {
<a name="l01422"></a>01422     <span class="comment">// Do a fuzzy compare.</span>
<a name="l01423"></a>01423     <span class="keywordflow">return</span> <a class="code" href="classdiff__match__patch.html#a9d8ebaab2f4cd4fb2ab01a3110c56b86">match_bitap</a>(text, pattern, loc);
<a name="l01424"></a>01424   }
<a name="l01425"></a>01425 }
<a name="l01426"></a>01426 
<a name="l01427"></a>01427 
<a name="l01428"></a><a class="code" href="classdiff__match__patch.html#a9d8ebaab2f4cd4fb2ab01a3110c56b86">01428</a> <span class="keywordtype">int</span> <a class="code" href="classdiff__match__patch.html#a9d8ebaab2f4cd4fb2ab01a3110c56b86">diff_match_patch::match_bitap</a>(<span class="keyword">const</span> QString &amp;text, <span class="keyword">const</span> QString &amp;pattern,
<a name="l01429"></a>01429                                   <span class="keywordtype">int</span> loc) {
<a name="l01430"></a>01430   <span class="keywordflow">if</span> (!(<a class="code" href="classdiff__match__patch.html#aa99b26cfb171f9ca3d558db26c76346c">Match_MaxBits</a> == 0 || pattern.length() &lt;= <a class="code" href="classdiff__match__patch.html#aa99b26cfb171f9ca3d558db26c76346c">Match_MaxBits</a>)) {
<a name="l01431"></a>01431     <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Pattern too long for this application.&quot;</span>;
<a name="l01432"></a>01432   }
<a name="l01433"></a>01433 
<a name="l01434"></a>01434   <span class="comment">// Initialise the alphabet.</span>
<a name="l01435"></a>01435   QMap&lt;QChar, int&gt; s = <a class="code" href="classdiff__match__patch.html#a106c32e9978fc36cafe6f1bc8f81bf8d">match_alphabet</a>(pattern);
<a name="l01436"></a>01436 
<a name="l01437"></a>01437   <span class="comment">// Highest score beyond which we give up.</span>
<a name="l01438"></a>01438   <span class="keywordtype">double</span> score_threshold = <a class="code" href="classdiff__match__patch.html#a4e7c966c7c2a930a578cf7ac8edc0e86">Match_Threshold</a>;
<a name="l01439"></a>01439   <span class="comment">// Is there a nearby exact match? (speedup)</span>
<a name="l01440"></a>01440   <span class="keywordtype">int</span> best_loc = text.indexOf(pattern, loc);
<a name="l01441"></a>01441   <span class="keywordflow">if</span> (best_loc != -1) {
<a name="l01442"></a>01442     score_threshold = std::min(match_bitapScore(0, best_loc, loc, pattern),
<a name="l01443"></a>01443         score_threshold);
<a name="l01444"></a>01444     <span class="comment">// What about in the other direction? (speedup)</span>
<a name="l01445"></a>01445     best_loc = text.lastIndexOf(pattern, loc + pattern.length());
<a name="l01446"></a>01446     <span class="keywordflow">if</span> (best_loc != -1) {
<a name="l01447"></a>01447       score_threshold = std::min(match_bitapScore(0, best_loc, loc, pattern),
<a name="l01448"></a>01448           score_threshold);
<a name="l01449"></a>01449     }
<a name="l01450"></a>01450   }
<a name="l01451"></a>01451 
<a name="l01452"></a>01452   <span class="comment">// Initialise the bit arrays.</span>
<a name="l01453"></a>01453   <span class="keywordtype">int</span> matchmask = 1 &lt;&lt; (pattern.length() - 1);
<a name="l01454"></a>01454   best_loc = -1;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456   <span class="keywordtype">int</span> bin_min, bin_mid;
<a name="l01457"></a>01457   <span class="keywordtype">int</span> bin_max = pattern.length() + text.length();
<a name="l01458"></a>01458   <span class="keywordtype">int</span> *rd;
<a name="l01459"></a>01459   <span class="keywordtype">int</span> *last_rd = NULL;
<a name="l01460"></a>01460   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = 0; d &lt; pattern.length(); d++) {
<a name="l01461"></a>01461     <span class="comment">// Scan for the best match; each iteration allows for one more error.</span>
<a name="l01462"></a>01462     <span class="comment">// Run a binary search to determine how far from &#39;loc&#39; we can stray at</span>
<a name="l01463"></a>01463     <span class="comment">// this error level.</span>
<a name="l01464"></a>01464     bin_min = 0;
<a name="l01465"></a>01465     bin_mid = bin_max;
<a name="l01466"></a>01466     <span class="keywordflow">while</span> (bin_min &lt; bin_mid) {
<a name="l01467"></a>01467       <span class="keywordflow">if</span> (match_bitapScore(d, loc + bin_mid, loc, pattern)
<a name="l01468"></a>01468           &lt;= score_threshold) {
<a name="l01469"></a>01469         bin_min = bin_mid;
<a name="l01470"></a>01470       } <span class="keywordflow">else</span> {
<a name="l01471"></a>01471         bin_max = bin_mid;
<a name="l01472"></a>01472       }
<a name="l01473"></a>01473       bin_mid = (bin_max - bin_min) / 2 + bin_min;
<a name="l01474"></a>01474     }
<a name="l01475"></a>01475     <span class="comment">// Use the result from this iteration as the maximum for the next.</span>
<a name="l01476"></a>01476     bin_max = bin_mid;
<a name="l01477"></a>01477     <span class="keywordtype">int</span> start = std::max(1, loc - bin_mid + 1);
<a name="l01478"></a>01478     <span class="keywordtype">int</span> finish = std::min(loc + bin_mid, text.length()) + pattern.length();
<a name="l01479"></a>01479 
<a name="l01480"></a>01480     rd = <span class="keyword">new</span> <span class="keywordtype">int</span>[finish + 2];
<a name="l01481"></a>01481     rd[finish + 1] = (1 &lt;&lt; d) - 1;
<a name="l01482"></a>01482     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = finish; j &gt;= start; j--) {
<a name="l01483"></a>01483       <span class="keywordtype">int</span> charMatch;
<a name="l01484"></a>01484       <span class="keywordflow">if</span> (text.length() &lt;= j - 1) {
<a name="l01485"></a>01485         <span class="comment">// Out of range.</span>
<a name="l01486"></a>01486         charMatch = 0;
<a name="l01487"></a>01487       } <span class="keywordflow">else</span> {
<a name="l01488"></a>01488         charMatch = s.value(text[j - 1], 0);
<a name="l01489"></a>01489       }
<a name="l01490"></a>01490       <span class="keywordflow">if</span> (d == 0) {
<a name="l01491"></a>01491         <span class="comment">// First pass: exact match.</span>
<a name="l01492"></a>01492         rd[j] = ((rd[j + 1] &lt;&lt; 1) | 1) &amp; charMatch;
<a name="l01493"></a>01493       } <span class="keywordflow">else</span> {
<a name="l01494"></a>01494         <span class="comment">// Subsequent passes: fuzzy match.</span>
<a name="l01495"></a>01495         rd[j] = ((rd[j + 1] &lt;&lt; 1) | 1) &amp; charMatch
<a name="l01496"></a>01496             | (((last_rd[j + 1] | last_rd[j]) &lt;&lt; 1) | 1)
<a name="l01497"></a>01497             | last_rd[j + 1];
<a name="l01498"></a>01498       }
<a name="l01499"></a>01499       <span class="keywordflow">if</span> ((rd[j] &amp; matchmask) != 0) {
<a name="l01500"></a>01500         <span class="keywordtype">double</span> score = match_bitapScore(d, j - 1, loc, pattern);
<a name="l01501"></a>01501         <span class="comment">// This match will almost certainly be better than any existing</span>
<a name="l01502"></a>01502         <span class="comment">// match.  But check anyway.</span>
<a name="l01503"></a>01503         <span class="keywordflow">if</span> (score &lt;= score_threshold) {
<a name="l01504"></a>01504           <span class="comment">// Told you so.</span>
<a name="l01505"></a>01505           score_threshold = score;
<a name="l01506"></a>01506           best_loc = j - 1;
<a name="l01507"></a>01507           <span class="keywordflow">if</span> (best_loc &gt; loc) {
<a name="l01508"></a>01508             <span class="comment">// When passing loc, don&#39;t exceed our current distance from loc.</span>
<a name="l01509"></a>01509             start = std::max(1, 2 * loc - best_loc);
<a name="l01510"></a>01510           } <span class="keywordflow">else</span> {
<a name="l01511"></a>01511             <span class="comment">// Already passed loc, downhill from here on in.</span>
<a name="l01512"></a>01512             <span class="keywordflow">break</span>;
<a name="l01513"></a>01513           }
<a name="l01514"></a>01514         }
<a name="l01515"></a>01515       }
<a name="l01516"></a>01516     }
<a name="l01517"></a>01517     <span class="keywordflow">if</span> (match_bitapScore(d + 1, loc, loc, pattern) &gt; score_threshold) {
<a name="l01518"></a>01518       <span class="comment">// No hope for a (better) match at greater error levels.</span>
<a name="l01519"></a>01519       <span class="keywordflow">break</span>;
<a name="l01520"></a>01520     }
<a name="l01521"></a>01521     <span class="keyword">delete</span> [] last_rd;
<a name="l01522"></a>01522     last_rd = rd;
<a name="l01523"></a>01523   }
<a name="l01524"></a>01524   <span class="keyword">delete</span> [] last_rd;
<a name="l01525"></a>01525   <span class="keyword">delete</span> [] rd;
<a name="l01526"></a>01526   <span class="keywordflow">return</span> best_loc;
<a name="l01527"></a>01527 }
<a name="l01528"></a>01528 
<a name="l01529"></a>01529 
<a name="l01530"></a>01530 <span class="keywordtype">double</span> diff_match_patch::match_bitapScore(<span class="keywordtype">int</span> e, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> loc,
<a name="l01531"></a>01531                                           <span class="keyword">const</span> QString &amp;pattern) {
<a name="l01532"></a>01532   <span class="keyword">const</span> <span class="keywordtype">float</span> accuracy = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span> (e) / pattern.length();
<a name="l01533"></a>01533   <span class="keyword">const</span> <span class="keywordtype">int</span> proximity = qAbs(loc - x);
<a name="l01534"></a>01534   <span class="keywordflow">if</span> (<a class="code" href="classdiff__match__patch.html#a57c49d8f3692157431ecd74fe6cd3f8f">Match_Distance</a> == 0) {
<a name="l01535"></a>01535     <span class="comment">// Dodge divide by zero error.</span>
<a name="l01536"></a>01536     <span class="keywordflow">return</span> proximity == 0 ? accuracy : 1.0;
<a name="l01537"></a>01537   }
<a name="l01538"></a>01538   <span class="keywordflow">return</span> accuracy + (proximity / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span> (<a class="code" href="classdiff__match__patch.html#a57c49d8f3692157431ecd74fe6cd3f8f">Match_Distance</a>));
<a name="l01539"></a>01539 }
<a name="l01540"></a>01540 
<a name="l01541"></a>01541 
<a name="l01542"></a><a class="code" href="classdiff__match__patch.html#a106c32e9978fc36cafe6f1bc8f81bf8d">01542</a> QMap&lt;QChar, int&gt; <a class="code" href="classdiff__match__patch.html#a106c32e9978fc36cafe6f1bc8f81bf8d">diff_match_patch::match_alphabet</a>(<span class="keyword">const</span> QString &amp;pattern) {
<a name="l01543"></a>01543   QMap&lt;QChar, int&gt; s;
<a name="l01544"></a>01544   <span class="keywordtype">int</span> i;
<a name="l01545"></a>01545   <span class="keywordflow">for</span> (i = 0; i &lt; pattern.length(); i++) {
<a name="l01546"></a>01546     QChar c = pattern[i];
<a name="l01547"></a>01547     s.insert(c, 0);
<a name="l01548"></a>01548   }
<a name="l01549"></a>01549   <span class="keywordflow">for</span> (i = 0; i &lt; pattern.length(); i++) {
<a name="l01550"></a>01550     QChar c = pattern[i];
<a name="l01551"></a>01551     s.insert(c, s.value(c) | (1 &lt;&lt; (pattern.length() - i - 1)));
<a name="l01552"></a>01552   }
<a name="l01553"></a>01553   <span class="keywordflow">return</span> s;
<a name="l01554"></a>01554 }
<a name="l01555"></a>01555 
<a name="l01556"></a>01556 
<a name="l01557"></a>01557 <span class="comment">//  PATCH FUNCTIONS</span>
<a name="l01558"></a>01558 
<a name="l01559"></a>01559 
<a name="l01560"></a><a class="code" href="classdiff__match__patch.html#a330cc0e446453f69d18a90ba9887c7db">01560</a> <span class="keywordtype">void</span> <a class="code" href="classdiff__match__patch.html#a330cc0e446453f69d18a90ba9887c7db">diff_match_patch::patch_addContext</a>(<a class="code" href="class_patch.html">Patch</a> &amp;patch, <span class="keyword">const</span> QString &amp;text) {
<a name="l01561"></a>01561   <span class="keywordflow">if</span> (text.isEmpty()) {
<a name="l01562"></a>01562     <span class="keywordflow">return</span>;
<a name="l01563"></a>01563   }
<a name="l01564"></a>01564   QString pattern = safeMid(text, patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a>, patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a>);
<a name="l01565"></a>01565   <span class="keywordtype">int</span> padding = 0;
<a name="l01566"></a>01566 
<a name="l01567"></a>01567   <span class="comment">// Look for the first and last matches of pattern in text.  If two different</span>
<a name="l01568"></a>01568   <span class="comment">// matches are found, increase the pattern length.</span>
<a name="l01569"></a>01569   <span class="keywordflow">while</span> (text.indexOf(pattern) != text.lastIndexOf(pattern)
<a name="l01570"></a>01570       &amp;&amp; pattern.length() &lt; <a class="code" href="classdiff__match__patch.html#aa99b26cfb171f9ca3d558db26c76346c">Match_MaxBits</a> - <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a> - <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>) {
<a name="l01571"></a>01571     padding += <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>;
<a name="l01572"></a>01572     pattern = safeMid(text, std::max(0, patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> - padding),
<a name="l01573"></a>01573         std::min(text.length(), patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> + patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> + padding)
<a name="l01574"></a>01574         - std::max(0, patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> - padding));
<a name="l01575"></a>01575   }
<a name="l01576"></a>01576   <span class="comment">// Add one chunk for good luck.</span>
<a name="l01577"></a>01577   padding += <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>;
<a name="l01578"></a>01578 
<a name="l01579"></a>01579   <span class="comment">// Add the prefix.</span>
<a name="l01580"></a>01580   QString prefix = safeMid(text, std::max(0, patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> - padding),
<a name="l01581"></a>01581       patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> - std::max(0, patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> - padding));
<a name="l01582"></a>01582   <span class="keywordflow">if</span> (!prefix.isEmpty()) {
<a name="l01583"></a>01583     patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.prepend(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, prefix));
<a name="l01584"></a>01584   }
<a name="l01585"></a>01585   <span class="comment">// Add the suffix.</span>
<a name="l01586"></a>01586   QString suffix = safeMid(text, patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> + patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a>,
<a name="l01587"></a>01587       std::min(text.length(), patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> + patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> + padding)
<a name="l01588"></a>01588       - (patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> + patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a>));
<a name="l01589"></a>01589   <span class="keywordflow">if</span> (!suffix.isEmpty()) {
<a name="l01590"></a>01590     patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, suffix));
<a name="l01591"></a>01591   }
<a name="l01592"></a>01592 
<a name="l01593"></a>01593   <span class="comment">// Roll back the start points.</span>
<a name="l01594"></a>01594   patch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> -= prefix.length();
<a name="l01595"></a>01595   patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> -= prefix.length();
<a name="l01596"></a>01596   <span class="comment">// Extend the lengths.</span>
<a name="l01597"></a>01597   patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> += prefix.length() + suffix.length();
<a name="l01598"></a>01598   patch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> += prefix.length() + suffix.length();
<a name="l01599"></a>01599 }
<a name="l01600"></a>01600 
<a name="l01601"></a>01601 
<a name="l01602"></a><a class="code" href="classdiff__match__patch.html#afb9335ec40ffb7b74a822a1210d90e19">01602</a> QList&lt;Patch&gt; <a class="code" href="classdiff__match__patch.html#afb9335ec40ffb7b74a822a1210d90e19">diff_match_patch::patch_make</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l01603"></a>01603                                           <span class="keyword">const</span> QString &amp;text2) {
<a name="l01604"></a>01604   <span class="comment">// Check for null inputs.</span>
<a name="l01605"></a>01605   <span class="keywordflow">if</span> (text1.isNull() || text2.isNull()) {
<a name="l01606"></a>01606     <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Null inputs. (patch_make)&quot;</span>;
<a name="l01607"></a>01607   }
<a name="l01608"></a>01608 
<a name="l01609"></a>01609   <span class="comment">// No diffs provided, compute our own.</span>
<a name="l01610"></a>01610   QList&lt;Diff&gt; diffs = <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_main</a>(text1, text2, <span class="keyword">true</span>);
<a name="l01611"></a>01611   <span class="keywordflow">if</span> (diffs.size() &gt; 2) {
<a name="l01612"></a>01612     <a class="code" href="classdiff__match__patch.html#a1150e91652b023e8893555f737ac9894">diff_cleanupSemantic</a>(diffs);
<a name="l01613"></a>01613     <a class="code" href="classdiff__match__patch.html#a41df9d26471d7d9f4ca085ab9f5da945">diff_cleanupEfficiency</a>(diffs);
<a name="l01614"></a>01614   }
<a name="l01615"></a>01615 
<a name="l01616"></a>01616   <span class="keywordflow">return</span> <a class="code" href="classdiff__match__patch.html#afb9335ec40ffb7b74a822a1210d90e19">patch_make</a>(text1, diffs);
<a name="l01617"></a>01617 }
<a name="l01618"></a>01618 
<a name="l01619"></a>01619 
<a name="l01620"></a><a class="code" href="classdiff__match__patch.html#ac5992f58192fc44530f33dd40202c165">01620</a> QList&lt;Patch&gt; <a class="code" href="classdiff__match__patch.html#afb9335ec40ffb7b74a822a1210d90e19">diff_match_patch::patch_make</a>(<span class="keyword">const</span> QList&lt;Diff&gt; &amp;diffs) {
<a name="l01621"></a>01621   <span class="comment">// No origin string provided, compute our own.</span>
<a name="l01622"></a>01622   <span class="keyword">const</span> QString text1 = <a class="code" href="classdiff__match__patch.html#a6a1995ece702b50091f3883518864ea7">diff_text1</a>(diffs);
<a name="l01623"></a>01623   <span class="keywordflow">return</span> <a class="code" href="classdiff__match__patch.html#afb9335ec40ffb7b74a822a1210d90e19">patch_make</a>(text1, diffs);
<a name="l01624"></a>01624 }
<a name="l01625"></a>01625 
<a name="l01626"></a>01626 
<a name="l01627"></a><a class="code" href="classdiff__match__patch.html#aaf3ea8fa0cd411d87dc465544fa68ac1">01627</a> QList&lt;Patch&gt; <a class="code" href="classdiff__match__patch.html#afb9335ec40ffb7b74a822a1210d90e19">diff_match_patch::patch_make</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l01628"></a>01628                                           <span class="keyword">const</span> QString &amp;text2,
<a name="l01629"></a>01629                                           <span class="keyword">const</span> QList&lt;Diff&gt; &amp;diffs) {
<a name="l01630"></a>01630   <span class="comment">// text2 is entirely unused.</span>
<a name="l01631"></a>01631   <span class="keywordflow">return</span> <a class="code" href="classdiff__match__patch.html#afb9335ec40ffb7b74a822a1210d90e19">patch_make</a>(text1, diffs);
<a name="l01632"></a>01632 
<a name="l01633"></a>01633   Q_UNUSED(text2)
<a name="l01634"></a>01634 }
<a name="l01635"></a>01635 
<a name="l01636"></a>01636 
<a name="l01637"></a><a class="code" href="classdiff__match__patch.html#a7fe185270bdffc221bd36f3f72635298">01637</a> QList&lt;Patch&gt; <a class="code" href="classdiff__match__patch.html#afb9335ec40ffb7b74a822a1210d90e19">diff_match_patch::patch_make</a>(<span class="keyword">const</span> QString &amp;text1,
<a name="l01638"></a>01638                                           <span class="keyword">const</span> QList&lt;Diff&gt; &amp;diffs) {
<a name="l01639"></a>01639   <span class="comment">// Check for null inputs.</span>
<a name="l01640"></a>01640   <span class="keywordflow">if</span> (text1.isNull()) {
<a name="l01641"></a>01641     <span class="keywordflow">throw</span> <span class="stringliteral">&quot;Null inputs. (patch_make)&quot;</span>;
<a name="l01642"></a>01642   }
<a name="l01643"></a>01643 
<a name="l01644"></a>01644   QList&lt;Patch&gt; patches;
<a name="l01645"></a>01645   <span class="keywordflow">if</span> (diffs.isEmpty()) {
<a name="l01646"></a>01646     <span class="keywordflow">return</span> patches;  <span class="comment">// Get rid of the null case.</span>
<a name="l01647"></a>01647   }
<a name="l01648"></a>01648   <a class="code" href="class_patch.html">Patch</a> patch;
<a name="l01649"></a>01649   <span class="keywordtype">int</span> char_count1 = 0;  <span class="comment">// Number of characters into the text1 string.</span>
<a name="l01650"></a>01650   <span class="keywordtype">int</span> char_count2 = 0;  <span class="comment">// Number of characters into the text2 string.</span>
<a name="l01651"></a>01651   <span class="comment">// Start with text1 (prepatch_text) and apply the diffs until we arrive at</span>
<a name="l01652"></a>01652   <span class="comment">// text2 (postpatch_text).  We recreate the patches one by one to determine</span>
<a name="l01653"></a>01653   <span class="comment">// context info.</span>
<a name="l01654"></a>01654   QString prepatch_text = text1;
<a name="l01655"></a>01655   QString postpatch_text = text1;
<a name="l01656"></a>01656   <span class="keywordflow">foreach</span>(<a class="code" href="class_diff.html">Diff</a> aDiff, diffs) {
<a name="l01657"></a>01657     <span class="keywordflow">if</span> (patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.isEmpty() &amp;&amp; aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l01658"></a>01658       <span class="comment">// A new patch starts here.</span>
<a name="l01659"></a>01659       patch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> = char_count1;
<a name="l01660"></a>01660       patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> = char_count2;
<a name="l01661"></a>01661     }
<a name="l01662"></a>01662 
<a name="l01663"></a>01663     <span class="keywordflow">switch</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a>) {
<a name="l01664"></a>01664       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>:
<a name="l01665"></a>01665         patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(aDiff);
<a name="l01666"></a>01666         patch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01667"></a>01667         postpatch_text = postpatch_text.left(char_count2)
<a name="l01668"></a>01668             + aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> + safeMid(postpatch_text, char_count2);
<a name="l01669"></a>01669         <span class="keywordflow">break</span>;
<a name="l01670"></a>01670       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>:
<a name="l01671"></a>01671         patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01672"></a>01672         patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(aDiff);
<a name="l01673"></a>01673         postpatch_text = postpatch_text.left(char_count2)
<a name="l01674"></a>01674             + safeMid(postpatch_text, char_count2 + aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length());
<a name="l01675"></a>01675         <span class="keywordflow">break</span>;
<a name="l01676"></a>01676       <span class="keywordflow">case</span> <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>:
<a name="l01677"></a>01677         <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length() &lt;= 2 * <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>
<a name="l01678"></a>01678             &amp;&amp; !patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.isEmpty() &amp;&amp; !(aDiff == diffs.back())) {
<a name="l01679"></a>01679           <span class="comment">// Small equality inside a patch.</span>
<a name="l01680"></a>01680           patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(aDiff);
<a name="l01681"></a>01681           patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01682"></a>01682           patch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01683"></a>01683         }
<a name="l01684"></a>01684 
<a name="l01685"></a>01685         <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length() &gt;= 2 * <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>) {
<a name="l01686"></a>01686           <span class="comment">// Time for a new patch.</span>
<a name="l01687"></a>01687           <span class="keywordflow">if</span> (!patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.isEmpty()) {
<a name="l01688"></a>01688             <a class="code" href="classdiff__match__patch.html#a330cc0e446453f69d18a90ba9887c7db">patch_addContext</a>(patch, prepatch_text);
<a name="l01689"></a>01689             patches.append(patch);
<a name="l01690"></a>01690             patch = <a class="code" href="class_patch.html">Patch</a>();
<a name="l01691"></a>01691             <span class="comment">// Unlike Unidiff, our patch lists have a rolling context.</span>
<a name="l01692"></a>01692             <span class="comment">// http://code.google.com/p/google-diff-match-patch/wiki/Unidiff</span>
<a name="l01693"></a>01693             <span class="comment">// Update prepatch text &amp; pos to reflect the application of the</span>
<a name="l01694"></a>01694             <span class="comment">// just completed patch.</span>
<a name="l01695"></a>01695             prepatch_text = postpatch_text;
<a name="l01696"></a>01696             char_count1 = char_count2;
<a name="l01697"></a>01697           }
<a name="l01698"></a>01698         }
<a name="l01699"></a>01699         <span class="keywordflow">break</span>;
<a name="l01700"></a>01700     }
<a name="l01701"></a>01701 
<a name="l01702"></a>01702     <span class="comment">// Update the current character count.</span>
<a name="l01703"></a>01703     <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>) {
<a name="l01704"></a>01704       char_count1 += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01705"></a>01705     }
<a name="l01706"></a>01706     <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>) {
<a name="l01707"></a>01707       char_count2 += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01708"></a>01708     }
<a name="l01709"></a>01709   }
<a name="l01710"></a>01710   <span class="comment">// Pick up the leftover patch if not empty.</span>
<a name="l01711"></a>01711   <span class="keywordflow">if</span> (!patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.isEmpty()) {
<a name="l01712"></a>01712     <a class="code" href="classdiff__match__patch.html#a330cc0e446453f69d18a90ba9887c7db">patch_addContext</a>(patch, prepatch_text);
<a name="l01713"></a>01713     patches.append(patch);
<a name="l01714"></a>01714   }
<a name="l01715"></a>01715 
<a name="l01716"></a>01716   <span class="keywordflow">return</span> patches;
<a name="l01717"></a>01717 }
<a name="l01718"></a>01718 
<a name="l01719"></a>01719 
<a name="l01720"></a><a class="code" href="classdiff__match__patch.html#aa4b405c41f79af23a8e60129c8e9a721">01720</a> QList&lt;Patch&gt; <a class="code" href="classdiff__match__patch.html#aa4b405c41f79af23a8e60129c8e9a721">diff_match_patch::patch_deepCopy</a>(QList&lt;Patch&gt; &amp;patches) {
<a name="l01721"></a>01721   QList&lt;Patch&gt; patchesCopy;
<a name="l01722"></a>01722   <span class="keywordflow">foreach</span>(<a class="code" href="class_patch.html">Patch</a> aPatch, patches) {
<a name="l01723"></a>01723     <a class="code" href="class_patch.html">Patch</a> patchCopy = <a class="code" href="class_patch.html">Patch</a>();
<a name="l01724"></a>01724     <span class="keywordflow">foreach</span>(<a class="code" href="class_diff.html">Diff</a> aDiff, aPatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>) {
<a name="l01725"></a>01725       <a class="code" href="class_diff.html">Diff</a> diffCopy = <a class="code" href="class_diff.html">Diff</a>(aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a>, aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>);
<a name="l01726"></a>01726       patchCopy.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(diffCopy);
<a name="l01727"></a>01727     }
<a name="l01728"></a>01728     patchCopy.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> = aPatch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a>;
<a name="l01729"></a>01729     patchCopy.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> = aPatch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a>;
<a name="l01730"></a>01730     patchCopy.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> = aPatch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a>;
<a name="l01731"></a>01731     patchCopy.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> = aPatch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a>;
<a name="l01732"></a>01732     patchesCopy.append(patchCopy);
<a name="l01733"></a>01733   }
<a name="l01734"></a>01734   <span class="keywordflow">return</span> patchesCopy;
<a name="l01735"></a>01735 }
<a name="l01736"></a>01736 
<a name="l01737"></a>01737 
<a name="l01738"></a><a class="code" href="classdiff__match__patch.html#acbdd755dfb40abc85760b4f8fbcdc98f">01738</a> QPair&lt;QString, QVector&lt;bool&gt; &gt; <a class="code" href="classdiff__match__patch.html#acbdd755dfb40abc85760b4f8fbcdc98f">diff_match_patch::patch_apply</a>(
<a name="l01739"></a>01739     QList&lt;Patch&gt; &amp;patches, <span class="keyword">const</span> QString &amp;sourceText) {
<a name="l01740"></a>01740   QString text = sourceText;  <span class="comment">// Copy to preserve original.</span>
<a name="l01741"></a>01741   <span class="keywordflow">if</span> (patches.isEmpty()) {
<a name="l01742"></a>01742     <span class="keywordflow">return</span> QPair&lt;QString,QVector&lt;bool&gt; &gt;(text, QVector&lt;bool&gt;(0));
<a name="l01743"></a>01743   }
<a name="l01744"></a>01744 
<a name="l01745"></a>01745   <span class="comment">// Deep copy the patches so that no changes are made to originals.</span>
<a name="l01746"></a>01746   QList&lt;Patch&gt; patchesCopy = <a class="code" href="classdiff__match__patch.html#aa4b405c41f79af23a8e60129c8e9a721">patch_deepCopy</a>(patches);
<a name="l01747"></a>01747 
<a name="l01748"></a>01748   QString nullPadding = <a class="code" href="classdiff__match__patch.html#a03d8b23bf20cbfc3e454aad38ff366d8">patch_addPadding</a>(patchesCopy);
<a name="l01749"></a>01749   text = nullPadding + text + nullPadding;
<a name="l01750"></a>01750   <a class="code" href="classdiff__match__patch.html#a8b026488adde70dcc268fc50d170f4e3">patch_splitMax</a>(patchesCopy);
<a name="l01751"></a>01751 
<a name="l01752"></a>01752   <span class="keywordtype">int</span> x = 0;
<a name="l01753"></a>01753   <span class="comment">// delta keeps track of the offset between the expected and actual location</span>
<a name="l01754"></a>01754   <span class="comment">// of the previous patch.  If there are patches expected at positions 10 and</span>
<a name="l01755"></a>01755   <span class="comment">// 20, but the first patch was found at 12, delta is 2 and the second patch</span>
<a name="l01756"></a>01756   <span class="comment">// has an effective expected position of 22.</span>
<a name="l01757"></a>01757   <span class="keywordtype">int</span> delta = 0;
<a name="l01758"></a>01758   QVector&lt;bool&gt; results(patchesCopy.size());
<a name="l01759"></a>01759   <span class="keywordflow">foreach</span>(<a class="code" href="class_patch.html">Patch</a> aPatch, patchesCopy) {
<a name="l01760"></a>01760     <span class="keywordtype">int</span> expected_loc = aPatch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> + delta;
<a name="l01761"></a>01761     QString text1 = <a class="code" href="classdiff__match__patch.html#a6a1995ece702b50091f3883518864ea7">diff_text1</a>(aPatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>);
<a name="l01762"></a>01762     <span class="keywordtype">int</span> start_loc;
<a name="l01763"></a>01763     <span class="keywordtype">int</span> end_loc = -1;
<a name="l01764"></a>01764     <span class="keywordflow">if</span> (text1.length() &gt; <a class="code" href="classdiff__match__patch.html#aa99b26cfb171f9ca3d558db26c76346c">Match_MaxBits</a>) {
<a name="l01765"></a>01765       <span class="comment">// patch_splitMax will only provide an oversized pattern in the case of</span>
<a name="l01766"></a>01766       <span class="comment">// a monster delete.</span>
<a name="l01767"></a>01767       start_loc = <a class="code" href="classdiff__match__patch.html#aab1a27bfbb05e041a969617bf6594c23">match_main</a>(text, text1.left(<a class="code" href="classdiff__match__patch.html#aa99b26cfb171f9ca3d558db26c76346c">Match_MaxBits</a>), expected_loc);
<a name="l01768"></a>01768       <span class="keywordflow">if</span> (start_loc != -1) {
<a name="l01769"></a>01769         end_loc = <a class="code" href="classdiff__match__patch.html#aab1a27bfbb05e041a969617bf6594c23">match_main</a>(text, text1.right(<a class="code" href="classdiff__match__patch.html#aa99b26cfb171f9ca3d558db26c76346c">Match_MaxBits</a>),
<a name="l01770"></a>01770             expected_loc + text1.length() - <a class="code" href="classdiff__match__patch.html#aa99b26cfb171f9ca3d558db26c76346c">Match_MaxBits</a>);
<a name="l01771"></a>01771         <span class="keywordflow">if</span> (end_loc == -1 || start_loc &gt;= end_loc) {
<a name="l01772"></a>01772           <span class="comment">// Can&#39;t find valid trailing context.  Drop this patch.</span>
<a name="l01773"></a>01773           start_loc = -1;
<a name="l01774"></a>01774         }
<a name="l01775"></a>01775       }
<a name="l01776"></a>01776     } <span class="keywordflow">else</span> {
<a name="l01777"></a>01777       start_loc = <a class="code" href="classdiff__match__patch.html#aab1a27bfbb05e041a969617bf6594c23">match_main</a>(text, text1, expected_loc);
<a name="l01778"></a>01778     }
<a name="l01779"></a>01779     <span class="keywordflow">if</span> (start_loc == -1) {
<a name="l01780"></a>01780       <span class="comment">// No match found.  :(</span>
<a name="l01781"></a>01781       results[x] = <span class="keyword">false</span>;
<a name="l01782"></a>01782       <span class="comment">// Subtract the delta for this failed patch from subsequent patches.</span>
<a name="l01783"></a>01783       delta -= aPatch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> - aPatch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a>;
<a name="l01784"></a>01784     } <span class="keywordflow">else</span> {
<a name="l01785"></a>01785       <span class="comment">// Found a match.  :)</span>
<a name="l01786"></a>01786       results[x] = <span class="keyword">true</span>;
<a name="l01787"></a>01787       delta = start_loc - expected_loc;
<a name="l01788"></a>01788       QString text2;
<a name="l01789"></a>01789       <span class="keywordflow">if</span> (end_loc == -1) {
<a name="l01790"></a>01790         text2 = safeMid(text, start_loc, text1.length());
<a name="l01791"></a>01791       } <span class="keywordflow">else</span> {
<a name="l01792"></a>01792         text2 = safeMid(text, start_loc, end_loc + <a class="code" href="classdiff__match__patch.html#aa99b26cfb171f9ca3d558db26c76346c">Match_MaxBits</a> - start_loc);
<a name="l01793"></a>01793       }
<a name="l01794"></a>01794       <span class="keywordflow">if</span> (text1 == text2) {
<a name="l01795"></a>01795         <span class="comment">// Perfect match, just shove the replacement text in.</span>
<a name="l01796"></a>01796         text = text.left(start_loc) + <a class="code" href="classdiff__match__patch.html#a9d3e1424496704a7e1d1f7995d465f20">diff_text2</a>(aPatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>)
<a name="l01797"></a>01797             + safeMid(text, start_loc + text1.length());
<a name="l01798"></a>01798       } <span class="keywordflow">else</span> {
<a name="l01799"></a>01799         <span class="comment">// Imperfect match.  Run a diff to get a framework of equivalent</span>
<a name="l01800"></a>01800         <span class="comment">// indices.</span>
<a name="l01801"></a>01801         QList&lt;Diff&gt; diffs = <a class="code" href="classdiff__match__patch.html#a82fe78383b2fddf542fe83e057252e53">diff_main</a>(text1, text2, <span class="keyword">false</span>);
<a name="l01802"></a>01802         <span class="keywordflow">if</span> (text1.length() &gt; <a class="code" href="classdiff__match__patch.html#aa99b26cfb171f9ca3d558db26c76346c">Match_MaxBits</a>
<a name="l01803"></a>01803             &amp;&amp; <a class="code" href="classdiff__match__patch.html#a5183e0300c4fbe6b993cae9844f57c11">diff_levenshtein</a>(diffs) / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span> (text1.length())
<a name="l01804"></a>01804             &gt; <a class="code" href="classdiff__match__patch.html#a45ecc3f1f3d865c8b1d1b2eb4f40ab33">Patch_DeleteThreshold</a>) {
<a name="l01805"></a>01805           <span class="comment">// The end points match, but the content is unacceptably bad.</span>
<a name="l01806"></a>01806           results[x] = <span class="keyword">false</span>;
<a name="l01807"></a>01807         } <span class="keywordflow">else</span> {
<a name="l01808"></a>01808           <a class="code" href="classdiff__match__patch.html#afd96870070c1dc460d1c261fa3f0f485">diff_cleanupSemanticLossless</a>(diffs);
<a name="l01809"></a>01809           <span class="keywordtype">int</span> index1 = 0;
<a name="l01810"></a>01810           <span class="keywordflow">foreach</span>(<a class="code" href="class_diff.html">Diff</a> aDiff, aPatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>) {
<a name="l01811"></a>01811             <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l01812"></a>01812               <span class="keywordtype">int</span> index2 = <a class="code" href="classdiff__match__patch.html#a91474da17c89bab2ca34efa207fe85b4">diff_xIndex</a>(diffs, index1);
<a name="l01813"></a>01813               <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>) {
<a name="l01814"></a>01814                 <span class="comment">// Insertion</span>
<a name="l01815"></a>01815                 text = text.left(start_loc + index2) + aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>
<a name="l01816"></a>01816                     + safeMid(text, start_loc + index2);
<a name="l01817"></a>01817               } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>) {
<a name="l01818"></a>01818                 <span class="comment">// Deletion</span>
<a name="l01819"></a>01819                 text = text.left(start_loc + index2)
<a name="l01820"></a>01820                     + safeMid(text, start_loc + <a class="code" href="classdiff__match__patch.html#a91474da17c89bab2ca34efa207fe85b4">diff_xIndex</a>(diffs,
<a name="l01821"></a>01821                     index1 + aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length()));
<a name="l01822"></a>01822               }
<a name="l01823"></a>01823             }
<a name="l01824"></a>01824             <span class="keywordflow">if</span> (aDiff.<a class="code" href="class_diff.html#a134b63b7f79fbb3596a42bb7b2a5140e">operation</a> != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>) {
<a name="l01825"></a>01825               index1 += aDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01826"></a>01826             }
<a name="l01827"></a>01827           }
<a name="l01828"></a>01828         }
<a name="l01829"></a>01829       }
<a name="l01830"></a>01830     }
<a name="l01831"></a>01831     x++;
<a name="l01832"></a>01832   }
<a name="l01833"></a>01833   <span class="comment">// Strip the padding off.</span>
<a name="l01834"></a>01834   text = safeMid(text, nullPadding.length(), text.length()
<a name="l01835"></a>01835       - 2 * nullPadding.length());
<a name="l01836"></a>01836   <span class="keywordflow">return</span> QPair&lt;QString, QVector&lt;bool&gt; &gt;(text, results);
<a name="l01837"></a>01837 }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839 
<a name="l01840"></a><a class="code" href="classdiff__match__patch.html#a03d8b23bf20cbfc3e454aad38ff366d8">01840</a> QString <a class="code" href="classdiff__match__patch.html#a03d8b23bf20cbfc3e454aad38ff366d8">diff_match_patch::patch_addPadding</a>(QList&lt;Patch&gt; &amp;patches) {
<a name="l01841"></a>01841   <span class="keywordtype">short</span> paddingLength = <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>;
<a name="l01842"></a>01842   QString nullPadding = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01843"></a>01843   <span class="keywordflow">for</span> (<span class="keywordtype">short</span> x = 1; x &lt;= paddingLength; x++) {
<a name="l01844"></a>01844     nullPadding += QChar((ushort)x);
<a name="l01845"></a>01845   }
<a name="l01846"></a>01846 
<a name="l01847"></a>01847   <span class="comment">// Bump all the patches forward.</span>
<a name="l01848"></a>01848   QMutableListIterator&lt;Patch&gt; pointer(patches);
<a name="l01849"></a>01849   <span class="keywordflow">while</span> (pointer.hasNext()) {
<a name="l01850"></a>01850     <a class="code" href="class_patch.html">Patch</a> &amp;aPatch = pointer.next();
<a name="l01851"></a>01851     aPatch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> += paddingLength;
<a name="l01852"></a>01852     aPatch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> += paddingLength;
<a name="l01853"></a>01853   }
<a name="l01854"></a>01854 
<a name="l01855"></a>01855   <span class="comment">// Add some padding on start of first diff.</span>
<a name="l01856"></a>01856   <a class="code" href="class_patch.html">Patch</a> &amp;firstPatch = patches.first();
<a name="l01857"></a>01857   QList&lt;Diff&gt; &amp;firstPatchDiffs = firstPatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>;
<a name="l01858"></a>01858   <span class="keywordflow">if</span> (firstPatchDiffs.empty() || firstPatchDiffs.first().operation != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l01859"></a>01859     <span class="comment">// Add nullPadding equality.</span>
<a name="l01860"></a>01860     firstPatchDiffs.prepend(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, nullPadding));
<a name="l01861"></a>01861     firstPatch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> -= paddingLength;  <span class="comment">// Should be 0.</span>
<a name="l01862"></a>01862     firstPatch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> -= paddingLength;  <span class="comment">// Should be 0.</span>
<a name="l01863"></a>01863     firstPatch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> += paddingLength;
<a name="l01864"></a>01864     firstPatch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> += paddingLength;
<a name="l01865"></a>01865   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (paddingLength &gt; firstPatchDiffs.first().text.length()) {
<a name="l01866"></a>01866     <span class="comment">// Grow first equality.</span>
<a name="l01867"></a>01867     <a class="code" href="class_diff.html">Diff</a> &amp;firstDiff = firstPatchDiffs.first();
<a name="l01868"></a>01868     <span class="keywordtype">int</span> extraLength = paddingLength - firstDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01869"></a>01869     firstDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> = safeMid(nullPadding, firstDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length(),
<a name="l01870"></a>01870         paddingLength - firstDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length()) + firstDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>;
<a name="l01871"></a>01871     firstPatch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> -= extraLength;
<a name="l01872"></a>01872     firstPatch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> -= extraLength;
<a name="l01873"></a>01873     firstPatch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> += extraLength;
<a name="l01874"></a>01874     firstPatch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> += extraLength;
<a name="l01875"></a>01875   }
<a name="l01876"></a>01876 
<a name="l01877"></a>01877   <span class="comment">// Add some padding on end of last diff.</span>
<a name="l01878"></a>01878   <a class="code" href="class_patch.html">Patch</a> &amp;lastPatch = patches.first();
<a name="l01879"></a>01879   QList&lt;Diff&gt; &amp;lastPatchDiffs = lastPatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>;
<a name="l01880"></a>01880   <span class="keywordflow">if</span> (lastPatchDiffs.empty() || lastPatchDiffs.last().operation != <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l01881"></a>01881     <span class="comment">// Add nullPadding equality.</span>
<a name="l01882"></a>01882     lastPatchDiffs.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, nullPadding));
<a name="l01883"></a>01883     lastPatch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> += paddingLength;
<a name="l01884"></a>01884     lastPatch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> += paddingLength;
<a name="l01885"></a>01885   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (paddingLength &gt; lastPatchDiffs.last().text.length()) {
<a name="l01886"></a>01886     <span class="comment">// Grow last equality.</span>
<a name="l01887"></a>01887     <a class="code" href="class_diff.html">Diff</a> &amp;lastDiff = lastPatchDiffs.last();
<a name="l01888"></a>01888     <span class="keywordtype">int</span> extraLength = paddingLength - lastDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a>.length();
<a name="l01889"></a>01889     lastDiff.<a class="code" href="class_diff.html#a5aab41a87ff74a0f572962ede20d9f2d">text</a> += nullPadding.left(extraLength);
<a name="l01890"></a>01890     lastPatch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> += extraLength;
<a name="l01891"></a>01891     lastPatch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> += extraLength;
<a name="l01892"></a>01892   }
<a name="l01893"></a>01893 
<a name="l01894"></a>01894   <span class="keywordflow">return</span> nullPadding;
<a name="l01895"></a>01895 }
<a name="l01896"></a>01896 
<a name="l01897"></a>01897 
<a name="l01898"></a><a class="code" href="classdiff__match__patch.html#a8b026488adde70dcc268fc50d170f4e3">01898</a> <span class="keywordtype">void</span> <a class="code" href="classdiff__match__patch.html#a8b026488adde70dcc268fc50d170f4e3">diff_match_patch::patch_splitMax</a>(QList&lt;Patch&gt; &amp;patches) {
<a name="l01899"></a>01899   <span class="keywordtype">short</span> patch_size = <a class="code" href="classdiff__match__patch.html#aa99b26cfb171f9ca3d558db26c76346c">Match_MaxBits</a>;
<a name="l01900"></a>01900   QString precontext, postcontext;
<a name="l01901"></a>01901   <a class="code" href="class_patch.html">Patch</a> patch;
<a name="l01902"></a>01902   <span class="keywordtype">int</span> start1, start2;
<a name="l01903"></a>01903   <span class="keywordtype">bool</span> empty;
<a name="l01904"></a>01904   <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bb">Operation</a> diff_type;
<a name="l01905"></a>01905   QString diff_text;
<a name="l01906"></a>01906   QMutableListIterator&lt;Patch&gt; pointer(patches);
<a name="l01907"></a>01907   <a class="code" href="class_patch.html">Patch</a> bigpatch;
<a name="l01908"></a>01908 
<a name="l01909"></a>01909   <span class="keywordflow">if</span> (pointer.hasNext()) {
<a name="l01910"></a>01910     bigpatch = pointer.next();
<a name="l01911"></a>01911   }
<a name="l01912"></a>01912 
<a name="l01913"></a>01913   <span class="keywordflow">while</span> (!bigpatch.<a class="code" href="class_patch.html#afdc9aba846465494845201a26d0fc20f">isNull</a>()) {
<a name="l01914"></a>01914     <span class="keywordflow">if</span> (bigpatch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> &lt;= patch_size) {
<a name="l01915"></a>01915       bigpatch = pointer.hasNext() ? pointer.next() : <a class="code" href="class_patch.html">Patch</a>();
<a name="l01916"></a>01916       <span class="keywordflow">continue</span>;
<a name="l01917"></a>01917     }
<a name="l01918"></a>01918     <span class="comment">// Remove the big old patch.</span>
<a name="l01919"></a>01919     pointer.remove();
<a name="l01920"></a>01920     start1 = bigpatch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a>;
<a name="l01921"></a>01921     start2 = bigpatch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a>;
<a name="l01922"></a>01922     precontext = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01923"></a>01923     <span class="keywordflow">while</span> (!bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.isEmpty()) {
<a name="l01924"></a>01924       <span class="comment">// Create one of several smaller patches.</span>
<a name="l01925"></a>01925       patch = <a class="code" href="class_patch.html">Patch</a>();
<a name="l01926"></a>01926       empty = <span class="keyword">true</span>;
<a name="l01927"></a>01927       patch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> = start1 - precontext.length();
<a name="l01928"></a>01928       patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> = start2 - precontext.length();
<a name="l01929"></a>01929       <span class="keywordflow">if</span> (!precontext.isEmpty()) {
<a name="l01930"></a>01930         patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> = patch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> = precontext.length();
<a name="l01931"></a>01931         patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, precontext));
<a name="l01932"></a>01932       }
<a name="l01933"></a>01933       <span class="keywordflow">while</span> (!bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.isEmpty()
<a name="l01934"></a>01934           &amp;&amp; patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> &lt; patch_size - <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>) {
<a name="l01935"></a>01935         diff_type = bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.front().operation;
<a name="l01936"></a>01936         diff_text = bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.front().text;
<a name="l01937"></a>01937         <span class="keywordflow">if</span> (diff_type == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>) {
<a name="l01938"></a>01938           <span class="comment">// Insertions are harmless.</span>
<a name="l01939"></a>01939           patch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> += diff_text.length();
<a name="l01940"></a>01940           start2 += diff_text.length();
<a name="l01941"></a>01941           patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.front());
<a name="l01942"></a>01942           bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.removeFirst();
<a name="l01943"></a>01943           empty = <span class="keyword">false</span>;
<a name="l01944"></a>01944         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (diff_type == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a> &amp;&amp; patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.size() == 1
<a name="l01945"></a>01945             &amp;&amp; patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.front().operation == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>
<a name="l01946"></a>01946             &amp;&amp; diff_text.length() &gt; 2 * patch_size) {
<a name="l01947"></a>01947           <span class="comment">// This is a large deletion.  Let it pass in one chunk.</span>
<a name="l01948"></a>01948           patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> += diff_text.length();
<a name="l01949"></a>01949           start1 += diff_text.length();
<a name="l01950"></a>01950           empty = <span class="keyword">false</span>;
<a name="l01951"></a>01951           patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(<a class="code" href="class_diff.html">Diff</a>(diff_type, diff_text));
<a name="l01952"></a>01952           bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.removeFirst();
<a name="l01953"></a>01953         } <span class="keywordflow">else</span> {
<a name="l01954"></a>01954           <span class="comment">// Deletion or equality.  Only take as much as we can stomach.</span>
<a name="l01955"></a>01955           diff_text = diff_text.left(std::min(diff_text.length(),
<a name="l01956"></a>01956               patch_size - patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> - <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>));
<a name="l01957"></a>01957           patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> += diff_text.length();
<a name="l01958"></a>01958           start1 += diff_text.length();
<a name="l01959"></a>01959           <span class="keywordflow">if</span> (diff_type == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l01960"></a>01960             patch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> += diff_text.length();
<a name="l01961"></a>01961             start2 += diff_text.length();
<a name="l01962"></a>01962           } <span class="keywordflow">else</span> {
<a name="l01963"></a>01963             empty = <span class="keyword">false</span>;
<a name="l01964"></a>01964           }
<a name="l01965"></a>01965           patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(<a class="code" href="class_diff.html">Diff</a>(diff_type, diff_text));
<a name="l01966"></a>01966           <span class="keywordflow">if</span> (diff_text == bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.front().text) {
<a name="l01967"></a>01967             bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.removeFirst();
<a name="l01968"></a>01968           } <span class="keywordflow">else</span> {
<a name="l01969"></a>01969             bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.front().text = safeMid(bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.front().text,
<a name="l01970"></a>01970                 diff_text.length());
<a name="l01971"></a>01971           }
<a name="l01972"></a>01972         }
<a name="l01973"></a>01973       }
<a name="l01974"></a>01974       <span class="comment">// Compute the head context for the next patch.</span>
<a name="l01975"></a>01975       precontext = <a class="code" href="classdiff__match__patch.html#a9d3e1424496704a7e1d1f7995d465f20">diff_text2</a>(patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>);
<a name="l01976"></a>01976       precontext = safeMid(precontext, precontext.length() - <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>);
<a name="l01977"></a>01977       <span class="comment">// Append the end context for this patch.</span>
<a name="l01978"></a>01978       <span class="keywordflow">if</span> (<a class="code" href="classdiff__match__patch.html#a6a1995ece702b50091f3883518864ea7">diff_text1</a>(bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>).length() &gt; <a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>) {
<a name="l01979"></a>01979         postcontext = <a class="code" href="classdiff__match__patch.html#a6a1995ece702b50091f3883518864ea7">diff_text1</a>(bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>).left(<a class="code" href="classdiff__match__patch.html#a798d3ee5eb9bf60ed679f50fa9a42d9b">Patch_Margin</a>);
<a name="l01980"></a>01980       } <span class="keywordflow">else</span> {
<a name="l01981"></a>01981         postcontext = <a class="code" href="classdiff__match__patch.html#a6a1995ece702b50091f3883518864ea7">diff_text1</a>(bigpatch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>);
<a name="l01982"></a>01982       }
<a name="l01983"></a>01983       <span class="keywordflow">if</span> (!postcontext.isEmpty()) {
<a name="l01984"></a>01984         patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> += postcontext.length();
<a name="l01985"></a>01985         patch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> += postcontext.length();
<a name="l01986"></a>01986         <span class="keywordflow">if</span> (!patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.isEmpty()
<a name="l01987"></a>01987             &amp;&amp; patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.back().operation == <a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>) {
<a name="l01988"></a>01988           patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.back().text += postcontext;
<a name="l01989"></a>01989         } <span class="keywordflow">else</span> {
<a name="l01990"></a>01990           patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, postcontext));
<a name="l01991"></a>01991         }
<a name="l01992"></a>01992       }
<a name="l01993"></a>01993       <span class="keywordflow">if</span> (!empty) {
<a name="l01994"></a>01994         pointer.insert(patch);
<a name="l01995"></a>01995       }
<a name="l01996"></a>01996     }
<a name="l01997"></a>01997     bigpatch = pointer.hasNext() ? pointer.next() : <a class="code" href="class_patch.html">Patch</a>();
<a name="l01998"></a>01998   }
<a name="l01999"></a>01999 }
<a name="l02000"></a>02000 
<a name="l02001"></a>02001 
<a name="l02002"></a><a class="code" href="classdiff__match__patch.html#ab23a8022e207c5aa2fd2ee7dad604341">02002</a> QString <a class="code" href="classdiff__match__patch.html#ab23a8022e207c5aa2fd2ee7dad604341">diff_match_patch::patch_toText</a>(<span class="keyword">const</span> QList&lt;Patch&gt; &amp;patches) {
<a name="l02003"></a>02003   QString text;
<a name="l02004"></a>02004   <span class="keywordflow">foreach</span>(<a class="code" href="class_patch.html">Patch</a> aPatch, patches) {
<a name="l02005"></a>02005     text.append(aPatch.<a class="code" href="class_patch.html#a53799d5296a89879d88f76c8f10602e7">toString</a>());
<a name="l02006"></a>02006   }
<a name="l02007"></a>02007   <span class="keywordflow">return</span> text;
<a name="l02008"></a>02008 }
<a name="l02009"></a>02009 
<a name="l02010"></a>02010 
<a name="l02011"></a><a class="code" href="classdiff__match__patch.html#a2d3d6460ce369b1f506a2c5d6b3fdee9">02011</a> QList&lt;Patch&gt; <a class="code" href="classdiff__match__patch.html#a2d3d6460ce369b1f506a2c5d6b3fdee9">diff_match_patch::patch_fromText</a>(<span class="keyword">const</span> QString &amp;textline) {
<a name="l02012"></a>02012   QList&lt;Patch&gt; patches;
<a name="l02013"></a>02013   <span class="keywordflow">if</span> (textline.isEmpty()) {
<a name="l02014"></a>02014     <span class="keywordflow">return</span> patches;
<a name="l02015"></a>02015   }
<a name="l02016"></a>02016   QStringList text = textline.split(<span class="stringliteral">&quot;\n&quot;</span>, QString::SkipEmptyParts);
<a name="l02017"></a>02017   <a class="code" href="class_patch.html">Patch</a> patch;
<a name="l02018"></a>02018   QRegExp patchHeader(<span class="stringliteral">&quot;^@@ -(\\d+),?(\\d*) \\+(\\d+),?(\\d*) @@$&quot;</span>);
<a name="l02019"></a>02019   <span class="keywordtype">char</span> sign;
<a name="l02020"></a>02020   QString line;
<a name="l02021"></a>02021   <span class="keywordflow">while</span> (!text.isEmpty()) {
<a name="l02022"></a>02022     <span class="keywordflow">if</span> (!patchHeader.exactMatch(text.front())) {
<a name="l02023"></a>02023       <span class="keywordflow">throw</span> QString(<span class="stringliteral">&quot;Invalid patch string: %1&quot;</span>).arg(text.front());
<a name="l02024"></a>02024     }
<a name="l02025"></a>02025 
<a name="l02026"></a>02026     patch = <a class="code" href="class_patch.html">Patch</a>();
<a name="l02027"></a>02027     patch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a> = patchHeader.cap(1).toInt();
<a name="l02028"></a>02028     <span class="keywordflow">if</span> (patchHeader.cap(2).isEmpty()) {
<a name="l02029"></a>02029       patch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a>--;
<a name="l02030"></a>02030       patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> = 1;
<a name="l02031"></a>02031     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (patchHeader.cap(2) == <span class="stringliteral">&quot;0&quot;</span>) {
<a name="l02032"></a>02032       patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> = 0;
<a name="l02033"></a>02033     } <span class="keywordflow">else</span> {
<a name="l02034"></a>02034       patch.<a class="code" href="class_patch.html#ae2fbf0aefd6ab5aeec4379cf388ff158">start1</a>--;
<a name="l02035"></a>02035       patch.<a class="code" href="class_patch.html#a6f1d748d94184a8f492bece1f967777d">length1</a> = patchHeader.cap(2).toInt();
<a name="l02036"></a>02036     }
<a name="l02037"></a>02037 
<a name="l02038"></a>02038     patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a> = patchHeader.cap(3).toInt();
<a name="l02039"></a>02039     <span class="keywordflow">if</span> (patchHeader.cap(4).isEmpty()) {
<a name="l02040"></a>02040       patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a>--;
<a name="l02041"></a>02041       patch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> = 1;
<a name="l02042"></a>02042     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (patchHeader.cap(4) == <span class="stringliteral">&quot;0&quot;</span>) {
<a name="l02043"></a>02043       patch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> = 0;
<a name="l02044"></a>02044     } <span class="keywordflow">else</span> {
<a name="l02045"></a>02045       patch.<a class="code" href="class_patch.html#a1ceab2853be39f706627f98e4d2ad8d6">start2</a>--;
<a name="l02046"></a>02046       patch.<a class="code" href="class_patch.html#a9ef05324cac27ec93ebd0be4270e9d1e">length2</a> = patchHeader.cap(4).toInt();
<a name="l02047"></a>02047     }
<a name="l02048"></a>02048     text.removeFirst();
<a name="l02049"></a>02049 
<a name="l02050"></a>02050     <span class="keywordflow">while</span> (!text.isEmpty()) {
<a name="l02051"></a>02051       <span class="keywordflow">if</span> (text.front().isEmpty()) {
<a name="l02052"></a>02052         text.removeFirst();
<a name="l02053"></a>02053         <span class="keywordflow">continue</span>;
<a name="l02054"></a>02054       }
<a name="l02055"></a>02055       sign = text.front()[0].toAscii();
<a name="l02056"></a>02056       line = safeMid(text.front(), 1);
<a name="l02057"></a>02057       line = line.replace(<span class="stringliteral">&quot;+&quot;</span>, <span class="stringliteral">&quot;%2B&quot;</span>);  <span class="comment">// decode would change all &quot;+&quot; to &quot; &quot;</span>
<a name="l02058"></a>02058       line = QUrl::fromPercentEncoding(qPrintable(line));
<a name="l02059"></a>02059       <span class="keywordflow">if</span> (sign == <span class="charliteral">&#39;-&#39;</span>) {
<a name="l02060"></a>02060         <span class="comment">// Deletion.</span>
<a name="l02061"></a>02061         patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba9d61e82a9a12752f10aece1b22183913">DELETE</a>, line));
<a name="l02062"></a>02062       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sign == <span class="charliteral">&#39;+&#39;</span>) {
<a name="l02063"></a>02063         <span class="comment">// Insertion.</span>
<a name="l02064"></a>02064         patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bbaa15c451953b2d2a93403afe786930d0f">INSERT</a>, line));
<a name="l02065"></a>02065       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sign == <span class="charliteral">&#39; &#39;</span>) {
<a name="l02066"></a>02066         <span class="comment">// Minor equality.</span>
<a name="l02067"></a>02067         patch.<a class="code" href="class_patch.html#a5017c7eb1118cc8ebe7030dd7a86475a">diffs</a>.append(<a class="code" href="class_diff.html">Diff</a>(<a class="code" href="diff__match__patch_8h.html#aa8f137f19095e0bdcf4f521e901f88bba59a84258a4cb9025b567ee5139455029">EQUAL</a>, line));
<a name="l02068"></a>02068       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sign == <span class="charliteral">&#39;@&#39;</span>) {
<a name="l02069"></a>02069         <span class="comment">// Start of next patch.</span>
<a name="l02070"></a>02070         <span class="keywordflow">break</span>;
<a name="l02071"></a>02071       } <span class="keywordflow">else</span> {
<a name="l02072"></a>02072         <span class="comment">// WTF?</span>
<a name="l02073"></a>02073         <span class="keywordflow">throw</span> QString(<span class="stringliteral">&quot;Invalid patch mode &#39;%1&#39; in: %2&quot;</span>).arg(sign).arg(line);
<a name="l02074"></a>02074         <span class="keywordflow">return</span> QList&lt;Patch&gt;();
<a name="l02075"></a>02075       }
<a name="l02076"></a>02076       text.removeFirst();
<a name="l02077"></a>02077     }
<a name="l02078"></a>02078 
<a name="l02079"></a>02079     patches.append(patch);
<a name="l02080"></a>02080 
<a name="l02081"></a>02081   }
<a name="l02082"></a>02082   <span class="keywordflow">return</span> patches;
<a name="l02083"></a>02083 }
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Wed May 25 2011 for Textshredder core by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
