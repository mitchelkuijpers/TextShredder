<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Textshredder core: libraries/synchronization/syncthread.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Textshredder core&#160;<span id="projectnumber">1.0</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">libraries/synchronization/syncthread.cpp</div>  </div>
</div>
<div class="contents">
<a href="syncthread_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="syncthread_8h.html">syncthread.h</a>&quot;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;../logging/textshredderlogging.cpp&quot;</span>
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="keywordtype">int</span> <a class="code" href="class_sync_thread.html#a2097449d9c853c523c06d48141d80ecb">SyncThread::sharedIndex</a> = 1;
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 quint16 SyncThread::nextSyncThreadHandle = 1;
<a name="l00007"></a>00007 
<a name="l00008"></a><a class="code" href="class_sync_thread.html#a838e6607043e507e4f06b3ee0e931d60">00008</a> <a class="code" href="class_sync_thread.html#a838e6607043e507e4f06b3ee0e931d60">SyncThread::SyncThread</a>(QObject * parent, QSharedPointer&lt;TextShredderConnection&gt;conn,
<a name="l00009"></a>00009                                            QSharedPointer&lt; WorkingCopy&gt; workingCopyPointer) :
<a name="l00010"></a>00010         QObject(parent), connectionPointer(conn), workingCopyPointer(workingCopyPointer),
<a name="l00011"></a>00011         shadowCopy(this), editList(NULL), timer(NULL),
<a name="l00012"></a>00012         logging(this, QString(<span class="stringliteral">&quot;SyncThread&quot;</span>).append(QString::number(sharedIndex))),
<a name="l00013"></a>00013         performanceLog(this, QString(<span class="stringliteral">&quot;Performance&quot;</span>).append(QString::number(sharedIndex)))
<a name="l00014"></a>00014 {
<a name="l00015"></a>00015         <a class="code" href="class_working_copy.html">WorkingCopy</a> *wc = workingCopyPointer.data();
<a name="l00016"></a>00016         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_patchable.html#aa386892c91c1718cd5151ccc491e1bbf">setContent</a>(* wc-&gt;<a class="code" href="class_patchable.html#a5abdd9e99d4ab7287cd1f47b23294bea">getContent</a>());
<a name="l00017"></a>00017 
<a name="l00018"></a>00018         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#af50ac8c141db70dc5a4311de5790ccf9">setLogging</a>(&amp;<a class="code" href="class_sync_thread.html#ae651d8e4d10f0ecc03da63980712aebd">logging</a>);
<a name="l00019"></a>00019 
<a name="l00020"></a>00020         connectSignalsForSynchronization();
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 
<a name="l00023"></a>00023         sourceSyncThreadHandle = nextSyncThreadHandle;
<a name="l00024"></a>00024         nextSyncThreadHandle++;
<a name="l00025"></a>00025 }
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="comment">//For testing only</span>
<a name="l00028"></a><a class="code" href="class_sync_thread.html#af9f68f9446253b0422c5f3f6b60fc1bb">00028</a> <a class="code" href="class_sync_thread.html#a838e6607043e507e4f06b3ee0e931d60">SyncThread::SyncThread</a>(QObject * parent, QSharedPointer &lt;WorkingCopy&gt; newWorkingCopy) :
<a name="l00029"></a>00029         QObject(parent), workingCopyPointer(newWorkingCopy),
<a name="l00030"></a>00030         shadowCopy(this, *newWorkingCopy.data()-&gt;getContent()), editList(NULL), timer(NULL),
<a name="l00031"></a>00031         logging(this), performanceLog(this)
<a name="l00032"></a>00032 {
<a name="l00033"></a>00033         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_patchable.html#aa386892c91c1718cd5151ccc491e1bbf">setContent</a>(*<a class="code" href="class_sync_thread.html#a73bbe84d7d531f2e6e728d5ade881270">workingCopyPointer</a>.data()-&gt;getContent()); <span class="comment">// set shadow copy</span>
<a name="l00034"></a>00034         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#af50ac8c141db70dc5a4311de5790ccf9">setLogging</a>(&amp;<a class="code" href="class_sync_thread.html#ae651d8e4d10f0ecc03da63980712aebd">logging</a>);
<a name="l00035"></a>00035         <a class="code" href="class_sync_thread.html#a9500610685e61a7c4fcbc474a9afa642">syncThreadNumber</a> = <a class="code" href="class_sync_thread.html#a2097449d9c853c523c06d48141d80ecb">sharedIndex</a>++;
<a name="l00036"></a>00036 }
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="class_sync_thread.html#a698ef3633b24d3529a6c17e5e3a99170">00038</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#a698ef3633b24d3529a6c17e5e3a99170">SyncThread::startSync</a>()
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040         <a class="code" href="class_sync_thread.html#ac244e02c977cb8f5614bb2ff19ff1804">timer</a>.start(<a class="code" href="syncthread_8h.html#a2382bd1863f4996954f6988e9fe24b94">WRITETHREAD_INTERVAL</a>);
<a name="l00041"></a>00041 }
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="class_sync_thread.html#a6942467b2594dac2cca3fb6844676548">00043</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#a6942467b2594dac2cca3fb6844676548">SyncThread::receivedEditPacketContent</a>(QByteArray &amp;content, quint16 destination)
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045         <span class="comment">//really the one who wrote this if statement and sees this comment, plz get a gun, put in your mounth and pull the fucking trigger</span>
<a name="l00046"></a>00046         <span class="comment">//Corne wrote this... UGH. Go jerk oloff on the women toilet you fucking pussy ass mother fucker.</span>
<a name="l00047"></a>00047         <span class="keywordflow">if</span> (sourceSyncThreadHandle == destination) {
<a name="l00048"></a>00048                 this-&gt;<a class="code" href="class_sync_thread.html#a5d627a46f2748963951890020902c81e">processChanges</a>(content);
<a name="l00049"></a>00049         }
<a name="l00050"></a>00050 }
<a name="l00051"></a><a class="code" href="class_sync_thread.html#ae054ac8c409f4fd81c473f3fcf5aa44c">00051</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#ae054ac8c409f4fd81c473f3fcf5aa44c">SyncThread::receivedFileDataPacket</a>(<a class="code" href="class_text_shredder_packet.html">TextShredderPacket</a> &amp;packet, quint16 destination)
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053         <span class="keywordflow">if</span> (sourceSyncThreadHandle == destination) {
<a name="l00054"></a>00054                 this-&gt;destinationSyncThreadHandle = <a class="code" href="class_file_data_packet.html#a7b0a80af65a8be68961bc61eeb3e40f2">FileDataPacket::getConnectionHandle</a>(packet);
<a name="l00055"></a>00055                 QByteArray fileData = <a class="code" href="class_file_data_packet.html#a3c2ff0442d42f365a25fe10c63d362aa">FileDataPacket::getFileDataContent</a>(packet);
<a name="l00056"></a>00056                 this-&gt;<a class="code" href="class_sync_thread.html#a07ecfc517a9536a5b4b3f71f91d7e940">receivedDownloadedContent</a>(fileData);
<a name="l00057"></a>00057         }
<a name="l00058"></a>00058 }
<a name="l00059"></a>00059 
<a name="l00060"></a><a class="code" href="class_sync_thread.html#a5d627a46f2748963951890020902c81e">00060</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#a5d627a46f2748963951890020902c81e">SyncThread::processChanges</a>(QByteArray &amp; content)
<a name="l00061"></a>00061 {
<a name="l00062"></a>00062         QString procesChangesMessage(<span class="stringliteral">&quot;SyncThread::processChanges&quot;</span>);
<a name="l00063"></a>00063         <a class="code" href="class_sync_thread.html#ae651d8e4d10f0ecc03da63980712aebd">logging</a>.<a class="code" href="class_text_shredder_logging.html#a2601dcb09435776bf37e633c56e40e63">writeLog</a> (procesChangesMessage, <a class="code" href="textshredderlogging_8h.html#af67907baa897e9fb84df0cb89795b87ca0593585da9181e972974c1274d8f2b4f">DEBUG</a>);
<a name="l00064"></a>00064         <a class="code" href="class_edit_list.html">EditList</a> incomingEditList(<span class="keyword">this</span>, content);
<a name="l00065"></a>00065         this-&gt;<a class="code" href="class_sync_thread.html#a15b6e123fe1c76643597836618256619">applyReceivedEditList</a>(incomingEditList);
<a name="l00066"></a>00066 }
<a name="l00067"></a><a class="code" href="class_sync_thread.html#a07ecfc517a9536a5b4b3f71f91d7e940">00067</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#a07ecfc517a9536a5b4b3f71f91d7e940">SyncThread::receivedDownloadedContent</a>(QByteArray &amp; content)
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069         qDebug(<span class="stringliteral">&quot;Received download content&quot;</span>);
<a name="l00070"></a>00070         QString string(content);
<a name="l00071"></a>00071         <a class="code" href="class_sync_thread.html#a73bbe84d7d531f2e6e728d5ade881270">workingCopyPointer</a>.data()-&gt;setContent(<span class="keywordtype">string</span>);
<a name="l00072"></a>00072         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_patchable.html#aa386892c91c1718cd5151ccc491e1bbf">setContent</a>(<span class="keywordtype">string</span>);
<a name="l00073"></a>00073         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#a5ed0b6e1f144468afca9129449a35fbc">getBackupCopy</a>()-&gt;<a class="code" href="class_patchable.html#aa386892c91c1718cd5151ccc491e1bbf">setContent</a>(<span class="keywordtype">string</span>);
<a name="l00074"></a>00074         <a class="code" href="class_sync_thread.html#a698ef3633b24d3529a6c17e5e3a99170">startSync</a>();
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="class_sync_thread.html#a94389440ca73f3f638c73ed9075dc0e0">00078</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#a94389440ca73f3f638c73ed9075dc0e0">SyncThread::pushChanges</a>()
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080         beforeLock();
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.lock();
<a name="l00083"></a>00083         <a class="code" href="class_sync_thread.html#a73bbe84d7d531f2e6e728d5ade881270">workingCopyPointer</a>.data()-&gt;lock();
<a name="l00084"></a>00084 
<a name="l00085"></a>00085         QString *workingCopyContent = <a class="code" href="class_sync_thread.html#a73bbe84d7d531f2e6e728d5ade881270">workingCopyPointer</a>.data()-&gt;getContent();
<a name="l00086"></a>00086         <span class="keywordtype">int</span> shadowLocalVersion = <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#a53ea25db19b20a6770e60d81a6b507f4">getLocalVersion</a>();
<a name="l00087"></a>00087 
<a name="l00088"></a>00088         QList&lt;Patch&gt; newPatches = <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_patchable.html#ab3016a99f60b10bae143365fb2cf1450">getPatchesToConvertString</a> (*workingCopyContent);
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         <span class="keywordflow">if</span>(newPatches.length() &gt; 0) {
<a name="l00091"></a>00091                 <a class="code" href="class_edit.html">Edit</a> e(<span class="keyword">this</span>, shadowLocalVersion, newPatches);
<a name="l00092"></a>00092                 <a class="code" href="class_sync_thread.html#ae3f0fa19b2a0f7ac9abd8ca6d794e616">editList</a>.<a class="code" href="class_edit_list.html#af1e561962340b1b24023052415ef8f94">addEdit</a>(e);
<a name="l00093"></a>00093                 QList&lt;Edit&gt; applyList;
<a name="l00094"></a>00094                 applyList.append(e);
<a name="l00095"></a>00095                 <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#a222d6d0835c4dea04c5f3d4a4ebf6e82">applyLocalEdits</a>(applyList);
<a name="l00096"></a>00096         }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098         <a class="code" href="class_sync_thread.html#ae2a92c2744e665d492f43130757453da">writePacketOfEditList</a>();
<a name="l00099"></a>00099         <a class="code" href="class_sync_thread.html#a73bbe84d7d531f2e6e728d5ade881270">workingCopyPointer</a>.data()-&gt;unlock();
<a name="l00100"></a>00100         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.unlock();
<a name="l00101"></a>00101 
<a name="l00102"></a>00102         afterLock();
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="class_sync_thread.html#ae2a92c2744e665d492f43130757453da">00105</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#ae2a92c2744e665d492f43130757453da">SyncThread::writePacketOfEditList</a>()
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107         <a class="code" href="class_sync_thread.html#ae3f0fa19b2a0f7ac9abd8ca6d794e616">editList</a>.lock();
<a name="l00108"></a>00108         <a class="code" href="class_text_shredder_packet.html">TextShredderPacket</a> *newPacket = <a class="code" href="class_sync_thread.html#ae3f0fa19b2a0f7ac9abd8ca6d794e616">editList</a>.<a class="code" href="class_edit_list.html#ace8dff1c04b64ed883808949b3b5c650">getAllocatedPacket</a>();
<a name="l00109"></a>00109         <a class="code" href="class_sync_thread.html#ae3f0fa19b2a0f7ac9abd8ca6d794e616">editList</a>.unlock();
<a name="l00110"></a>00110         <a class="code" href="class_sync_thread.html#a954c2e1a65ff3a473c3c7dc5350e0497">writePacketOnConnection</a>(*newPacket);
<a name="l00111"></a>00111         newPacket-&gt;deleteLater();
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="class_sync_thread.html#a954c2e1a65ff3a473c3c7dc5350e0497">00114</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#a954c2e1a65ff3a473c3c7dc5350e0497">SyncThread::writePacketOnConnection</a>(<a class="code" href="class_text_shredder_packet.html">TextShredderPacket</a> &amp;packet)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116         qDebug() &lt;&lt; <a class="code" href="class_sync_thread.html#a74e422ec07a67819e7151249e120ccee">connectionPointer</a>.isNull();
<a name="l00117"></a>00117         packet.<a class="code" href="class_text_shredder_packet.html#a01843c9ad788273caf58a93d01eb33d8">getHeader</a>().<a class="code" href="class_text_shredder_header.html#a2e4f22ee325b12ab1eab01e908eb4b73">setConnectionHandle</a>(destinationSyncThreadHandle);
<a name="l00118"></a>00118         <a class="code" href="class_sync_thread.html#a74e422ec07a67819e7151249e120ccee">connectionPointer</a>.data()-&gt;write(packet);
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="class_sync_thread.html#a15b6e123fe1c76643597836618256619">00121</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#a15b6e123fe1c76643597836618256619">SyncThread::applyReceivedEditList</a>(<a class="code" href="class_edit_list.html">EditList</a> &amp;incomingEditList)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123         QString editListMessage(<span class="stringliteral">&quot;+ Received EditList, based on version: &quot;</span>);
<a name="l00124"></a>00124         editListMessage += QString::number(incomingEditList.<a class="code" href="class_edit_list.html#a00c2180e295bcb80830f782c04d3e0ee">getRemoteVersion</a>());
<a name="l00125"></a>00125         <a class="code" href="class_sync_thread.html#ae651d8e4d10f0ecc03da63980712aebd">logging</a>.<a class="code" href="class_text_shredder_logging.html#a2601dcb09435776bf37e633c56e40e63">writeLog</a> (editListMessage, <a class="code" href="textshredderlogging_8h.html#af67907baa897e9fb84df0cb89795b87ca0593585da9181e972974c1274d8f2b4f">DEBUG</a>);
<a name="l00126"></a>00126         editListMessage = <span class="stringliteral">&quot;+ Received EditList contains &quot;</span>;
<a name="l00127"></a>00127         editListMessage += QString::number(incomingEditList.<a class="code" href="class_edit_list.html#a4527628441bec5a178f04dd9c5b1a433">getEdits</a>().size());
<a name="l00128"></a>00128         editListMessage += <span class="stringliteral">&quot; edit(s)&quot;</span>;
<a name="l00129"></a>00129         <a class="code" href="class_sync_thread.html#ae651d8e4d10f0ecc03da63980712aebd">logging</a>.<a class="code" href="class_text_shredder_logging.html#a2601dcb09435776bf37e633c56e40e63">writeLog</a>(editListMessage, <a class="code" href="textshredderlogging_8h.html#af67907baa897e9fb84df0cb89795b87ca0593585da9181e972974c1274d8f2b4f">DEBUG</a>);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.lock();
<a name="l00132"></a>00132         <a class="code" href="class_sync_thread.html#a73bbe84d7d531f2e6e728d5ade881270">workingCopyPointer</a>.data()-&gt;lock();
<a name="l00133"></a>00133         <a class="code" href="class_sync_thread.html#ae3f0fa19b2a0f7ac9abd8ca6d794e616">editList</a>.lock ();
<a name="l00134"></a>00134         <span class="keywordtype">int</span> currentLocalVersion = <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#a53ea25db19b20a6770e60d81a6b507f4">getLocalVersion</a> ();
<a name="l00135"></a>00135         <span class="keywordtype">int</span> basedVersionOfIncommingEditList = incomingEditList.<a class="code" href="class_edit_list.html#a00c2180e295bcb80830f782c04d3e0ee">getRemoteVersion</a>();
<a name="l00136"></a>00136 
<a name="l00137"></a>00137         <span class="keywordflow">if</span> (basedVersionOfIncommingEditList &lt; currentLocalVersion) {
<a name="l00138"></a>00138                 <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#aafdb5f83bfac6e782fee171272883a56">revert</a>();
<a name="l00139"></a>00139         }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         QList&lt;Edit&gt; ackedEdits = <a class="code" href="class_sync_thread.html#ae3f0fa19b2a0f7ac9abd8ca6d794e616">editList</a>.<a class="code" href="class_edit_list.html#ae67563b61f7b2e36d62636b2979232b3">popEditsUpToLocalVersion</a>(basedVersionOfIncommingEditList);
<a name="l00142"></a>00142         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#a53ea25db19b20a6770e60d81a6b507f4">getLocalVersion</a>() &lt; basedVersionOfIncommingEditList) {
<a name="l00143"></a>00143                 QString message(<span class="stringliteral">&quot;SyncT: sh.localversion &lt; incomming based version&quot;</span>);
<a name="l00144"></a>00144                 <a class="code" href="class_sync_thread.html#ae651d8e4d10f0ecc03da63980712aebd">logging</a>.<a class="code" href="class_text_shredder_logging.html#a2601dcb09435776bf37e633c56e40e63">writeLog</a>(message);
<a name="l00145"></a>00145                 <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#a222d6d0835c4dea04c5f3d4a4ebf6e82">applyLocalEdits</a>(ackedEdits);
<a name="l00146"></a>00146         }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         QList&lt;Edit&gt; receivedEdits = incomingEditList.<a class="code" href="class_edit_list.html#a4527628441bec5a178f04dd9c5b1a433">getEdits</a>();
<a name="l00149"></a>00149         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#a536db8c68e3b5cf89b30b609012fb13a">applyEdits</a>(receivedEdits);
<a name="l00150"></a>00150 
<a name="l00151"></a>00151         <span class="keywordtype">int</span> count = 0;
<a name="l00152"></a>00152         <span class="keywordflow">while</span> (count &lt; receivedEdits.count()) {
<a name="l00153"></a>00153                 <a class="code" href="class_edit.html">Edit</a> e = receivedEdits.at(count);
<a name="l00154"></a>00154                 <a class="code" href="class_sync_thread.html#a73bbe84d7d531f2e6e728d5ade881270">workingCopyPointer</a>.data()-&gt;applyPatches(e.<a class="code" href="class_edit.html#ae4989945109f8d569796b32cd7713969">getPatches</a>());
<a name="l00155"></a>00155                 count++;
<a name="l00156"></a>00156         }
<a name="l00157"></a>00157 
<a name="l00158"></a>00158         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#a7c6bfe84627fa3d8afd1b5a09fde6a0e">backup</a>();
<a name="l00159"></a>00159 
<a name="l00160"></a>00160         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#a222d6d0835c4dea04c5f3d4a4ebf6e82">applyLocalEdits</a>(<a class="code" href="class_sync_thread.html#ae3f0fa19b2a0f7ac9abd8ca6d794e616">editList</a>.<a class="code" href="class_edit_list.html#a4527628441bec5a178f04dd9c5b1a433">getEdits</a>());
<a name="l00161"></a>00161 
<a name="l00162"></a>00162         <a class="code" href="class_sync_thread.html#ae3f0fa19b2a0f7ac9abd8ca6d794e616">editList</a>.<a class="code" href="class_edit_list.html#a8e7b3099b3ce693e01b1321b723ec65f">updateToRemote</a>(<a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.<a class="code" href="class_shadow_copy.html#a4bfafd0823dbc2788c936608ec22ea54">getRemoteVersion</a>());
<a name="l00163"></a>00163         <a class="code" href="class_sync_thread.html#ae3f0fa19b2a0f7ac9abd8ca6d794e616">editList</a>.unlock ();
<a name="l00164"></a>00164         <a class="code" href="class_sync_thread.html#a73bbe84d7d531f2e6e728d5ade881270">workingCopyPointer</a>.data()-&gt;unlock();
<a name="l00165"></a>00165         <a class="code" href="class_sync_thread.html#aa625d32e516a85a0c56fc2231ecc2916">shadowCopy</a>.unlock ();
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a><a class="code" href="class_sync_thread.html#aa5a7831fb7423397c060c07bffe54fd0">00168</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#aa5a7831fb7423397c060c07bffe54fd0">SyncThread::receivedEndSynchronizationPacket</a>(quint16 destination) {
<a name="l00169"></a>00169         <span class="keywordflow">if</span>      (destination == sourceSyncThreadHandle) {
<a name="l00170"></a>00170                 breakDownSynchronization();
<a name="l00171"></a>00171                 emit <a class="code" href="class_sync_thread.html#a3fdb7012eaab57fa279053e053089571">syncThreadStoppedByOtherNode</a>();
<a name="l00172"></a>00172                 qDebug(<span class="stringliteral">&quot;TODO: SyncThread::receivedEndSynchronizationPacket -&gt; Emit sync stopped &quot;</span>);
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a><a class="code" href="class_sync_thread.html#a6479eed6d3f611deb5986030427f91eb">00176</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#a6479eed6d3f611deb5986030427f91eb">SyncThread::stopSync</a>()
<a name="l00177"></a>00177 {
<a name="l00178"></a>00178         breakDownSynchronization();
<a name="l00179"></a>00179         <a class="code" href="class_end_synchronization_packet.html">EndSynchronizationPacket</a> packet(<span class="keyword">this</span>, destinationSyncThreadHandle);
<a name="l00180"></a>00180         <a class="code" href="class_sync_thread.html#a954c2e1a65ff3a473c3c7dc5350e0497">writePacketOnConnection</a>(packet);
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <span class="keywordtype">void</span> SyncThread::breakDownSynchronization()
<a name="l00184"></a>00184 {
<a name="l00185"></a>00185         <a class="code" href="class_sync_thread.html#ac244e02c977cb8f5614bb2ff19ff1804">timer</a>.stop();
<a name="l00186"></a>00186         disconnectSignalsForSynchronization();
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="class_sync_thread.html#af7f1764ea4b24f2c1cc2dbfc2eb5c8e7">00189</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#af7f1764ea4b24f2c1cc2dbfc2eb5c8e7">SyncThread::setDestinationHandle</a>(quint16 destination)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191         destinationSyncThreadHandle = destination;
<a name="l00192"></a>00192 }
<a name="l00193"></a>00193 
<a name="l00194"></a><a class="code" href="class_sync_thread.html#a4572c02a85d3a71d4a43e0e8eb6cb3f7">00194</a> quint16 <a class="code" href="class_sync_thread.html#a4572c02a85d3a71d4a43e0e8eb6cb3f7">SyncThread::getDestinationHandle</a>()
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196         <span class="keywordflow">return</span> destinationSyncThreadHandle;
<a name="l00197"></a>00197 }
<a name="l00198"></a>00198 
<a name="l00199"></a><a class="code" href="class_sync_thread.html#a0e61dc4f301a5c8b415604e372e5e0f5">00199</a> quint16 <a class="code" href="class_sync_thread.html#a0e61dc4f301a5c8b415604e372e5e0f5">SyncThread::getSourceHandle</a>()
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201         <span class="keywordflow">return</span> sourceSyncThreadHandle;
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a><a class="code" href="class_sync_thread.html#a50f1506b24f64af4cc99db115298c2b2">00204</a> <span class="keywordtype">void</span> <a class="code" href="class_sync_thread.html#a50f1506b24f64af4cc99db115298c2b2">SyncThread::sendFileDataAndStart</a>()
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206         QByteArray bytes;
<a name="l00207"></a>00207         bytes.append(*<a class="code" href="class_sync_thread.html#a73bbe84d7d531f2e6e728d5ade881270">workingCopyPointer</a>.data()-&gt;getContent());
<a name="l00208"></a>00208         qDebug() &lt;&lt; <span class="stringliteral">&quot;before&quot;</span> &lt;&lt; destinationSyncThreadHandle;
<a name="l00209"></a>00209         <span class="comment">//TextShredderPacket packet(this, kPacketTypeFileData, bytes, destinationSyncThreadHandle);</span>
<a name="l00210"></a>00210         <a class="code" href="class_file_data_packet.html">FileDataPacket</a> packet(<span class="keyword">this</span>, bytes, sourceSyncThreadHandle);
<a name="l00211"></a>00211         packet.<a class="code" href="class_text_shredder_packet.html#a01843c9ad788273caf58a93d01eb33d8">getHeader</a>().<a class="code" href="class_text_shredder_header.html#a2e4f22ee325b12ab1eab01e908eb4b73">setConnectionHandle</a>(destinationSyncThreadHandle);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         qDebug(<span class="stringliteral">&quot;writePacketOnConnection(packet) - start&quot;</span>);
<a name="l00214"></a>00214         qDebug() &lt;&lt; packet.<a class="code" href="class_text_shredder_packet.html#a01843c9ad788273caf58a93d01eb33d8">getHeader</a>().<a class="code" href="class_text_shredder_header.html#a9b2b89e987bd2836e367def221982ba4">getConnectionHandle</a>();
<a name="l00215"></a>00215         <a class="code" href="class_sync_thread.html#a954c2e1a65ff3a473c3c7dc5350e0497">writePacketOnConnection</a>(packet);
<a name="l00216"></a>00216         qDebug(<span class="stringliteral">&quot;writePacketOnConnection(packet) - done&quot;</span>);
<a name="l00217"></a>00217         <a class="code" href="class_sync_thread.html#a698ef3633b24d3529a6c17e5e3a99170">startSync</a>();
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="keywordtype">void</span> SyncThread::connectSignalsForSynchronization()
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222         qDebug(<span class="stringliteral">&quot;SyncThread::connectSignalsForSynchronization&quot;</span>);
<a name="l00223"></a>00223         connect(<a class="code" href="class_sync_thread.html#a74e422ec07a67819e7151249e120ccee">connectionPointer</a>.data(), SIGNAL(incomingEditPacketContent(QByteArray&amp;, quint16)), <span class="keyword">this</span>, SLOT(<a class="code" href="class_sync_thread.html#a6942467b2594dac2cca3fb6844676548">receivedEditPacketContent</a>(QByteArray&amp;, quint16)));
<a name="l00224"></a>00224         connect(<a class="code" href="class_sync_thread.html#a74e422ec07a67819e7151249e120ccee">connectionPointer</a>.data(), SIGNAL(incomingFileDataPacket(<a class="code" href="class_text_shredder_packet.html">TextShredderPacket</a>&amp;, quint16)), <span class="keyword">this</span>, SLOT(<a class="code" href="class_sync_thread.html#ae054ac8c409f4fd81c473f3fcf5aa44c">receivedFileDataPacket</a>(<a class="code" href="class_text_shredder_packet.html">TextShredderPacket</a> &amp;, quint16)));
<a name="l00225"></a>00225         connect(<a class="code" href="class_sync_thread.html#a74e422ec07a67819e7151249e120ccee">connectionPointer</a>.data(), SIGNAL(incomingEndSynchronizationPacket(quint16)), <span class="keyword">this</span>, SLOT(<a class="code" href="class_sync_thread.html#aa5a7831fb7423397c060c07bffe54fd0">receivedEndSynchronizationPacket</a>(quint16)));
<a name="l00226"></a>00226         connect(&amp;<a class="code" href="class_sync_thread.html#ac244e02c977cb8f5614bb2ff19ff1804">timer</a>, SIGNAL(timeout()), <span class="keyword">this</span>, SLOT(<a class="code" href="class_sync_thread.html#a94389440ca73f3f638c73ed9075dc0e0">pushChanges</a>()));
<a name="l00227"></a>00227         connect(<span class="keyword">this</span>, SIGNAL(addToAverageLockTime(uint)), <a class="code" href="class_performance_calculator.html#aaf82a436cf8c8971b927b2a62348a462">PerformanceCalculator::Instance</a>(), SLOT(addNewLockTime(uint)));
<a name="l00228"></a>00228 }
<a name="l00229"></a>00229 <span class="keywordtype">void</span> SyncThread::disconnectSignalsForSynchronization()
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231         qDebug(<span class="stringliteral">&quot;SyncThread::disconnectSignalsForSynchronization&quot;</span>);
<a name="l00232"></a>00232         disconnect(<a class="code" href="class_sync_thread.html#a74e422ec07a67819e7151249e120ccee">connectionPointer</a>.data(), SIGNAL(incomingEditPacketContent(QByteArray&amp;, quint16)), <span class="keyword">this</span>, SLOT(<a class="code" href="class_sync_thread.html#a6942467b2594dac2cca3fb6844676548">receivedEditPacketContent</a>(QByteArray&amp;, quint16)));
<a name="l00233"></a>00233         disconnect(<a class="code" href="class_sync_thread.html#a74e422ec07a67819e7151249e120ccee">connectionPointer</a>.data(), SIGNAL(incomingFileDataPacket(<a class="code" href="class_text_shredder_packet.html">TextShredderPacket</a>&amp;, quint16)), <span class="keyword">this</span>, SLOT(<a class="code" href="class_sync_thread.html#ae054ac8c409f4fd81c473f3fcf5aa44c">receivedFileDataPacket</a>(<a class="code" href="class_text_shredder_packet.html">TextShredderPacket</a> &amp;, quint16)));
<a name="l00234"></a>00234         disconnect(<a class="code" href="class_sync_thread.html#a74e422ec07a67819e7151249e120ccee">connectionPointer</a>.data(), SIGNAL(incomingEndSynchronizationPacket(quint16)), <span class="keyword">this</span>, SLOT(<a class="code" href="class_sync_thread.html#aa5a7831fb7423397c060c07bffe54fd0">receivedEndSynchronizationPacket</a>(quint16)));
<a name="l00235"></a>00235         disconnect(&amp;<a class="code" href="class_sync_thread.html#ac244e02c977cb8f5614bb2ff19ff1804">timer</a>, SIGNAL(timeout()), <span class="keyword">this</span>, SLOT(<a class="code" href="class_sync_thread.html#a94389440ca73f3f638c73ed9075dc0e0">pushChanges</a>()));
<a name="l00236"></a>00236 }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 <span class="keywordtype">void</span> SyncThread::beforeLock()
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240         <span class="keywordflow">if</span>(performanceTime.isNull()) {
<a name="l00241"></a>00241                 performanceTime.start();
<a name="l00242"></a>00242         } <span class="keywordflow">else</span> {
<a name="l00243"></a>00243                 performanceTime.restart();
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 <span class="keywordtype">void</span> SyncThread::afterLock()
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> milliseconds = performanceTime.elapsed();
<a name="l00250"></a>00250         qDebug() &lt;&lt; <span class="stringliteral">&quot;last lock time: &quot;</span> &lt;&lt; milliseconds;
<a name="l00251"></a>00251         emit addToAverageLockTime(milliseconds);
<a name="l00252"></a>00252 }
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Wed May 25 2011 for Textshredder core by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
